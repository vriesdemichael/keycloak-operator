name: Deploy to GitHub Pages

# Deploy versioned documentation and Helm charts to GitHub Pages
# - Documentation built with MkDocs + mike for versioning (served at root)
# - Helm charts packaged and indexed with version history (served at /charts)
#
# Versioning Strategy:
# - Documentation versions follow operator chart releases (chart-operator-v0.1.x)
# - Operator chart releases: Create new versioned docs (v0.1.4) and set as latest
# - Realm/Client chart releases: Update latest docs in-place (no new version)
# - Operator image releases: Skip docs (chart release will handle versioning)
# - Main branch pushes: Update 'dev' documentation only
# - All chart versions are preserved in the Helm repository

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - 'charts/**'
      - 'scripts/generate-crd-schemas.py'
      - '.github/workflows/pages.yml'
  release:
    types: [published]
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    name: Build Documentation and Helm Charts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history for git info and version detection

      - name: Configure Git for mike
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Checkout gh-pages branch (preserve existing content)
        run: |
          # Fetch gh-pages branch to preserve existing versions
          git fetch origin gh-pages --depth=1 || echo "No gh-pages branch yet"

          # Check out gh-pages branch
          if git rev-parse --verify origin/gh-pages >/dev/null 2>&1; then
            echo "Checking out existing gh-pages branch..."
            git checkout gh-pages
          else
            echo "Creating new orphan gh-pages branch..."
            git checkout --orphan gh-pages
            git rm -rf . 2>/dev/null || true
          fi

          # Return to main branch but keep gh-pages in history
          git checkout main

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          python-version: '3.13'

      - name: Install Python dependencies
        run: uv sync --frozen --group docs

      - name: Determine documentation version
        id: doc-version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            # On release, use the release tag
            VERSION="${GITHUB_REF#refs/tags/}"

            # Operator chart releases drive documentation versioning
            if [[ "$VERSION" =~ ^chart-operator-v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
              # Operator chart release - create new versioned docs
              CHART_VERSION="${BASH_REMATCH[1]}"
              DOC_VERSION="v$CHART_VERSION"
              IS_LATEST="true"
              SKIP_DOCS="false"
              echo "Operator chart release detected: Creating documentation version $DOC_VERSION"

            elif [[ "$VERSION" =~ ^chart-(realm|client)-v ]]; then
              # Realm/Client chart release - update latest docs in-place
              DOC_VERSION="latest"
              IS_LATEST="true"
              SKIP_DOCS="false"
              echo "Realm/Client chart release detected: Updating latest documentation"

            elif [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              # Operator image release - skip docs (chart release will handle it)
              DOC_VERSION=""
              IS_LATEST="false"
              SKIP_DOCS="true"
              echo "Operator image release detected: Skipping docs (operator chart release will create versioned docs)"

            else
              # Unknown release format, update dev as fallback
              DOC_VERSION="dev"
              IS_LATEST="false"
              SKIP_DOCS="false"
              echo "Unknown release format: Updating dev documentation"
            fi
          else
            # On main branch push, update 'dev' version
            DOC_VERSION="dev"
            IS_LATEST="false"
            SKIP_DOCS="false"
            echo "Main branch push: Updating dev documentation"
          fi

          echo "version=$DOC_VERSION" >> $GITHUB_OUTPUT
          echo "is_latest=$IS_LATEST" >> $GITHUB_OUTPUT
          echo "skip_docs=$SKIP_DOCS" >> $GITHUB_OUTPUT

      - name: Build versioned documentation with mike
        if: steps.doc-version.outputs.skip_docs != 'true'
        run: |
          VERSION="${{ steps.doc-version.outputs.version }}"
          IS_LATEST="${{ steps.doc-version.outputs.is_latest }}"

          if [[ -z "$VERSION" ]]; then
            echo "No documentation version specified, skipping docs build"
            exit 0
          fi

          echo "Building documentation version: $VERSION (is_latest=$IS_LATEST)"

          # Deploy documentation version with mike (NO --push, we'll push at the end)
          if [[ "$IS_LATEST" == "true" ]]; then
            if [[ "$VERSION" == "latest" ]]; then
              # Update latest in-place (realm/client chart releases)
              uv run --group docs mike deploy --update-aliases latest
              echo "Updated latest documentation in-place"
            else
              # Deploy as new version and set as latest (operator chart releases)
              uv run --group docs mike deploy --update-aliases "$VERSION" latest
              uv run --group docs mike set-default latest
              echo "Created new version $VERSION and set as latest"
            fi
          else
            # Deploy/update without changing latest (dev updates)
            uv run --group docs mike deploy --update-aliases "$VERSION"
            echo "Updated version $VERSION"
          fi

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.16.2'

      - name: Package and merge Helm charts
        run: |
          # Switch to gh-pages branch
          git checkout gh-pages

          CHARTS_DIR="charts"
          TEMP_DIR="/tmp/new-charts"

          # Ensure charts directory exists
          mkdir -p "$CHARTS_DIR"
          mkdir -p "$TEMP_DIR"

          # Switch back to main to access chart sources
          git checkout main

          # Package each chart in the charts directory
          for chart_dir in charts/*/; do
            if [ -f "${chart_dir}Chart.yaml" ]; then
              chart_name=$(basename "$chart_dir")
              echo "Packaging chart: ${chart_name}"
              helm package "${chart_dir}" --destination "$TEMP_DIR"
            fi
          done

          # Switch back to gh-pages
          git checkout gh-pages

          # Copy new chart packages to gh-pages charts directory
          # This preserves existing charts and adds new versions
          if ls "$TEMP_DIR"/*.tgz 1> /dev/null 2>&1; then
            cp "$TEMP_DIR"/*.tgz "$CHARTS_DIR/"
            echo "Added new charts to repository"
          else
            echo "No new charts to add"
          fi

          # Regenerate index.yaml with ALL charts (old + new)
          helm repo index "$CHARTS_DIR" --url https://vriesdemichael.github.io/keycloak-operator/charts

          echo "Chart repository contents:"
          ls -lh "$CHARTS_DIR"

      - name: Generate and add JSON schemas
        run: |
          # Generate schemas on main branch
          git checkout main
          uv run python scripts/generate-crd-schemas.py

          # Switch to gh-pages and add schemas
          git checkout gh-pages
          mkdir -p schemas
          cp -r _schemas/* schemas/

      - name: Commit and push all changes to gh-pages
        run: |
          # Ensure we're on gh-pages branch
          git checkout gh-pages

          git add -A

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update documentation and charts from ${{ github.sha }}"
            git push origin gh-pages
            echo "Successfully pushed documentation and charts to gh-pages"
          fi

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v4
        with:
          path: .

  deploy:
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Summary
        run: |
          echo "### :rocket: Deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Documentation:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Helm Repository:** ${{ steps.deployment.outputs.page_url }}charts/" >> $GITHUB_STEP_SUMMARY
          echo "**JSON Schemas:** ${{ steps.deployment.outputs.page_url }}schemas/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version Selector:** Use the version dropdown in the documentation header to view older versions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Add Helm repository:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "helm repo add keycloak-operator ${{ steps.deployment.outputs.page_url }}charts" >> $GITHUB_STEP_SUMMARY
          echo "helm repo update" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Install specific chart version:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "helm search repo keycloak-operator --versions" >> $GITHUB_STEP_SUMMARY
          echo "helm install my-keycloak keycloak-operator/keycloak-operator --version 0.1.4" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
