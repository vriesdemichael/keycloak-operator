name: Deploy Release to GitHub Pages (DISABLED - Using ci-cd-unified.yml)

# DISABLED: Functionality moved to ci-cd-unified.yml
# This workflow is kept for reference but will not run automatically
# Remove this file once ci-cd-unified.yml is proven stable

on:
  workflow_dispatch:
    inputs:
      version_override:
        description: 'Override version (e.g., v0.1.4 or dev)'
        required: false

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    name: Build Documentation and Helm Charts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Configure Git for mike
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch gh-pages for mike version history
        run: |
          git fetch origin gh-pages --depth=1 || echo "No gh-pages branch yet"
          if git rev-parse --verify origin/gh-pages >/dev/null 2>&1; then
            git checkout gh-pages
            git checkout -
          fi

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          python-version: '3.13'

      - name: Install Python dependencies
        run: uv sync --frozen --group docs

      - name: Determine documentation version
        id: doc-version
        run: |
          if [[ -n "${{ github.event.inputs.version_override }}" ]]; then
            DOC_VERSION="${{ github.event.inputs.version_override }}"
            IS_LATEST="false"
            SKIP_DOCS="false"
            echo "Manual override: $DOC_VERSION"
          elif [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"

            if [[ "$VERSION" =~ ^chart-operator-v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
              # Operator chart release - create new versioned docs
              CHART_VERSION="${BASH_REMATCH[1]}"
              DOC_VERSION="v$CHART_VERSION"
              IS_LATEST="true"
              SKIP_DOCS="false"
              echo "Operator chart release: Creating version $DOC_VERSION"
            elif [[ "$VERSION" =~ ^chart-(realm|client)-v ]]; then
              # Realm/Client chart release - update latest docs in-place
              DOC_VERSION="latest"
              IS_LATEST="true"
              SKIP_DOCS="false"
              echo "Realm/Client chart release: Updating latest"
            elif [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              # Operator image release - skip docs
              DOC_VERSION=""
              IS_LATEST="false"
              SKIP_DOCS="true"
              echo "Operator image release: Skipping docs"
            else
              DOC_VERSION=""
              IS_LATEST="false"
              SKIP_DOCS="true"
              echo "Unknown release format: Skipping docs"
            fi
          else
            DOC_VERSION=""
            IS_LATEST="false"
            SKIP_DOCS="true"
          fi

          echo "version=$DOC_VERSION" >> $GITHUB_OUTPUT
          echo "is_latest=$IS_LATEST" >> $GITHUB_OUTPUT
          echo "skip_docs=$SKIP_DOCS" >> $GITHUB_OUTPUT

      - name: Build ADR documentation
        if: steps.doc-version.outputs.skip_docs != 'true'
        run: bash scripts/build-adr-docs.sh

      - name: Generate CRD JSON schemas
        if: steps.doc-version.outputs.skip_docs != 'true'
        run: uv run python scripts/generate-crd-schemas.py

      - name: Build versioned documentation with mike
        if: steps.doc-version.outputs.skip_docs != 'true'
        run: |
          VERSION="${{ steps.doc-version.outputs.version }}"
          IS_LATEST="${{ steps.doc-version.outputs.is_latest }}"

          if [[ "$IS_LATEST" == "true" ]]; then
            echo "Building version $VERSION and setting as latest..."
            uv run --group docs mike deploy --update-aliases "$VERSION" latest

            # Set as default if no default exists
            if ! uv run --group docs mike list | grep -q "\\[default\\]"; then
              uv run --group docs mike set-default "$VERSION"
              echo "Set $VERSION as default"
            fi
          else
            echo "Building version $VERSION..."
            uv run --group docs mike deploy "$VERSION"
          fi

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.16.2'

      - name: Prepare deployment directory
        run: |
          DEPLOY_DIR="/tmp/gh-pages-deploy"
          mkdir -p "$DEPLOY_DIR"

          # Copy mike-generated docs from gh-pages branch
          if git rev-parse --verify origin/gh-pages >/dev/null 2>&1; then
            git checkout gh-pages

            # Copy all documentation content
            for item in */; do
              if [[ "$item" != "charts/" ]] && [[ "$item" != "schemas/" ]]; then
                cp -r "$item" "$DEPLOY_DIR/"
              fi
            done

            # Copy root files
            cp -f versions.json index.html .nojekyll "$DEPLOY_DIR/" 2>/dev/null || true

            git checkout -
          fi

      - name: Package and add Helm charts
        run: |
          DEPLOY_DIR="/tmp/gh-pages-deploy"
          TEMP_CHARTS="/tmp/new-charts"
          mkdir -p "$TEMP_CHARTS" "$DEPLOY_DIR/charts"

          # Package each chart
          for chart_dir in charts/*/; do
            if [ -f "${chart_dir}Chart.yaml" ]; then
              chart_name=$(basename "$chart_dir")
              echo "Packaging chart: ${chart_name}"
              helm package "${chart_dir}" --destination "$TEMP_CHARTS"
            fi
          done

          # If gh-pages exists, fetch existing charts
          if git rev-parse --verify origin/gh-pages >/dev/null 2>&1; then
            git checkout gh-pages
            if [ -d "charts" ]; then
              cp charts/*.tgz "$DEPLOY_DIR/charts/" 2>/dev/null || true
            fi
            git checkout -
          fi

          # Add new chart packages (preserves existing)
          if ls "$TEMP_CHARTS"/*.tgz 1> /dev/null 2>&1; then
            cp "$TEMP_CHARTS"/*.tgz "$DEPLOY_DIR/charts/"
            echo "Added new charts to repository"
          fi

          # Regenerate index with all charts
          helm repo index "$DEPLOY_DIR/charts" --url https://vriesdemichael.github.io/keycloak-operator/charts

          echo "Chart repository contents:"
          ls -lh "$DEPLOY_DIR/charts"

      - name: Add JSON schemas
        if: steps.doc-version.outputs.skip_docs != 'true'
        run: |
          DEPLOY_DIR="/tmp/gh-pages-deploy"
          mkdir -p "$DEPLOY_DIR/schemas"

          if [ -d "_schemas" ]; then
            cp -r _schemas/* "$DEPLOY_DIR/schemas/"
            echo "Added JSON schemas"
          fi

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v4
        with:
          path: /tmp/gh-pages-deploy

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Summary
        run: |
          echo "### :rocket: Deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Documentation:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Helm Repository:** ${{ steps.deployment.outputs.page_url }}charts/" >> $GITHUB_STEP_SUMMARY
          echo "**JSON Schemas:** ${{ steps.deployment.outputs.page_url }}schemas/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Add Helm repository:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "helm repo add keycloak-operator ${{ steps.deployment.outputs.page_url }}charts" >> $GITHUB_STEP_SUMMARY
          echo "helm repo update" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
