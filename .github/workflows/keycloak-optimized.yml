name: Build Optimized Keycloak

on:
  workflow_dispatch:
    inputs:
      keycloak_version:
        description: 'Keycloak version to build (e.g., 26.5.2)'
        required: true
        type: string
      tracing:
        description: 'Enable OpenTelemetry tracing support (build-time)'
        required: false
        type: boolean
        default: false
  push:
    paths:
      - 'images/keycloak-optimized/**'
      - '.github/workflows/keycloak-optimized.yml'
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-publish:
    name: Build and Publish Optimized Keycloak
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      packages: write
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Determine build parameters
        id: params
        run: |
          # Determine Keycloak version
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.keycloak_version }}"
            TRACING="${{ inputs.tracing }}"
          else
            # Push trigger: extract version from Dockerfile, no tracing
            VERSION=$(grep -oP 'ARG KEYCLOAK_VERSION=\K[0-9.]+' images/keycloak-optimized/Dockerfile || echo "26.5.2")
            TRACING="false"
          fi

          # Determine image variant name and tag suffix
          if [[ "${TRACING}" == "true" ]]; then
            IMAGE_VARIANT="keycloak-optimized-tracing"
          else
            IMAGE_VARIANT="keycloak-optimized"
          fi

          echo "keycloak_version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tracing=${TRACING}" >> $GITHUB_OUTPUT
          echo "image_variant=${IMAGE_VARIANT}" >> $GITHUB_OUTPUT
          echo "Building ${IMAGE_VARIANT} image for Keycloak ${VERSION} (tracing=${TRACING})"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if image already exists
        id: check
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ steps.params.outputs.image_variant }}:${{ steps.params.outputs.keycloak_version }}"
          if docker manifest inspect ${IMAGE} >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Image already exists: ${IMAGE}"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Image does not exist, will build: ${IMAGE}"
          fi

      - name: Determine image tags
        id: tags
        if: steps.check.outputs.exists == 'false'
        run: |
          VARIANT="${{ steps.params.outputs.image_variant }}"
          VERSION="${{ steps.params.outputs.keycloak_version }}"
          BASE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${VARIANT}"

          # Tracing images only get a version tag; non-tracing also gets :latest
          if [[ "${{ steps.params.outputs.tracing }}" == "true" ]]; then
            TAGS="${BASE}:${VERSION}"
          else
            TAGS=$(printf '%s\n%s' "${BASE}:${VERSION}" "${BASE}:latest")
          fi
          # Use EOF delimiter to preserve newlines
          {
            echo "tags<<TAGSEOF"
            echo "${TAGS}"
            echo "TAGSEOF"
          } >> $GITHUB_OUTPUT

      - name: Build and push optimized Keycloak image
        if: steps.check.outputs.exists == 'false'
        uses: docker/build-push-action@v6
        with:
          context: images/keycloak-optimized
          file: images/keycloak-optimized/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          labels: |
            org.opencontainers.image.title=Keycloak Optimized
            org.opencontainers.image.description=Pre-optimized Keycloak image for faster startup
            org.opencontainers.image.version=${{ steps.params.outputs.keycloak_version }}
            org.opencontainers.image.vendor=MichaÃ«l de Vries
            org.opencontainers.image.licenses=Apache-2.0
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.base.name=quay.io/keycloak/keycloak:${{ steps.params.outputs.keycloak_version }}
          cache-from: type=gha,scope=${{ steps.params.outputs.image_variant }}
          cache-to: type=gha,mode=max,scope=${{ steps.params.outputs.image_variant }}
          build-args: |
            KEYCLOAK_VERSION=${{ steps.params.outputs.keycloak_version }}
            TRACING_ENABLED=${{ steps.params.outputs.tracing }}

      - name: Scan optimized Keycloak image with Trivy
        if: steps.check.outputs.exists == 'false'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ steps.params.outputs.image_variant }}:${{ steps.params.outputs.keycloak_version }}
          format: 'sarif'
          output: 'trivy-keycloak-optimized.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        if: steps.check.outputs.exists == 'false'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-keycloak-optimized.sarif'
          category: 'trivy-${{ steps.params.outputs.image_variant }}'

      - name: Summary
        run: |
          VARIANT="${{ steps.params.outputs.image_variant }}"
          VERSION="${{ steps.params.outputs.keycloak_version }}"
          if [[ "${{ steps.check.outputs.exists }}" == "true" ]]; then
            echo "### Optimized Keycloak Image Already Exists" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Image:** \`${{ env.IMAGE_NAME }}/${VARIANT}:${VERSION}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No build was performed as the image already exists in the registry." >> $GITHUB_STEP_SUMMARY
          else
            echo "### Optimized Keycloak Image Published" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Registry:** \`${{ env.REGISTRY }}\`" >> $GITHUB_STEP_SUMMARY
            echo "**Image:** \`${{ env.IMAGE_NAME }}/${VARIANT}:${VERSION}\`" >> $GITHUB_STEP_SUMMARY
            echo "**Tracing:** ${{ steps.params.outputs.tracing }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The optimized Keycloak image has been built, scanned, and published to the container registry." >> $GITHUB_STEP_SUMMARY
          fi
