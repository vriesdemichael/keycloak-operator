name: Deploy Dev Docs to GitHub Pages

# Updates 'dev' documentation only - for testing and development
# Triggered manually only

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - 'scripts/build-adr-docs.sh'
      - 'scripts/generate-crd-schemas.py'
      - 'src/domain/models.py'
      - '.github/workflows/pages-dev.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages-dev"
  cancel-in-progress: false

jobs:
  build:
    name: Build Dev Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Configure Git for mike
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch gh-pages for mike version history
        run: |
          git fetch origin gh-pages --depth=1 || echo "No gh-pages branch yet"
          if git rev-parse --verify origin/gh-pages >/dev/null 2>&1; then
            git checkout gh-pages
            git checkout -
          fi

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          python-version: '3.13'

      - name: Install Python dependencies
        run: uv sync --frozen --group docs

      - name: Build ADR documentation
        run: bash scripts/build-adr-docs.sh

      - name: Generate CRD JSON schemas
        run: uv run python scripts/generate-crd-schemas.py

      - name: Build dev documentation with mike
        run: |
          echo "Building dev documentation..."
          uv run --group docs mike deploy dev

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.16.2'

      - name: Prepare deployment directory
        run: |
          DEPLOY_DIR="/tmp/gh-pages-deploy"
          mkdir -p "$DEPLOY_DIR"

          # Copy mike-generated docs from gh-pages branch
          if git rev-parse --verify origin/gh-pages >/dev/null 2>&1; then
            git checkout gh-pages

            # Copy all documentation content
            for item in */; do
              if [[ "$item" != "charts/" ]] && [[ "$item" != "schemas/" ]]; then
                cp -r "$item" "$DEPLOY_DIR/"
              fi
            done

            # Copy root files
            cp -f versions.json index.html .nojekyll "$DEPLOY_DIR/" 2>/dev/null || true

            # Copy existing charts and schemas (preserve releases)
            if [ -d "charts" ]; then
              cp -r charts "$DEPLOY_DIR/"
            fi
            if [ -d "schemas" ]; then
              cp -r schemas "$DEPLOY_DIR/"
            fi

            git checkout -
          fi

      - name: Update dev schemas only
        run: |
          DEPLOY_DIR="/tmp/gh-pages-deploy"
          mkdir -p "$DEPLOY_DIR/schemas/dev"

          if [ -d "_schemas/latest" ]; then
            cp -r _schemas/latest/* "$DEPLOY_DIR/schemas/dev/"
            echo "Updated dev JSON schemas"
          fi

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v4
        with:
          path: /tmp/gh-pages-deploy

  deploy:
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Summary
        run: |
          echo "### :rocket: Updated dev documentation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Dev Docs:** ${{ steps.deployment.outputs.page_url }}dev/" >> $GITHUB_STEP_SUMMARY
