name: Rebase Conflicted Release PRs

# When a release PR merges, other pending release PRs may have manifest conflicts.
# This workflow automatically rebases and resolves predictable conflicts
# (e.g., version manifest conflicts where we take the higher version).

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  rebase-conflicted:
    name: Rebase Conflicted Release PRs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Check for conflicted release PRs
        id: check-conflicts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for conflicted release PRs..."

          # GitHub's mergeable status can be null while being computed.
          # Retry a few times with a short delay to allow computation to complete.
          PENDING_PRS=""
          for attempt in 1 2 3; do
            echo "Attempt $attempt: Fetching release PR status..."

            RESPONSE=$(gh pr list \
              --repo ${{ github.repository }} \
              --label "autorelease: pending" \
              --json number,title,mergeable,headRefName)

            # Find PRs with CONFLICTING status
            PENDING_PRS=$(echo "$RESPONSE" | jq -r '.[] | select(.mergeable == "CONFLICTING") | .number')

            # Check if any PRs still have null mergeable status
            NULL_COUNT=$(echo "$RESPONSE" | jq '[.[] | select(.mergeable == null)] | length')

            if [[ "$NULL_COUNT" -eq 0 ]]; then
              echo "All PRs have computed mergeable status."
              break
            fi

            if [[ "$attempt" -lt 3 ]]; then
              echo "$NULL_COUNT PR(s) still computing mergeable status, waiting..."
              sleep 10
            fi
          done

          if [[ -z "$PENDING_PRS" ]]; then
            echo "No conflicted release PRs found."
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found conflicted release PRs: $PENDING_PRS"
          echo "has_conflicts=true" >> $GITHUB_OUTPUT
          echo "prs=$PENDING_PRS" >> $GITHUB_OUTPUT

      - name: Configure git
        if: steps.check-conflicts.outputs.has_conflicts == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Rebase and resolve conflicts
        if: steps.check-conflicts.outputs.has_conflicts == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RESOLVED_PRS=""
          FAILED_PRS=""

          # Read space-separated PR numbers into array
          read -r -a prs_array <<< "${{ steps.check-conflicts.outputs.prs }}"

          for pr in "${prs_array[@]}"; do
            echo "Processing PR #$pr..."

            # Checkout the PR branch
            gh pr checkout "$pr"

            # Attempt rebase
            if git rebase origin/main; then
              echo "âœ… PR #$pr rebased without conflicts"
              if git push --force-with-lease; then
                RESOLVED_PRS="$RESOLVED_PRS $pr"
              else
                echo "âŒ PR #$pr push failed"
                FAILED_PRS="$FAILED_PRS $pr"
              fi
              git checkout -f main
              continue
            fi

            echo "Rebase has conflicts, attempting resolution..."

            # Check which files have conflicts
            CONFLICTED_FILES=$(git diff --name-only --diff-filter=U)
            echo "Conflicted files: $CONFLICTED_FILES"

            RESOLVABLE=true
            for file in $CONFLICTED_FILES; do
              case "$file" in
                .github/.release-please-manifest.json)
                  echo "Resolving release-please manifest conflict..."
                  python scripts/resolve-release-please-conflicts.py "$file"
                  RESOLVE_EXIT_CODE=$?
                  if [[ $RESOLVE_EXIT_CODE -eq 0 ]]; then
                    git add "$file"
                  else
                    echo "âŒ Failed to resolve $file"
                    RESOLVABLE=false
                  fi
                  ;;
                *)
                  echo "âŒ Unknown conflict in $file, cannot auto-resolve"
                  RESOLVABLE=false
                  ;;
              esac
            done

            if [[ "$RESOLVABLE" == "true" ]]; then
              # Continue rebase after resolving conflicts
              # Use GIT_EDITOR=true to skip interactive commit message editing
              if GIT_EDITOR=true git rebase --continue; then
                if git push --force-with-lease; then
                  echo "âœ… PR #$pr rebased with resolved conflicts"
                  RESOLVED_PRS="$RESOLVED_PRS $pr"
                else
                  echo "âŒ PR #$pr push failed after rebase"
                  FAILED_PRS="$FAILED_PRS $pr"
                fi
              else
                echo "âŒ PR #$pr rebase --continue failed"
                git rebase --abort
                FAILED_PRS="$FAILED_PRS $pr"
              fi
            else
              echo "âš ï¸ PR #$pr has unresolvable conflicts, aborting"
              git rebase --abort
              FAILED_PRS="$FAILED_PRS $pr"
            fi

            # Return to main for next PR (force to handle any leftover state)
            if ! git checkout -f main; then
              echo "âŒ Failed to checkout main, resetting"
              git reset --hard HEAD
              git checkout -f main || break
            fi
          done

          # Summary
          echo "### ðŸ”„ Release PR Rebase Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ -n "$RESOLVED_PRS" ]]; then
            echo "**âœ… Successfully rebased:**" >> $GITHUB_STEP_SUMMARY
            for pr in $RESOLVED_PRS; do
              echo "- PR #$pr" >> $GITHUB_STEP_SUMMARY
            done
          fi
          if [[ -n "$FAILED_PRS" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**âŒ Failed to resolve (manual intervention needed):**" >> $GITHUB_STEP_SUMMARY
            for pr in $FAILED_PRS; do
              echo "- PR #$pr" >> $GITHUB_STEP_SUMMARY
            done
          fi
          if [[ -z "$RESOLVED_PRS" && -z "$FAILED_PRS" ]]; then
            echo "_No conflicted release PRs were processed in this run._" >> $GITHUB_STEP_SUMMARY
          fi
