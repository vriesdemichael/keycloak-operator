name: Release Please

# Automated release management using conventional commits
# - Creates/updates release PR with changelog and version bump
# - When PR is merged, creates GitHub release
# - CI/CD workflow triggers on tag push to publish Docker images

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}

    steps:
      - name: Run Release Please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: .github/release-please-config.json
          manifest-file: .github/.release-please-manifest.json

      - name: Dispatch CI/CD workflow for release
        if: steps.release.outputs.release_created == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Dispatching CI/CD workflow for tag ${{ steps.release.outputs.tag_name }}"
          gh api repos/${{ github.repository }}/dispatches \
            --method POST \
            --field event_type='release-published' \
            --field client_payload[tag]='${{ steps.release.outputs.tag_name }}'

      - name: Release summary
        if: steps.release.outputs.release_created == 'true'
        run: |
          echo "### :rocket: Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ steps.release.outputs.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL:** ${{ steps.release.outputs.html_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "CI/CD workflow will publish Docker images with semver tags." >> $GITHUB_STEP_SUMMARY

      - name: PR summary
        if: steps.release.outputs.pr != ''
        env:
          PR_DATA: ${{ steps.release.outputs.pr }}
        run: |
          echo "### :memo: Release PR Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** ${PR_DATA}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Merge this PR to create a release." >> $GITHUB_STEP_SUMMARY

      - name: Enable auto-merge for release PR
        if: steps.release.outputs.pr != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ fromJSON(steps.release.outputs.pr).number }}
        run: |
          gh pr merge $PR_NUMBER --auto --squash --repo ${{ github.repository }}
