name: CI/CD Pipeline (Unified)

# Unified CI/CD pipeline with release-please as the gatekeeper:
#
# FLOW:
# 1. Detection - Determine if this is main branch
# 2. Quality checks - Run on ALL commits (CI gate)
# 3. Release-please - THE GATEKEEPER: runs after CI passes, determines what to release
# 4. Publish - Conditional on release-please outputs (CD phase)
# 5. Documentation - Dev docs on main, versioned docs on chart releases
# 6. Complete - Final status check
#
# KEY PRINCIPLE: release-please outputs drive the publish phase, not commit message parsing.
# This makes the release process transparent and predictable.

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  KEYCLOAK_VERSION: "26.4.1"

jobs:
  # =====================================================
  # PHASE 1: DETECTION
  # =====================================================
  detect:
    name: Detect Branch
    runs-on: ubuntu-latest
    outputs:
      is_main: ${{ steps.branch.outputs.is_main }}

    steps:
      - name: Check branch
        id: branch
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "is_main=true" >> $GITHUB_OUTPUT
          else
            echo "is_main=false" >> $GITHUB_OUTPUT
          fi

      - name: Summary
        run: |
          echo "### ðŸ“‹ Detection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Is Main:** ${{ steps.branch.outputs.is_main }}" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

  # =====================================================
  # PHASE 2: QUALITY CHECKS (CI - runs on ALL commits)
  # =====================================================
  build-operator:
    name: Build Operator Image
    needs: detect
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v6

      - name: Build operator
        uses: ./.github/actions/build-operator

  unit-tests:
    name: Unit Tests & Coverage
    needs: [detect, build-operator]
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v6

      - name: Run unit tests
        uses: ./.github/actions/unit-tests
        with:
          codecov-token: ${{ secrets.CODECOV_TOKEN }}
          github-actor: ${{ github.actor }}

  code-quality:
    name: Code Quality
    needs: [detect, build-operator]
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v6

      - name: Run quality checks
        uses: ./.github/actions/code-quality

  docs-validation:
    name: Documentation Validation
    needs: [detect]
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v6

      - name: Validate documentation
        uses: ./.github/actions/docs-validation

  security-scans:
    name: Security Scans
    needs: [detect, build-operator, unit-tests, code-quality, docs-validation]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      security-events: write
      contents: read
      actions: read

    steps:
      - uses: actions/checkout@v6

      - name: Run security scans
        uses: ./.github/actions/security-scans

  integration-tests:
    name: Integration Tests
    needs: [detect, build-operator, unit-tests, code-quality, docs-validation]
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
      packages: read

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run integration tests
        uses: ./.github/actions/integration-tests
        with:
          cluster-name: test-${{ github.run_id }}
          registry: ${{ env.REGISTRY }}
          image-name: ${{ env.IMAGE_NAME }}
          keycloak-version: ${{ env.KEYCLOAK_VERSION }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          codecov-token: ${{ secrets.CODECOV_TOKEN }}
          github-actor: ${{ github.actor }}
          run-id: ${{ github.run_id }}

  # =====================================================
  # CHECKPOINT: All required checks passed
  # =====================================================
  all-required-checks-passed:
    name: All Required Checks Passed
    needs: [detect, unit-tests, code-quality, docs-validation, security-scans, integration-tests]
    if: always()
    runs-on: ubuntu-latest
    outputs:
      passed: ${{ steps.check.outputs.passed }}

    steps:
      - name: Check all required
        id: check
        run: |
          echo "### âœ… Required Checks Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docs Validation: ${{ needs.docs-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scans: ${{ needs.security-scans.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if any required job failed
          if [[ "${{ needs.unit-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.code-quality.result }}" == "failure" ]] || \
             [[ "${{ needs.docs-validation.result }}" == "failure" ]] || \
             [[ "${{ needs.security-scans.result }}" == "failure" ]] || \
             [[ "${{ needs.integration-tests.result }}" == "failure" ]]; then
            echo "âŒ Required checks failed" >> $GITHUB_STEP_SUMMARY
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Checks should not be skipped
          if [[ "${{ needs.unit-tests.result }}" == "skipped" ]] || \
             [[ "${{ needs.code-quality.result }}" == "skipped" ]] || \
             [[ "${{ needs.docs-validation.result }}" == "skipped" ]] || \
             [[ "${{ needs.security-scans.result }}" == "skipped" ]] || \
             [[ "${{ needs.integration-tests.result }}" == "skipped" ]]; then
            echo "âš ï¸ Quality checks should not be skipped" >> $GITHUB_STEP_SUMMARY
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "âœ… All required checks passed" >> $GITHUB_STEP_SUMMARY
          echo "passed=true" >> $GITHUB_OUTPUT

  # =====================================================
  # PHASE 3: RELEASE-PLEASE (THE GATEKEEPER)
  # =====================================================
  # Runs AFTER CI passes on main branch pushes.
  # This is the single source of truth for what gets released.
  #
  # On normal commits: creates/updates Release PR
  # On Release PR merge: creates GitHub releases and tags, outputs signal publish jobs
  #
  # NOTE: release-please can timeout on first run or after many commits
  # due to GitHub API rate limits while backfilling commit history.
  # We use retry logic to handle transient failures.
  release-please:
    name: Release Please
    needs: [detect, all-required-checks-passed]
    if: |
      needs.all-required-checks-passed.result == 'success' &&
      needs.detect.outputs.is_main == 'true' &&
      github.event_name == 'push'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: write
      pull-requests: write
    outputs:
      # Operator (Docker image)
      operator_released: ${{ steps.release.outputs.operator_released }}
      operator_version: ${{ steps.release.outputs.operator_version }}
      operator_tag: ${{ steps.release.outputs.operator_tag }}
      # Helm Charts
      chart_operator_released: ${{ steps.release.outputs.chart_operator_released }}
      chart_operator_version: ${{ steps.release.outputs.chart_operator_version }}
      chart_realm_released: ${{ steps.release.outputs.chart_realm_released }}
      chart_realm_version: ${{ steps.release.outputs.chart_realm_version }}
      chart_client_released: ${{ steps.release.outputs.chart_client_released }}
      chart_client_version: ${{ steps.release.outputs.chart_client_version }}
      # PRs info (for auto-merge) - with separate-pull-requests, this is an array
      prs: ${{ steps.release.outputs.prs }}
      releases_created: ${{ steps.release.outputs.releases_created }}

    steps:
      # First attempt
      - name: Run Release Please (attempt 1)
        id: release-1
        uses: googleapis/release-please-action@v4
        continue-on-error: true
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          config-file: .github/release-please-config.json
          manifest-file: .github/.release-please-manifest.json

      # Wait and retry on failure (GitHub caches partial backfill progress)
      - name: Wait before retry
        if: steps.release-1.outcome == 'failure'
        run: |
          echo "First attempt failed, waiting 60s before retry..."
          echo "GitHub caches backfill progress, so retry should be faster."
          sleep 60

      - name: Run Release Please (attempt 2)
        id: release-2
        if: steps.release-1.outcome == 'failure'
        uses: googleapis/release-please-action@v4
        continue-on-error: true
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          config-file: .github/release-please-config.json
          manifest-file: .github/.release-please-manifest.json

      # Wait and retry again on failure
      - name: Wait before final retry
        if: steps.release-1.outcome == 'failure' && steps.release-2.outcome == 'failure'
        run: |
          echo "Second attempt failed, waiting 90s before final retry..."
          sleep 90

      - name: Run Release Please (attempt 3 - final)
        id: release-3
        if: steps.release-1.outcome == 'failure' && steps.release-2.outcome == 'failure'
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          config-file: .github/release-please-config.json
          manifest-file: .github/.release-please-manifest.json

      # Determine which attempt succeeded and extract outputs
      - name: Set release outputs
        id: release
        env:
          # Attempt 1 outputs
          # NOTE: Release-please output format depends on number of releases:
          # - Single release: flat keys like "release_created", "version", "tag_name"
          # - Multiple releases: path-prefixed like ".--release_created", "charts/keycloak-operator--version"
          # We check the "path" output to determine which component was released when using flat keys
          RP1_RELEASES_CREATED: ${{ steps.release-1.outputs.releases_created }}
          RP1_PRS: ${{ steps.release-1.outputs.prs }}
          # Flat keys (single release)
          RP1_SINGLE_RELEASED: ${{ steps.release-1.outputs.release_created }}
          RP1_SINGLE_VERSION: ${{ steps.release-1.outputs.version }}
          RP1_SINGLE_TAG: ${{ steps.release-1.outputs.tag_name }}
          RP1_SINGLE_PATH: ${{ steps.release-1.outputs.path }}
          # Path-prefixed keys (multiple releases)
          RP1_OP_RELEASED: ${{ steps.release-1.outputs['.--release_created'] }}
          RP1_OP_VERSION: ${{ steps.release-1.outputs['.--version'] }}
          RP1_OP_TAG: ${{ steps.release-1.outputs['.--tag_name'] }}
          RP1_CHART_OP_RELEASED: ${{ steps.release-1.outputs['charts/keycloak-operator--release_created'] }}
          RP1_CHART_OP_VERSION: ${{ steps.release-1.outputs['charts/keycloak-operator--version'] }}
          RP1_CHART_REALM_RELEASED: ${{ steps.release-1.outputs['charts/keycloak-realm--release_created'] }}
          RP1_CHART_REALM_VERSION: ${{ steps.release-1.outputs['charts/keycloak-realm--version'] }}
          RP1_CHART_CLIENT_RELEASED: ${{ steps.release-1.outputs['charts/keycloak-client--release_created'] }}
          RP1_CHART_CLIENT_VERSION: ${{ steps.release-1.outputs['charts/keycloak-client--version'] }}
          # Attempt 2 outputs
          RP2_RELEASES_CREATED: ${{ steps.release-2.outputs.releases_created }}
          RP2_PRS: ${{ steps.release-2.outputs.prs }}
          RP2_SINGLE_RELEASED: ${{ steps.release-2.outputs.release_created }}
          RP2_SINGLE_VERSION: ${{ steps.release-2.outputs.version }}
          RP2_SINGLE_TAG: ${{ steps.release-2.outputs.tag_name }}
          RP2_SINGLE_PATH: ${{ steps.release-2.outputs.path }}
          RP2_OP_RELEASED: ${{ steps.release-2.outputs['.--release_created'] }}
          RP2_OP_VERSION: ${{ steps.release-2.outputs['.--version'] }}
          RP2_OP_TAG: ${{ steps.release-2.outputs['.--tag_name'] }}
          RP2_CHART_OP_RELEASED: ${{ steps.release-2.outputs['charts/keycloak-operator--release_created'] }}
          RP2_CHART_OP_VERSION: ${{ steps.release-2.outputs['charts/keycloak-operator--version'] }}
          RP2_CHART_REALM_RELEASED: ${{ steps.release-2.outputs['charts/keycloak-realm--release_created'] }}
          RP2_CHART_REALM_VERSION: ${{ steps.release-2.outputs['charts/keycloak-realm--version'] }}
          RP2_CHART_CLIENT_RELEASED: ${{ steps.release-2.outputs['charts/keycloak-client--release_created'] }}
          RP2_CHART_CLIENT_VERSION: ${{ steps.release-2.outputs['charts/keycloak-client--version'] }}
          # Attempt 3 outputs
          RP3_RELEASES_CREATED: ${{ steps.release-3.outputs.releases_created }}
          RP3_PRS: ${{ steps.release-3.outputs.prs }}
          RP3_SINGLE_RELEASED: ${{ steps.release-3.outputs.release_created }}
          RP3_SINGLE_VERSION: ${{ steps.release-3.outputs.version }}
          RP3_SINGLE_TAG: ${{ steps.release-3.outputs.tag_name }}
          RP3_SINGLE_PATH: ${{ steps.release-3.outputs.path }}
          RP3_OP_RELEASED: ${{ steps.release-3.outputs['.--release_created'] }}
          RP3_OP_VERSION: ${{ steps.release-3.outputs['.--version'] }}
          RP3_OP_TAG: ${{ steps.release-3.outputs['.--tag_name'] }}
          RP3_CHART_OP_RELEASED: ${{ steps.release-3.outputs['charts/keycloak-operator--release_created'] }}
          RP3_CHART_OP_VERSION: ${{ steps.release-3.outputs['charts/keycloak-operator--version'] }}
          RP3_CHART_REALM_RELEASED: ${{ steps.release-3.outputs['charts/keycloak-realm--release_created'] }}
          RP3_CHART_REALM_VERSION: ${{ steps.release-3.outputs['charts/keycloak-realm--version'] }}
          RP3_CHART_CLIENT_RELEASED: ${{ steps.release-3.outputs['charts/keycloak-client--release_created'] }}
          RP3_CHART_CLIENT_VERSION: ${{ steps.release-3.outputs['charts/keycloak-client--version'] }}
        run: |
          # Debug: Show all release-please outputs
          echo "### Debug: Release Please Outputs" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo '${{ toJSON(steps.release-1.outputs) }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Helper function to map single-release outputs to per-component variables
          # When only one release occurs, release-please uses flat keys (release_created, version, etc.)
          # with a "path" key indicating which component. We map these to our per-component variables.
          map_single_release() {
            local SINGLE_RELEASED="$1"
            local SINGLE_VERSION="$2"
            local SINGLE_TAG="$3"
            local SINGLE_PATH="$4"

            if [[ "$SINGLE_RELEASED" == "true" ]]; then
              case "$SINGLE_PATH" in
                ".")
                  OP_RELEASED="true"
                  OP_VERSION="$SINGLE_VERSION"
                  OP_TAG="$SINGLE_TAG"
                  ;;
                "charts/keycloak-operator")
                  CHART_OP_RELEASED="true"
                  CHART_OP_VERSION="$SINGLE_VERSION"
                  ;;
                "charts/keycloak-realm")
                  CHART_REALM_RELEASED="true"
                  CHART_REALM_VERSION="$SINGLE_VERSION"
                  ;;
                "charts/keycloak-client")
                  CHART_CLIENT_RELEASED="true"
                  CHART_CLIENT_VERSION="$SINGLE_VERSION"
                  ;;
              esac
            fi
          }

          # Determine which attempt succeeded and use its outputs
          if [[ "${{ steps.release-1.outcome }}" == "success" ]]; then
            echo "Release Please succeeded on attempt 1"
            RELEASES_CREATED="$RP1_RELEASES_CREATED"
            PRS="$RP1_PRS"
            # First try path-prefixed keys (multiple releases)
            OP_RELEASED="$RP1_OP_RELEASED"
            OP_VERSION="$RP1_OP_VERSION"
            OP_TAG="$RP1_OP_TAG"
            CHART_OP_RELEASED="$RP1_CHART_OP_RELEASED"
            CHART_OP_VERSION="$RP1_CHART_OP_VERSION"
            CHART_REALM_RELEASED="$RP1_CHART_REALM_RELEASED"
            CHART_REALM_VERSION="$RP1_CHART_REALM_VERSION"
            CHART_CLIENT_RELEASED="$RP1_CHART_CLIENT_RELEASED"
            CHART_CLIENT_VERSION="$RP1_CHART_CLIENT_VERSION"
            # If single release format, map it to the correct component
            map_single_release "$RP1_SINGLE_RELEASED" "$RP1_SINGLE_VERSION" "$RP1_SINGLE_TAG" "$RP1_SINGLE_PATH"
          elif [[ "${{ steps.release-2.outcome }}" == "success" ]]; then
            echo "Release Please succeeded on attempt 2"
            RELEASES_CREATED="$RP2_RELEASES_CREATED"
            PRS="$RP2_PRS"
            OP_RELEASED="$RP2_OP_RELEASED"
            OP_VERSION="$RP2_OP_VERSION"
            OP_TAG="$RP2_OP_TAG"
            CHART_OP_RELEASED="$RP2_CHART_OP_RELEASED"
            CHART_OP_VERSION="$RP2_CHART_OP_VERSION"
            CHART_REALM_RELEASED="$RP2_CHART_REALM_RELEASED"
            CHART_REALM_VERSION="$RP2_CHART_REALM_VERSION"
            CHART_CLIENT_RELEASED="$RP2_CHART_CLIENT_RELEASED"
            CHART_CLIENT_VERSION="$RP2_CHART_CLIENT_VERSION"
            map_single_release "$RP2_SINGLE_RELEASED" "$RP2_SINGLE_VERSION" "$RP2_SINGLE_TAG" "$RP2_SINGLE_PATH"
          elif [[ "${{ steps.release-3.outcome }}" == "success" ]]; then
            echo "Release Please succeeded on attempt 3"
            RELEASES_CREATED="$RP3_RELEASES_CREATED"
            PRS="$RP3_PRS"
            OP_RELEASED="$RP3_OP_RELEASED"
            OP_VERSION="$RP3_OP_VERSION"
            OP_TAG="$RP3_OP_TAG"
            CHART_OP_RELEASED="$RP3_CHART_OP_RELEASED"
            CHART_OP_VERSION="$RP3_CHART_OP_VERSION"
            CHART_REALM_RELEASED="$RP3_CHART_REALM_RELEASED"
            CHART_REALM_VERSION="$RP3_CHART_REALM_VERSION"
            CHART_CLIENT_RELEASED="$RP3_CHART_CLIENT_RELEASED"
            CHART_CLIENT_VERSION="$RP3_CHART_CLIENT_VERSION"
            map_single_release "$RP3_SINGLE_RELEASED" "$RP3_SINGLE_VERSION" "$RP3_SINGLE_TAG" "$RP3_SINGLE_PATH"
          else
            echo "### âŒ Release Please Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All 3 attempts failed. This may be due to:" >> $GITHUB_STEP_SUMMARY
            echo "- GitHub API rate limits during commit history backfill" >> $GITHUB_STEP_SUMMARY
            echo "- Network issues" >> $GITHUB_STEP_SUMMARY
            echo "- Configuration problems" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Re-run this workflow (backfill progress is cached)" >> $GITHUB_STEP_SUMMARY
            echo "2. Check release-please configuration if retries keep failing" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Output all release information
          echo "releases_created=${RELEASES_CREATED:-false}" >> $GITHUB_OUTPUT
          {
            echo 'prs<<EOF'
            echo "$PRS"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

          # Operator outputs
          echo "operator_released=${OP_RELEASED:-false}" >> $GITHUB_OUTPUT
          echo "operator_version=${OP_VERSION:-}" >> $GITHUB_OUTPUT
          echo "operator_tag=${OP_TAG:-}" >> $GITHUB_OUTPUT

          # Chart outputs
          echo "chart_operator_released=${CHART_OP_RELEASED:-false}" >> $GITHUB_OUTPUT
          echo "chart_operator_version=${CHART_OP_VERSION:-}" >> $GITHUB_OUTPUT
          echo "chart_realm_released=${CHART_REALM_RELEASED:-false}" >> $GITHUB_OUTPUT
          echo "chart_realm_version=${CHART_REALM_VERSION:-}" >> $GITHUB_OUTPUT
          echo "chart_client_released=${CHART_CLIENT_RELEASED:-false}" >> $GITHUB_OUTPUT
          echo "chart_client_version=${CHART_CLIENT_VERSION:-}" >> $GITHUB_OUTPUT

          # Summary
          echo "### ðŸŽ¯ Release Please Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Releases Created:** ${RELEASES_CREATED:-false}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${RELEASES_CREATED:-false}" == "true" ]]; then
            echo "**Components Released:**" >> $GITHUB_STEP_SUMMARY
            [[ "$OP_RELEASED" == "true" ]] && echo "- âœ… Operator: v${OP_VERSION}" >> $GITHUB_STEP_SUMMARY || true
            [[ "$CHART_OP_RELEASED" == "true" ]] && echo "- âœ… Chart Operator: v${CHART_OP_VERSION}" >> $GITHUB_STEP_SUMMARY || true
            [[ "$CHART_REALM_RELEASED" == "true" ]] && echo "- âœ… Chart Realm: v${CHART_REALM_VERSION}" >> $GITHUB_STEP_SUMMARY || true
            [[ "$CHART_CLIENT_RELEASED" == "true" ]] && echo "- âœ… Chart Client: v${CHART_CLIENT_VERSION}" >> $GITHUB_STEP_SUMMARY || true
          elif [[ -n "$PRS" && "$PRS" != "[]" ]]; then
            echo "**Release PRs:** Created/Updated" >> $GITHUB_STEP_SUMMARY
          else
            echo "No releases or PR updates needed." >> $GITHUB_STEP_SUMMARY
          fi

      - uses: actions/checkout@v6
        if: steps.release.outputs.prs != '' && steps.release.outputs.prs != '[]'

      - name: Enable auto-merge for non-major releases
        if: steps.release.outputs.prs != '' && steps.release.outputs.prs != '[]'
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          PRS_DATA: ${{ steps.release.outputs.prs }}
        run: |
          # With separate-pull-requests, we get an array of PRs
          # Iterate over each PR and enable auto-merge if not a major bump
          # Using process substitution to avoid subshell issues with pipe

          echo "Processing release PRs..."
          SUMMARY_OUTPUT=""

          while read -r pr_json; do
            PR_NUMBER=$(echo "$pr_json" | jq -r '.number')
            PR_BRANCH=$(echo "$pr_json" | jq -r '.headBranchName')
            PR_TITLE=$(echo "$pr_json" | jq -r '.title')

            echo "Checking PR #$PR_NUMBER: $PR_TITLE"

            # Fetch the PR branch to compare manifest
            if ! git fetch origin "$PR_BRANCH:$PR_BRANCH" 2>/dev/null; then
              echo "âš ï¸ Could not fetch branch $PR_BRANCH for PR #$PR_NUMBER"
              SUMMARY_OUTPUT+="âš ï¸ Skipped PR #$PR_NUMBER: could not fetch branch\n"
              continue
            fi

            # Check manifest changes to determine if this is a major release
            HAS_MAJOR_BUMP=false

            # Get current and new manifest
            CURRENT_MANIFEST=$(cat .github/.release-please-manifest.json)
            NEW_MANIFEST=$(git show "$PR_BRANCH:.github/.release-please-manifest.json" 2>/dev/null)
            if [[ -z "$NEW_MANIFEST" ]]; then
              echo "âš ï¸ Could not read manifest from branch $PR_BRANCH for PR #$PR_NUMBER"
              SUMMARY_OUTPUT+="âš ï¸ Skipped PR #$PR_NUMBER: manifest not found in branch\n"
              continue
            fi

            # Compare each component using jq to iterate safely
            while read -r component; do
              CURRENT_VERSION=$(echo "$CURRENT_MANIFEST" | jq -r --arg comp "$component" '.[$comp]')
              NEW_VERSION=$(echo "$NEW_MANIFEST" | jq -r --arg comp "$component" '.[$comp]')

              if [[ "$CURRENT_VERSION" != "$NEW_VERSION" ]]; then
                echo "  Component '$component': $CURRENT_VERSION -> $NEW_VERSION"

                # Parse versions
                if [[ "$CURRENT_VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+) ]]; then
                  CUR_MAJOR="${BASH_REMATCH[1]}"
                fi

                if [[ "$NEW_VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+) ]]; then
                  NEW_MAJOR="${BASH_REMATCH[1]}"
                fi

                # Check if it's a major release (X.0.0 where X > current major and X > 0)
                if [[ "$NEW_MAJOR" -gt "$CUR_MAJOR" ]] && [[ "$NEW_MAJOR" -gt 0 ]]; then
                  echo "  âš ï¸  Major version bump detected: $CURRENT_VERSION -> $NEW_VERSION"
                  HAS_MAJOR_BUMP=true
                fi
              fi
            done < <(echo "$CURRENT_MANIFEST" | jq -r 'keys[]')

            # Enable auto-merge only if no major bumps
            if [[ "$HAS_MAJOR_BUMP" == "false" ]]; then
              if gh pr merge "$PR_NUMBER" --auto --rebase --repo ${{ github.repository }}; then
                SUMMARY_OUTPUT+="âœ… Auto-merge enabled for PR #$PR_NUMBER\n"
              else
                SUMMARY_OUTPUT+="âš ï¸ Auto-merge could not be enabled for PR #$PR_NUMBER\n"
              fi
            else
              SUMMARY_OUTPUT+="âš ï¸ Manual Review Required for PR #$PR_NUMBER (Major Release)\n"
            fi
          done < <(echo "$PRS_DATA" | jq -c '.[]')

          # Write summary after loop completes (outside subshell)
          if [[ -n "$SUMMARY_OUTPUT" ]]; then
            echo -e "$SUMMARY_OUTPUT" >> $GITHUB_STEP_SUMMARY
          fi

  # =====================================================
  # PHASE 4: PUBLISH ARTIFACTS (Conditional on release-please outputs)
  # =====================================================
  # These jobs ONLY run when release-please indicates a release was created.
  # This is the CD phase - triggered by the gatekeeper's outputs.
  publish-operator-image:
    name: Publish Operator Image
    needs: [release-please]
    if: needs.release-please.outputs.operator_released == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: ghcr-production
      url: https://github.com/${{ github.repository }}/pkgs/container/keycloak-operator
    permissions:
      contents: read
      packages: write
      security-events: write
      id-token: write
      attestations: write

    steps:
      - uses: actions/checkout@v6

      - name: Publish operator image
        uses: ./.github/actions/publish-operator-image
        with:
          registry: ${{ env.REGISTRY }}
          image-name: ${{ env.IMAGE_NAME }}
          operator-version: ${{ needs.release-please.outputs.operator_version }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-actor: ${{ github.actor }}

  # Update operator chart to use new operator version
  # This creates a PR that will trigger a chart release in the next cycle
  update-operator-chart:
    name: Update Operator Chart Version
    needs: [release-please, publish-operator-image]
    if: needs.release-please.outputs.operator_released == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Update chart version
        uses: ./.github/actions/update-operator-chart
        with:
          operator-version: ${{ needs.release-please.outputs.operator_version }}
          github-token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          github-repository: ${{ github.repository }}

  publish-chart-operator:
    name: Publish Helm Chart (Operator)
    needs: [release-please]
    if: needs.release-please.outputs.chart_operator_released == 'true'
    runs-on: ubuntu-latest
    environment:
      name: ghcr-chart-operator
      url: https://github.com/${{ github.repository }}/pkgs/container/charts%2Fkeycloak-operator
    permissions:
      contents: write
      packages: write
      id-token: write
      attestations: write

    steps:
      - uses: actions/checkout@v6

      - name: Publish chart
        uses: ./.github/actions/publish-helm-chart
        with:
          chart-name: keycloak-operator
          chart-path: charts/keycloak-operator
          registry-url: ${{ env.REGISTRY }}
          registry-owner: ${{ github.repository_owner }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-actor: ${{ github.actor }}

      - name: Create primary version tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHART_VERSION: ${{ needs.release-please.outputs.chart_operator_version }}
        run: |
          # The chart-operator is the primary artifact, so we also tag it with just v{version}
          # This allows users to reference the "main" version without the chart- prefix
          PRIMARY_TAG="v${CHART_VERSION}"
          COMPONENT_TAG="chart-operator-v${CHART_VERSION}"

          echo "Creating primary tag $PRIMARY_TAG pointing to same commit as $COMPONENT_TAG"

          # Get the commit SHA for the component tag
          COMMIT_SHA=$(git rev-parse HEAD)

          # Create the primary tag (lightweight tag pointing to same commit)
          git tag "$PRIMARY_TAG" "$COMMIT_SHA" 2>/dev/null || echo "Tag $PRIMARY_TAG already exists"
          git push origin "$PRIMARY_TAG" 2>/dev/null || echo "Tag $PRIMARY_TAG already pushed"

          echo "### ðŸ·ï¸ Primary Version Tag" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Created \`$PRIMARY_TAG\` pointing to chart-operator release" >> $GITHUB_STEP_SUMMARY

  publish-chart-realm:
    name: Publish Helm Chart (Realm)
    needs: [release-please]
    if: needs.release-please.outputs.chart_realm_released == 'true'
    runs-on: ubuntu-latest
    environment:
      name: ghcr-chart-realm
      url: https://github.com/${{ github.repository }}/pkgs/container/charts%2Fkeycloak-realm
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write

    steps:
      - uses: actions/checkout@v6

      - name: Publish chart
        uses: ./.github/actions/publish-helm-chart
        with:
          chart-name: keycloak-realm
          chart-path: charts/keycloak-realm
          registry-url: ${{ env.REGISTRY }}
          registry-owner: ${{ github.repository_owner }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-actor: ${{ github.actor }}

  publish-chart-client:
    name: Publish Helm Chart (Client)
    needs: [release-please]
    if: needs.release-please.outputs.chart_client_released == 'true'
    runs-on: ubuntu-latest
    environment:
      name: ghcr-chart-client
      url: https://github.com/${{ github.repository }}/pkgs/container/charts%2Fkeycloak-client
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write

    steps:
      - uses: actions/checkout@v6

      - name: Publish chart
        uses: ./.github/actions/publish-helm-chart
        with:
          chart-name: keycloak-client
          chart-path: charts/keycloak-client
          registry-url: ${{ env.REGISTRY }}
          registry-owner: ${{ github.repository_owner }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-actor: ${{ github.actor }}

  # =====================================================
  # PHASE 5: DOCUMENTATION
  # =====================================================
  update-dev-docs:
    name: Update Dev Documentation
    needs: [detect, all-required-checks-passed]
    # Run on every main push after CI passes
    if: |
      needs.all-required-checks-passed.result == 'success' &&
      needs.detect.outputs.is_main == 'true' &&
      github.event_name == 'push'
    runs-on: ubuntu-latest
    concurrency:
      group: github-pages
      cancel-in-progress: false
    environment:
      name: github-pages-dev
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/dev
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Update docs
        uses: ./.github/actions/update-dev-docs

  publish-release-docs:
    name: Publish Release Documentation
    needs: [release-please, publish-chart-operator]
    if: needs.release-please.outputs.chart_operator_released == 'true'
    runs-on: ubuntu-latest
    concurrency:
      group: github-pages
      cancel-in-progress: false
    environment:
      name: github-pages-release
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Publish docs
        uses: ./.github/actions/publish-release-docs

  # =====================================================
  # FINAL CHECKPOINT: Workflow Complete
  # =====================================================
  all-complete:
    name: Workflow Complete
    needs: [
      detect,
      all-required-checks-passed,
      release-please,
      publish-operator-image,
      update-operator-chart,
      publish-chart-operator,
      publish-chart-realm,
      publish-chart-client,
      update-dev-docs,
      publish-release-docs
    ]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Workflow summary
        run: |
          echo "### ðŸŽ¯ Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Required Checks:** ${{ needs.all-required-checks-passed.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release Please:** ${{ needs.release-please.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Operator Image:** ${{ needs.publish-operator-image.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Chart Update:** ${{ needs.update-operator-chart.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Chart Operator:** ${{ needs.publish-chart-operator.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Chart Realm:** ${{ needs.publish-chart-realm.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Chart Client:** ${{ needs.publish-chart-client.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dev Docs:** ${{ needs.update-dev-docs.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release Docs:** ${{ needs.publish-release-docs.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if any publish job that RAN failed
          FAILED=false

          if [[ "${{ needs.all-required-checks-passed.result }}" == "failure" ]]; then
            echo "âŒ Required checks failed" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi

          if [[ "${{ needs.publish-operator-image.result }}" == "failure" ]] || \
             [[ "${{ needs.publish-chart-operator.result }}" == "failure" ]] || \
             [[ "${{ needs.publish-chart-realm.result }}" == "failure" ]] || \
             [[ "${{ needs.publish-chart-client.result }}" == "failure" ]] || \
             [[ "${{ needs.publish-release-docs.result }}" == "failure" ]] || \
             [[ "${{ needs.update-dev-docs.result }}" == "failure" ]]; then
            echo "âŒ Publishing failed" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi

          if [[ "$FAILED" == "true" ]]; then
            exit 1
          fi

          echo "âœ… Workflow completed successfully" >> $GITHUB_STEP_SUMMARY
