name: CI/CD Pipeline (Unified)

# Unified CI/CD pipeline with clear phases:
# 1. Detection - Determine branch and release commit status
# 2. Quality checks - Run on all commits except release commits on main (parallel, ~20-40 min)
# 3. Release-please - Create/update release PRs (non-release commits on main after checks)
# 4. Publish - Publish artifacts (release commits on main, skip checks)
# 5. Documentation - Update dev docs on every main commit, versioned docs on chart-operator releases
# 6. Complete - Final status check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  KEYCLOAK_VERSION: "26.4.1"

jobs:
  # =====================================================
  # PHASE 1: DETECTION
  # =====================================================
  detect:
    name: Detect Branch & Release Status
    runs-on: ubuntu-latest
    outputs:
      # Branch info
      is_main: ${{ steps.branch.outputs.is_main }}
      # Release detection
      is_release_commit: ${{ steps.release-check.outputs.is_release }}
      # Which components are releasing (on release commits only)
      operator_releasing: ${{ steps.release-check.outputs.operator_releasing }}
      chart_operator_releasing: ${{ steps.release-check.outputs.chart_operator_releasing }}
      chart_realm_releasing: ${{ steps.release-check.outputs.chart_realm_releasing }}
      chart_client_releasing: ${{ steps.release-check.outputs.chart_client_releasing }}
      # Version info (on release commits only)
      operator_version: ${{ steps.release-check.outputs.operator_version }}
      chart_operator_version: ${{ steps.release-check.outputs.chart_operator_version }}
      chart_realm_version: ${{ steps.release-check.outputs.chart_realm_version }}
      chart_client_version: ${{ steps.release-check.outputs.chart_client_version }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Check branch
        id: branch
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "is_main=true" >> $GITHUB_OUTPUT
          else
            echo "is_main=false" >> $GITHUB_OUTPUT
          fi

      - name: Detect release commit
        id: release-check
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message || '' }}
        run: |
          # Check if this is a release commit by message pattern + CHANGELOG changes
          # Matches: "chore: release", "chore(main): release", "chore: release multiple components", etc.
          IS_RELEASE=false
          if [[ "$COMMIT_MSG" == "chore: release"* || "$COMMIT_MSG" == "chore(main): release"* ]]; then
            # Verify by checking CHANGELOG changes in this commit
            if git diff HEAD~1 HEAD --name-only | grep -E -q "^CHANGELOG.md$|^charts/.*/CHANGELOG.md$"; then
              IS_RELEASE=true
            fi
          fi

          echo "is_release=${IS_RELEASE}" >> $GITHUB_OUTPUT

          if [[ "$IS_RELEASE" == "false" ]]; then
            echo "Not a release commit"
            echo "operator_releasing=false" >> $GITHUB_OUTPUT
            echo "chart_operator_releasing=false" >> $GITHUB_OUTPUT
            echo "chart_realm_releasing=false" >> $GITHUB_OUTPUT
            echo "chart_client_releasing=false" >> $GITHUB_OUTPUT
            echo "operator_version=" >> $GITHUB_OUTPUT
            echo "chart_operator_version=" >> $GITHUB_OUTPUT
            echo "chart_realm_version=" >> $GITHUB_OUTPUT
            echo "chart_client_version=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Release commit detected, checking manifest for version changes..."

          # Parse version changes from .release-please-manifest.json
          OPERATOR_RELEASING=false
          CHART_OP_RELEASING=false
          CHART_REALM_RELEASING=false
          CHART_CLIENT_RELEASING=false
          OPERATOR_VERSION=""
          CHART_OP_VERSION=""
          CHART_REALM_VERSION=""
          CHART_CLIENT_VERSION=""

          # Check if manifest changed
          if git diff HEAD~1 HEAD --name-only | grep -q "^\.github/\.release-please-manifest\.json$"; then
            # Get the diff of the manifest
            MANIFEST_DIFF=$(git diff HEAD~1 HEAD .github/.release-please-manifest.json)

            # Check each component for version changes (look for removed lines with exact JSON key patterns)
            if echo "$MANIFEST_DIFF" | grep -q '^\-[ ]*"\."[ ]*:'; then
              # Operator version changed
              OPERATOR_RELEASING=true
              OPERATOR_VERSION=$(jq -r '."." // ""' .github/.release-please-manifest.json)
            fi

            if echo "$MANIFEST_DIFF" | grep -q '^\-[ ]*"charts/keycloak-operator"[ ]*:'; then
              CHART_OP_RELEASING=true
              CHART_OP_VERSION=$(jq -r '."charts/keycloak-operator" // ""' .github/.release-please-manifest.json)
            fi

            if echo "$MANIFEST_DIFF" | grep -q '^\-[ ]*"charts/keycloak-realm"[ ]*:'; then
              CHART_REALM_RELEASING=true
              CHART_REALM_VERSION=$(jq -r '."charts/keycloak-realm" // ""' .github/.release-please-manifest.json)
            fi

            if echo "$MANIFEST_DIFF" | grep -q '^\-[ ]*"charts/keycloak-client"[ ]*:'; then
              CHART_CLIENT_RELEASING=true
              CHART_CLIENT_VERSION=$(jq -r '."charts/keycloak-client" // ""' .github/.release-please-manifest.json)
            fi
          fi

          # Output results
          echo "operator_releasing=${OPERATOR_RELEASING}" >> $GITHUB_OUTPUT
          echo "chart_operator_releasing=${CHART_OP_RELEASING}" >> $GITHUB_OUTPUT
          echo "chart_realm_releasing=${CHART_REALM_RELEASING}" >> $GITHUB_OUTPUT
          echo "chart_client_releasing=${CHART_CLIENT_RELEASING}" >> $GITHUB_OUTPUT
          echo "operator_version=${OPERATOR_VERSION}" >> $GITHUB_OUTPUT
          echo "chart_operator_version=${CHART_OP_VERSION}" >> $GITHUB_OUTPUT
          echo "chart_realm_version=${CHART_REALM_VERSION}" >> $GITHUB_OUTPUT
          echo "chart_client_version=${CHART_CLIENT_VERSION}" >> $GITHUB_OUTPUT

          # Summary
          echo "### ðŸŽ¯ Release Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Components Releasing:**" >> $GITHUB_STEP_SUMMARY
          echo "- Operator: ${OPERATOR_RELEASING} ${OPERATOR_VERSION:+(v$OPERATOR_VERSION)}" >> $GITHUB_STEP_SUMMARY
          echo "- Chart Operator: ${CHART_OP_RELEASING} ${CHART_OP_VERSION:+(v$CHART_OP_VERSION)}" >> $GITHUB_STEP_SUMMARY
          echo "- Chart Realm: ${CHART_REALM_RELEASING} ${CHART_REALM_VERSION:+(v$CHART_REALM_VERSION)}" >> $GITHUB_STEP_SUMMARY
          echo "- Chart Client: ${CHART_CLIENT_RELEASING} ${CHART_CLIENT_VERSION:+(v$CHART_CLIENT_VERSION)}" >> $GITHUB_STEP_SUMMARY

      - name: Summary
        run: |
          echo "### ðŸ“‹ Detection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Is Main:** ${{ steps.branch.outputs.is_main }}" >> $GITHUB_STEP_SUMMARY
          echo "**Is Release Commit:** ${{ steps.release-check.outputs.is_release }}" >> $GITHUB_STEP_SUMMARY

  # =====================================================
  # PHASE 2: QUALITY CHECKS (Skip on release commits)
  # =====================================================
  build-operator:
    name: Build Operator Image
    needs: detect
    if: |
      needs.detect.outputs.is_main == 'false' ||
      needs.detect.outputs.is_release_commit == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v6

      - name: Build operator
        uses: ./.github/actions/build-operator

  unit-tests:
    name: Unit Tests & Coverage
    needs: [detect, build-operator]
    if: |
      needs.detect.outputs.is_main == 'false' ||
      needs.detect.outputs.is_release_commit == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v6

      - name: Run unit tests
        uses: ./.github/actions/unit-tests
        with:
          codecov-token: ${{ secrets.CODECOV_TOKEN }}
          github-actor: ${{ github.actor }}

  code-quality:
    name: Code Quality
    needs: [detect, build-operator]
    if: |
      needs.detect.outputs.is_main == 'false' ||
      needs.detect.outputs.is_release_commit == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v6

      - name: Run quality checks
        uses: ./.github/actions/code-quality

  security-scans:
    name: Security Scans
    needs: [detect, build-operator, unit-tests, code-quality]
    if: |
      needs.detect.outputs.is_main == 'false' ||
      needs.detect.outputs.is_release_commit == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      security-events: write
      contents: read
      actions: read

    steps:
      - uses: actions/checkout@v6

      - name: Run security scans
        uses: ./.github/actions/security-scans

  integration-tests:
    name: Integration Tests
    needs: [detect, build-operator, unit-tests, code-quality]
    if: |
      needs.detect.outputs.is_main == 'false' ||
      needs.detect.outputs.is_release_commit == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
      packages: read

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run integration tests
        uses: ./.github/actions/integration-tests
        with:
          cluster-name: test-${{ github.run_id }}
          registry: ${{ env.REGISTRY }}
          image-name: ${{ env.IMAGE_NAME }}
          keycloak-version: ${{ env.KEYCLOAK_VERSION }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          codecov-token: ${{ secrets.CODECOV_TOKEN }}
          github-actor: ${{ github.actor }}
          run-id: ${{ github.run_id }}

  # =====================================================
  # CHECKPOINT: All required checks passed
  # =====================================================
  all-required-checks-passed:
    name: All Required Checks Passed
    needs: [detect, unit-tests, code-quality, security-scans, integration-tests]
    if: always()
    runs-on: ubuntu-latest
    outputs:
      passed: ${{ steps.check.outputs.passed }}

    steps:
      - name: Check all required
        id: check
        run: |
          echo "### âœ… Required Checks Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scans: ${{ needs.security-scans.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if any required job failed
          if [[ "${{ needs.unit-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.code-quality.result }}" == "failure" ]] || \
             [[ "${{ needs.security-scans.result }}" == "failure" ]] || \
             [[ "${{ needs.integration-tests.result }}" == "failure" ]]; then
            echo "âŒ Required checks failed" >> $GITHUB_STEP_SUMMARY
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # On release commits, checks are skipped - that's ok
          # On non-release commits, checks must not be skipped
          if [[ "${{ needs.detect.outputs.is_release_commit }}" == "false" ]]; then
            if [[ "${{ needs.unit-tests.result }}" == "skipped" ]] || \
               [[ "${{ needs.code-quality.result }}" == "skipped" ]] || \
               [[ "${{ needs.security-scans.result }}" == "skipped" ]] || \
               [[ "${{ needs.integration-tests.result }}" == "skipped" ]]; then
              echo "âš ï¸ Quality checks should not skip on non-release commits" >> $GITHUB_STEP_SUMMARY
              echo "passed=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

          echo "âœ… All required checks passed or skipped appropriately" >> $GITHUB_STEP_SUMMARY
          echo "passed=true" >> $GITHUB_OUTPUT

  # =====================================================
  # PHASE 3: RELEASE-PLEASE
  # =====================================================
  # Runs on ALL main pushes:
  # - Normal commits: creates/updates Release PR (after quality checks)
  # - Release commits: creates tags/releases (after publishing artifacts)
  #
  # NOTE: release-please can timeout on first run or after many commits
  # due to GitHub API rate limits while backfilling commit history.
  # We use retry logic to handle transient failures.
  release-please:
    name: Release Please
    needs: [
      detect,
      all-required-checks-passed,
      publish-operator-image,
      update-operator-chart,
      publish-chart-operator,
      publish-chart-realm,
      publish-chart-client,
      publish-release-docs
    ]
    if: |
      always() &&
      needs.detect.outputs.is_main == 'true' &&
      github.event_name == 'push' &&
      !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: write
      pull-requests: write

    steps:
      # First attempt
      - name: Run Release Please (attempt 1)
        id: release-1
        uses: googleapis/release-please-action@v4
        continue-on-error: true
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          config-file: .github/release-please-config.json
          manifest-file: .github/.release-please-manifest.json

      # Wait and retry on failure (GitHub caches partial backfill progress)
      - name: Wait before retry
        if: steps.release-1.outcome == 'failure'
        run: |
          echo "First attempt failed, waiting 60s before retry..."
          echo "GitHub caches backfill progress, so retry should be faster."
          sleep 60

      - name: Run Release Please (attempt 2)
        id: release-2
        if: steps.release-1.outcome == 'failure'
        uses: googleapis/release-please-action@v4
        continue-on-error: true
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          config-file: .github/release-please-config.json
          manifest-file: .github/.release-please-manifest.json

      # Wait and retry again on failure
      - name: Wait before final retry
        if: steps.release-1.outcome == 'failure' && steps.release-2.outcome == 'failure'
        run: |
          echo "Second attempt failed, waiting 90s before final retry..."
          sleep 90

      - name: Run Release Please (attempt 3 - final)
        id: release-3
        if: steps.release-1.outcome == 'failure' && steps.release-2.outcome == 'failure'
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          config-file: .github/release-please-config.json
          manifest-file: .github/.release-please-manifest.json

      # Determine which attempt succeeded and set outputs
      - name: Set release outputs
        id: release
        run: |
          # Check which attempt succeeded (in order)
          if [[ "${{ steps.release-1.outcome }}" == "success" ]]; then
            echo "Release Please succeeded on attempt 1"
            echo "release_created=${{ steps.release-1.outputs.release_created }}" >> $GITHUB_OUTPUT
            echo "releases_created=${{ steps.release-1.outputs.releases_created }}" >> $GITHUB_OUTPUT
            echo "tag_name=${{ steps.release-1.outputs.tag_name }}" >> $GITHUB_OUTPUT
            echo "pr=${{ steps.release-1.outputs.pr }}" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.release-2.outcome }}" == "success" ]]; then
            echo "Release Please succeeded on attempt 2"
            echo "release_created=${{ steps.release-2.outputs.release_created }}" >> $GITHUB_OUTPUT
            echo "releases_created=${{ steps.release-2.outputs.releases_created }}" >> $GITHUB_OUTPUT
            echo "tag_name=${{ steps.release-2.outputs.tag_name }}" >> $GITHUB_OUTPUT
            echo "pr=${{ steps.release-2.outputs.pr }}" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.release-3.outcome }}" == "success" ]]; then
            echo "Release Please succeeded on attempt 3"
            echo "release_created=${{ steps.release-3.outputs.release_created }}" >> $GITHUB_OUTPUT
            echo "releases_created=${{ steps.release-3.outputs.releases_created }}" >> $GITHUB_OUTPUT
            echo "tag_name=${{ steps.release-3.outputs.tag_name }}" >> $GITHUB_OUTPUT
            echo "pr=${{ steps.release-3.outputs.pr }}" >> $GITHUB_OUTPUT
          else
            echo "### âŒ Release Please Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All 3 attempts failed. This may be due to:" >> $GITHUB_STEP_SUMMARY
            echo "- GitHub API rate limits during commit history backfill" >> $GITHUB_STEP_SUMMARY
            echo "- Network issues" >> $GITHUB_STEP_SUMMARY
            echo "- Configuration problems" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Re-run this workflow (backfill progress is cached)" >> $GITHUB_STEP_SUMMARY
            echo "2. Check release-please configuration if retries keep failing" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      # Detect untagged merged release PRs - this is a critical error that blocks releases
      - name: Check for untagged release PRs
        run: |
          # release-please returns success but sets releases_created=false when there are
          # untagged merged release PRs. This is a blocking condition that requires manual
          # intervention to create the missing tags AND releases.
          #
          # This happens when:
          # 1. A release PR is merged
          # 2. The release-please run that should create tags/releases fails/times out
          # 3. All subsequent runs abort with "untagged, merged release PRs outstanding"

          RELEASES_CREATED="${{ steps.release.outputs.releases_created }}"
          PR_OUTPUT="${{ steps.release.outputs.pr }}"
          RELEASE_CREATED="${{ steps.release.outputs.release_created }}"

          echo "Debug: releases_created=$RELEASES_CREATED, pr=$PR_OUTPUT, release_created=$RELEASE_CREATED"

          # If releases_created is explicitly false and we didn't create a PR or release,
          # it means release-please aborted due to untagged merged PRs
          if [[ "$RELEASES_CREATED" == "false" && -z "$PR_OUTPUT" && "$RELEASE_CREATED" != "true" ]]; then
            echo "### âŒ Untagged Merged Release PRs Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Release-please found merged release PRs without corresponding tags/releases." >> $GITHUB_STEP_SUMMARY
            echo "This blocks all future releases until resolved." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**To fix this:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Find the untagged release PR and its merge commit:" >> $GITHUB_STEP_SUMMARY
            echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "   gh pr list --state merged --search 'chore: release' --limit 5 --json number,title,mergeCommit" >> $GITHUB_STEP_SUMMARY
            echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "2. Check which tags exist vs which releases exist:" >> $GITHUB_STEP_SUMMARY
            echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "   git tag --list 'v*' --sort=-version:refname | head -5" >> $GITHUB_STEP_SUMMARY
            echo "   gh release list --limit 5" >> $GITHUB_STEP_SUMMARY
            echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "3. Create missing tag (if needed) and release:" >> $GITHUB_STEP_SUMMARY
            echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "   # If tag is missing:" >> $GITHUB_STEP_SUMMARY
            echo "   git tag -a vX.Y.Z <merge-commit-sha> -m 'Release vX.Y.Z'" >> $GITHUB_STEP_SUMMARY
            echo "   git push origin vX.Y.Z" >> $GITHUB_STEP_SUMMARY
            echo "   # Create the GitHub release:" >> $GITHUB_STEP_SUMMARY
            echo "   gh release create vX.Y.Z --title 'vX.Y.Z' --notes 'See CHANGELOG.md' --target <merge-commit-sha>" >> $GITHUB_STEP_SUMMARY
            echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "4. Re-run this workflow" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "âœ… No untagged release PR issues detected"

      - name: Release summary
        if: steps.release.outputs.release_created == 'true'
        run: |
          echo "### :rocket: Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ steps.release.outputs.tag_name }}\`" >> $GITHUB_STEP_SUMMARY

      - name: PR summary
        if: steps.release.outputs.pr != ''
        env:
          PR_DATA: ${{ steps.release.outputs.pr }}
        run: |
          echo "### :memo: Release PR Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** ${PR_DATA}" >> $GITHUB_STEP_SUMMARY

      - uses: actions/checkout@v6
        if: steps.release.outputs.pr != ''

      - name: Enable auto-merge for non-major releases
        if: steps.release.outputs.pr != ''
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          PR_DATA: ${{ steps.release.outputs.pr }}
        run: |
          PR_NUMBER=$(echo "$PR_DATA" | jq -r '.number')
          PR_BRANCH=$(echo "$PR_DATA" | jq -r '.headBranchName')

          # Fetch the PR branch to compare manifest
          git fetch origin "$PR_BRANCH:$PR_BRANCH"

          # Check manifest changes to determine if this is a major release
          HAS_MAJOR_BUMP=false

          # Get current and new manifest
          CURRENT_MANIFEST=$(cat .github/.release-please-manifest.json)
          NEW_MANIFEST=$(git show "$PR_BRANCH:.github/.release-please-manifest.json")

          # Compare each component
          for component in $(echo "$CURRENT_MANIFEST" | jq -r 'keys[]'); do
            CURRENT_VERSION=$(echo "$CURRENT_MANIFEST" | jq -r --arg comp "$component" '.[$comp]')
            NEW_VERSION=$(echo "$NEW_MANIFEST" | jq -r --arg comp "$component" '.[$comp]')

            if [[ "$CURRENT_VERSION" != "$NEW_VERSION" ]]; then
              echo "Component '$component': $CURRENT_VERSION -> $NEW_VERSION"

              # Parse versions
              if [[ "$CURRENT_VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+) ]]; then
                CUR_MAJOR="${BASH_REMATCH[1]}"
                CUR_MINOR="${BASH_REMATCH[2]}"
                CUR_PATCH="${BASH_REMATCH[3]}"
              fi

              if [[ "$NEW_VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+) ]]; then
                NEW_MAJOR="${BASH_REMATCH[1]}"
                NEW_MINOR="${BASH_REMATCH[2]}"
                NEW_PATCH="${BASH_REMATCH[3]}"
              fi

              # Check if it's a major release (X.0.0 where X > current major and X > 0)
              if [[ "$NEW_MAJOR" -gt "$CUR_MAJOR" ]] && [[ "$NEW_MAJOR" -gt 0 ]]; then
                echo "âš ï¸  Major version bump detected: $CURRENT_VERSION -> $NEW_VERSION"
                HAS_MAJOR_BUMP=true
              fi
            fi
          done

          # Enable auto-merge only if no major bumps
          if [[ "$HAS_MAJOR_BUMP" == "false" ]]; then
            if gh pr merge "$PR_NUMBER" --auto --rebase --repo ${{ github.repository }}; then
              echo "### :white_check_mark: Auto-merge enabled" >> $GITHUB_STEP_SUMMARY
            else
              echo "### :warning: Auto-merge failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### :warning: Manual Review Required (Major Release)" >> $GITHUB_STEP_SUMMARY
          fi

  # =====================================================
  # PHASE 4: PUBLISH ARTIFACTS (Release commits only)
  # =====================================================
  # NOTE: Publish jobs skip quality checks and only depend on [detect].
  # This assumes quality checks passed in the release PR before merging.
  # Release PRs should be protected by branch rules requiring status checks.
  publish-operator-image:
    name: Publish Operator Image
    needs: [detect]
    if: |
      needs.detect.outputs.is_main == 'true' &&
      needs.detect.outputs.is_release_commit == 'true' &&
      needs.detect.outputs.operator_releasing == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: ghcr-production
      url: https://github.com/${{ github.repository }}/pkgs/container/keycloak-operator
    permissions:
      contents: read
      packages: write
      security-events: write
      id-token: write
      attestations: write

    steps:
      - uses: actions/checkout@v6

      - name: Publish operator image
        uses: ./.github/actions/publish-operator-image
        with:
          registry: ${{ env.REGISTRY }}
          image-name: ${{ env.IMAGE_NAME }}
          operator-version: ${{ needs.detect.outputs.operator_version }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-actor: ${{ github.actor }}

  # Update operator chart version (part of publish artifacts phase)
  update-operator-chart:
    name: Update Operator Chart Version
    needs: [detect, publish-operator-image]
    if: |
      needs.detect.outputs.is_main == 'true' &&
      needs.detect.outputs.is_release_commit == 'true' &&
      needs.detect.outputs.operator_releasing == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # Use RELEASE_PLEASE_TOKEN (PAT) instead of GITHUB_TOKEN so the PR triggers workflows
      # This allows the chart update PR to trigger release-please when merged
      - name: Update chart version
        uses: ./.github/actions/update-operator-chart
        with:
          operator-version: ${{ needs.detect.outputs.operator_version }}
          github-token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          github-repository: ${{ github.repository }}

  publish-chart-operator:
    name: Publish Helm Chart (Operator)
    needs: [detect]
    if: |
      needs.detect.outputs.is_main == 'true' &&
      needs.detect.outputs.is_release_commit == 'true' &&
      needs.detect.outputs.chart_operator_releasing == 'true'
    runs-on: ubuntu-latest
    environment:
      name: ghcr-chart-operator
      url: https://github.com/${{ github.repository }}/pkgs/container/charts%2Fkeycloak-operator
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write

    steps:
      - uses: actions/checkout@v6

      - name: Publish chart
        uses: ./.github/actions/publish-helm-chart
        with:
          chart-name: keycloak-operator
          chart-path: charts/keycloak-operator
          registry-url: ${{ env.REGISTRY }}
          registry-owner: ${{ github.repository_owner }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-actor: ${{ github.actor }}

  publish-chart-realm:
    name: Publish Helm Chart (Realm)
    needs: [detect]
    if: |
      needs.detect.outputs.is_main == 'true' &&
      needs.detect.outputs.is_release_commit == 'true' &&
      needs.detect.outputs.chart_realm_releasing == 'true'
    runs-on: ubuntu-latest
    environment:
      name: ghcr-chart-realm
      url: https://github.com/${{ github.repository }}/pkgs/container/charts%2Fkeycloak-realm
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write

    steps:
      - uses: actions/checkout@v6

      - name: Publish chart
        uses: ./.github/actions/publish-helm-chart
        with:
          chart-name: keycloak-realm
          chart-path: charts/keycloak-realm
          registry-url: ${{ env.REGISTRY }}
          registry-owner: ${{ github.repository_owner }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-actor: ${{ github.actor }}

  publish-chart-client:
    name: Publish Helm Chart (Client)
    needs: [detect]
    if: |
      needs.detect.outputs.is_main == 'true' &&
      needs.detect.outputs.is_release_commit == 'true' &&
      needs.detect.outputs.chart_client_releasing == 'true'
    runs-on: ubuntu-latest
    environment:
      name: ghcr-chart-client
      url: https://github.com/${{ github.repository }}/pkgs/container/charts%2Fkeycloak-client
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write

    steps:
      - uses: actions/checkout@v6

      - name: Publish chart
        uses: ./.github/actions/publish-helm-chart
        with:
          chart-name: keycloak-client
          chart-path: charts/keycloak-client
          registry-url: ${{ env.REGISTRY }}
          registry-owner: ${{ github.repository_owner }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-actor: ${{ github.actor }}

  # =====================================================
  # PHASE 5: DOCUMENTATION
  # =====================================================
  update-dev-docs:
    name: Update Dev Documentation
    needs: [detect]
    # Run on every main commit to keep docs 1-1 with branch (includes release commits)
    if: needs.detect.outputs.is_main == 'true'
    runs-on: ubuntu-latest
    concurrency:
      group: github-pages
      cancel-in-progress: false
    environment:
      name: github-pages-dev
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/dev
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Update docs
        uses: ./.github/actions/update-dev-docs

  publish-release-docs:
    name: Publish Release Documentation
    needs: [detect, publish-chart-operator]
    if: |
      needs.detect.outputs.is_main == 'true' &&
      needs.detect.outputs.is_release_commit == 'true' &&
      needs.detect.outputs.chart_operator_releasing == 'true'
    runs-on: ubuntu-latest
    concurrency:
      group: github-pages
      cancel-in-progress: false
    environment:
      name: github-pages-release
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Publish docs
        uses: ./.github/actions/publish-release-docs

  # =====================================================
  # FINAL CHECKPOINT: Workflow Complete
  # =====================================================
  all-complete:
    name: Workflow Complete
    needs: [
      detect,
      all-required-checks-passed,
      release-please,
      publish-operator-image,
      update-operator-chart,
      publish-chart-operator,
      publish-chart-realm,
      publish-chart-client,
      update-dev-docs,
      publish-release-docs
    ]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Workflow summary
        run: |
          echo "### ðŸŽ¯ Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Required Checks:** ${{ needs.all-required-checks-passed.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release Please:** ${{ needs.release-please.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Operator Image:** ${{ needs.publish-operator-image.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Chart Update:** ${{ needs.update-operator-chart.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Chart Operator:** ${{ needs.publish-chart-operator.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Chart Realm:** ${{ needs.publish-chart-realm.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Chart Client:** ${{ needs.publish-chart-client.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dev Docs:** ${{ needs.update-dev-docs.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release Docs:** ${{ needs.publish-release-docs.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if any publish job that RAN failed
          FAILED=false

          if [[ "${{ needs.all-required-checks-passed.result }}" == "failure" ]]; then
            echo "âŒ Required checks failed" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi

          if [[ "${{ needs.publish-operator-image.result }}" == "failure" ]] || \
             [[ "${{ needs.publish-chart-operator.result }}" == "failure" ]] || \
             [[ "${{ needs.publish-chart-realm.result }}" == "failure" ]] || \
             [[ "${{ needs.publish-chart-client.result }}" == "failure" ]] || \
             [[ "${{ needs.publish-release-docs.result }}" == "failure" ]] || \
             [[ "${{ needs.update-dev-docs.result }}" == "failure" ]]; then
            echo "âŒ Publishing failed" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi

          if [[ "$FAILED" == "true" ]]; then
            exit 1
          fi

          echo "âœ… Workflow completed successfully" >> $GITHUB_STEP_SUMMARY
