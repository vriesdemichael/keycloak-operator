name: CI/CD Pipeline (Unified)

# Unified CI/CD pipeline with clear phases:
# 1. Detection - Determine what changed and what needs to run
# 2. Fast checks - Unit tests + code quality (parallel, ~2-5 min)
# 3. Slow checks - Security + integration tests (parallel after fast, ~15-30 min)
# 4. Release-please - Create/update release PRs (non-release commits only)
# 5. Publish - Publish artifacts (release commits only)
# 6. Docs - Update documentation (after checks pass)
# 7. Complete - Final status check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  KEYCLOAK_VERSION: "26.4.1"

jobs:
  # =====================================================
  # PHASE 1: DETECTION
  # =====================================================
  detect:
    name: Detect Changes & Release Type
    runs-on: ubuntu-latest
    outputs:
      # Release detection
      is_release: ${{ steps.release-check.outputs.is_release }}
      release_type: ${{ steps.release-check.outputs.release_type }}
      # Which components are releasing
      operator_releasing: ${{ steps.release-check.outputs.operator_releasing }}
      chart_operator_releasing: ${{ steps.release-check.outputs.chart_operator_releasing }}
      chart_realm_releasing: ${{ steps.release-check.outputs.chart_realm_releasing }}
      chart_client_releasing: ${{ steps.release-check.outputs.chart_client_releasing }}
      any_chart_releasing: ${{ steps.release-check.outputs.any_chart_releasing }}
      # Version info
      operator_version: ${{ steps.release-check.outputs.operator_version }}
      # File changes (set by dorny/paths-filter@v3 action)
      code_changed: ${{ steps.filter.outputs.code }}
      charts_changed: ${{ steps.filter.outputs.charts }}
      docs_changed: ${{ steps.filter.outputs.docs }}
      crds_changed: ${{ steps.filter.outputs.crds }}
      # Branch info
      is_main: ${{ steps.branch.outputs.is_main }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Check branch
        id: branch
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "is_main=true" >> $GITHUB_OUTPUT
          else
            echo "is_main=false" >> $GITHUB_OUTPUT
          fi

      - name: Detect release commit
        id: release-check
        run: |
          # Handle cases where head_commit may be null (workflow_dispatch, pull_request)
          COMMIT_MSG="${{ github.event.head_commit.message || '' }}"
          COMMIT_AUTHOR="${{ github.event.head_commit.author.username || '' }}"

          # Check if this is a release-please commit
          # Method A: Check bot author (works when release-please bot commits directly)
          # Method B: Check commit message + CHANGELOG (works when user merges release PR)
          IS_RELEASE=false
          if [[ "$COMMIT_AUTHOR" == "github-actions[bot]" ]] && \
             [[ "$COMMIT_MSG" == "chore: release"* || "$COMMIT_MSG" == "chore(main): release"* ]]; then
            IS_RELEASE=true
          elif [[ "$COMMIT_MSG" == "chore(main): release"* ]]; then
            # Release commits merged by user - verify by checking CHANGELOG changes
            if git diff HEAD~1 HEAD --name-only | grep -E -q "^CHANGELOG.md$|^charts/.*/CHANGELOG.md$"; then
              IS_RELEASE=true
            fi
          fi

          echo "is_release=${IS_RELEASE}" >> $GITHUB_OUTPUT

          if [[ "$IS_RELEASE" == "false" ]]; then
            echo "Not a release commit"
            echo "release_type=none" >> $GITHUB_OUTPUT
            echo "operator_releasing=false" >> $GITHUB_OUTPUT
            echo "chart_operator_releasing=false" >> $GITHUB_OUTPUT
            echo "chart_realm_releasing=false" >> $GITHUB_OUTPUT
            echo "chart_client_releasing=false" >> $GITHUB_OUTPUT
            echo "any_chart_releasing=false" >> $GITHUB_OUTPUT
            echo "operator_version=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Release commit detected, parsing versions..."

          # Initialize outputs
          OPERATOR_RELEASING=false
          CHART_OP_RELEASING=false
          CHART_REALM_RELEASING=false
          CHART_CLIENT_RELEASING=false
          OPERATOR_VERSION=""
          RELEASE_TYPE=""

          # Parse from changed CHANGELOG files
          if git diff HEAD~1 HEAD --name-only | grep -q "^CHANGELOG.md$"; then
            OPERATOR_RELEASING=true
            OPERATOR_VERSION=$(grep -m1 "^## \[" CHANGELOG.md | sed 's/## \[\(.*\)\].*/\1/')
            RELEASE_TYPE="operator"
          fi

          if git diff HEAD~1 HEAD --name-only | grep -q "^charts/keycloak-operator/CHANGELOG.md$"; then
            CHART_OP_RELEASING=true
            RELEASE_TYPE="${RELEASE_TYPE:+$RELEASE_TYPE,}chart-operator"
          fi

          if git diff HEAD~1 HEAD --name-only | grep -q "^charts/keycloak-realm/CHANGELOG.md$"; then
            CHART_REALM_RELEASING=true
            RELEASE_TYPE="${RELEASE_TYPE:+$RELEASE_TYPE,}chart-realm"
          fi

          if git diff HEAD~1 HEAD --name-only | grep -q "^charts/keycloak-client/CHANGELOG.md$"; then
            CHART_CLIENT_RELEASING=true
            RELEASE_TYPE="${RELEASE_TYPE:+$RELEASE_TYPE,}chart-client"
          fi

          # Set any_chart_releasing
          ANY_CHART_RELEASING=false
          if [[ "$CHART_OP_RELEASING" == "true" ]] || \
             [[ "$CHART_REALM_RELEASING" == "true" ]] || \
             [[ "$CHART_CLIENT_RELEASING" == "true" ]]; then
            ANY_CHART_RELEASING=true
          fi

          # Output results
          echo "operator_releasing=${OPERATOR_RELEASING}" >> $GITHUB_OUTPUT
          echo "chart_operator_releasing=${CHART_OP_RELEASING}" >> $GITHUB_OUTPUT
          echo "chart_realm_releasing=${CHART_REALM_RELEASING}" >> $GITHUB_OUTPUT
          echo "chart_client_releasing=${CHART_CLIENT_RELEASING}" >> $GITHUB_OUTPUT
          echo "any_chart_releasing=${ANY_CHART_RELEASING}" >> $GITHUB_OUTPUT
          echo "operator_version=${OPERATOR_VERSION}" >> $GITHUB_OUTPUT
          echo "release_type=${RELEASE_TYPE}" >> $GITHUB_OUTPUT

          # Summary
          echo "### ðŸŽ¯ Release Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release Type:** ${RELEASE_TYPE}" >> $GITHUB_STEP_SUMMARY
          echo "- Operator: ${OPERATOR_RELEASING} ${OPERATOR_VERSION:+(v$OPERATOR_VERSION)}" >> $GITHUB_STEP_SUMMARY
          echo "- Chart Operator: ${CHART_OP_RELEASING}" >> $GITHUB_STEP_SUMMARY
          echo "- Chart Realm: ${CHART_REALM_RELEASING}" >> $GITHUB_STEP_SUMMARY
          echo "- Chart Client: ${CHART_CLIENT_RELEASING}" >> $GITHUB_STEP_SUMMARY

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - 'src/**'
              - 'tests/**'
              - 'pyproject.toml'
              - 'uv.lock'
              - 'images/operator/**'
            charts:
              - 'charts/*/Chart.yaml'
              - 'charts/*/values.yaml'
              - 'charts/*/values.schema.json'
              - 'charts/*/templates/**'
              - 'charts/*/crds/**'
            docs:
              - 'docs/**'
              - 'mkdocs.yml'
              - 'scripts/build-adr-docs.sh'
            crds:
              - 'src/domain/models.py'

      - name: Summary
        run: |
          echo "### ðŸ“‹ Change Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Is Main:** ${{ steps.branch.outputs.is_main }}" >> $GITHUB_STEP_SUMMARY
          echo "**Is Release:** ${{ steps.release-check.outputs.is_release }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Changed Files:**" >> $GITHUB_STEP_SUMMARY
          echo "- Code: ${{ steps.filter.outputs.code }}" >> $GITHUB_STEP_SUMMARY
          echo "- Charts: ${{ steps.filter.outputs.charts }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docs: ${{ steps.filter.outputs.docs }}" >> $GITHUB_STEP_SUMMARY
          echo "- CRDs: ${{ steps.filter.outputs.crds }}" >> $GITHUB_STEP_SUMMARY

  # =====================================================
  # PHASE 2: BUILD (Always on code/chart changes)
  # =====================================================
  build-operator:
    name: Build Operator Image
    needs: detect
    # Force full run on main to catch integration issues from previous commits
    # Use change detection for PRs to save resources
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      needs.detect.outputs.code_changed == 'true' ||
      needs.detect.outputs.charts_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v6

      - name: Build operator
        uses: ./.github/actions/build-operator

  # =====================================================
  # PHASE 3: FAST CHECKS (Parallel, ~2-5 min)
  # =====================================================
  unit-tests:
    name: Unit Tests & Coverage
    needs: [detect, build-operator]
    if: |
      github.ref == 'refs/heads/main' ||
      needs.detect.outputs.code_changed == 'true' ||
      needs.detect.outputs.charts_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v6

      - name: Run unit tests
        uses: ./.github/actions/unit-tests
        with:
          codecov-token: ${{ secrets.CODECOV_TOKEN }}
          github-actor: ${{ github.actor }}

  code-quality:
    name: Code Quality
    needs: [detect, build-operator]
    if: |
      github.ref == 'refs/heads/main' ||
      needs.detect.outputs.code_changed == 'true' ||
      needs.detect.outputs.charts_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v6

      - name: Run quality checks
        uses: ./.github/actions/code-quality

  # =====================================================
  # PHASE 4: SLOW CHECKS (Parallel after fast, ~15-30 min)
  # =====================================================
  security-scans:
    name: Security Scans
    needs: [detect, build-operator, unit-tests, code-quality]
    if: |
      github.ref == 'refs/heads/main' ||
      needs.detect.outputs.code_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      security-events: write
      contents: read
      actions: read

    steps:
      - uses: actions/checkout@v6

      - name: Run security scans
        uses: ./.github/actions/security-scans

  integration-tests:
    name: Integration Tests
    needs: [detect, build-operator, unit-tests, code-quality]
    if: |
      github.ref == 'refs/heads/main' ||
      needs.detect.outputs.code_changed == 'true' ||
      needs.detect.outputs.charts_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
      packages: read

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run integration tests
        uses: ./.github/actions/integration-tests
        with:
          cluster-name: test-${{ github.run_id }}
          registry: ${{ env.REGISTRY }}
          image-name: ${{ env.IMAGE_NAME }}
          keycloak-version: ${{ env.KEYCLOAK_VERSION }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          codecov-token: ${{ secrets.CODECOV_TOKEN }}
          github-actor: ${{ github.actor }}
          run-id: ${{ github.run_id }}

  # =====================================================
  # CHECKPOINT: All required checks passed
  # =====================================================
  all-required-checks-passed:
    name: All Required Checks Passed
    needs: [detect, unit-tests, code-quality, security-scans, integration-tests]
    if: always()
    runs-on: ubuntu-latest
    outputs:
      passed: ${{ steps.check.outputs.passed }}

    steps:
      - name: Check all required
        id: check
        run: |
          echo "### âœ… Required Checks Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scans: ${{ needs.security-scans.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if any required job failed
          if [[ "${{ needs.unit-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.code-quality.result }}" == "failure" ]] || \
             [[ "${{ needs.security-scans.result }}" == "failure" ]] || \
             [[ "${{ needs.integration-tests.result }}" == "failure" ]]; then
            echo "âŒ Required checks failed" >> $GITHUB_STEP_SUMMARY
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Check if skipped inappropriately on main push
          # Note: workflow_dispatch on main is allowed to skip
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] && [[ "${{ github.event_name }}" == "push" ]]; then
            if [[ "${{ needs.integration-tests.result }}" == "skipped" ]]; then
              echo "âš ï¸ Integration tests should not skip on main branch pushes" >> $GITHUB_STEP_SUMMARY
              echo "passed=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

          echo "âœ… All required checks passed" >> $GITHUB_STEP_SUMMARY
          echo "passed=true" >> $GITHUB_OUTPUT

  # =====================================================
  # PHASE 5: RELEASE-PLEASE (Non-release commits only)
  # =====================================================
  release-please:
    name: Release Please
    needs: [detect, all-required-checks-passed]
    if: |
      needs.detect.outputs.is_main == 'true' &&
      needs.detect.outputs.is_release == 'false' &&
      github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Run Release Please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          config-file: .github/release-please-config.json
          manifest-file: .github/.release-please-manifest.json

      - name: Release summary
        if: steps.release.outputs.release_created == 'true'
        run: |
          echo "### :rocket: Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ steps.release.outputs.tag_name }}\`" >> $GITHUB_STEP_SUMMARY

      - name: PR summary
        if: steps.release.outputs.pr != ''
        env:
          PR_DATA: ${{ steps.release.outputs.pr }}
        run: |
          echo "### :memo: Release PR Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** ${PR_DATA}" >> $GITHUB_STEP_SUMMARY

      - name: Enable auto-merge for non-major releases
        if: steps.release.outputs.pr != ''
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          PR_DATA: ${{ steps.release.outputs.pr }}
        run: |
          PR_NUMBER=$(echo "$PR_DATA" | jq -r '.number')
          PR_BRANCH=$(echo "$PR_DATA" | jq -r '.headBranchName')

          # Fetch the PR branch to compare manifest
          git fetch origin "$PR_BRANCH:$PR_BRANCH"

          # Check manifest changes to determine if this is a major release
          HAS_MAJOR_BUMP=false

          # Get current and new manifest
          CURRENT_MANIFEST=$(cat .github/.release-please-manifest.json)
          NEW_MANIFEST=$(git show "$PR_BRANCH:.github/.release-please-manifest.json")

          # Compare each component
          for component in $(echo "$CURRENT_MANIFEST" | jq -r 'keys[]'); do
            CURRENT_VERSION=$(echo "$CURRENT_MANIFEST" | jq -r --arg comp "$component" '.[$comp]')
            NEW_VERSION=$(echo "$NEW_MANIFEST" | jq -r --arg comp "$component" '.[$comp]')

            if [[ "$CURRENT_VERSION" != "$NEW_VERSION" ]]; then
              echo "Component '$component': $CURRENT_VERSION -> $NEW_VERSION"

              # Parse versions
              if [[ "$CURRENT_VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+) ]]; then
                CUR_MAJOR="${BASH_REMATCH[1]}"
                CUR_MINOR="${BASH_REMATCH[2]}"
                CUR_PATCH="${BASH_REMATCH[3]}"
              fi

              if [[ "$NEW_VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+) ]]; then
                NEW_MAJOR="${BASH_REMATCH[1]}"
                NEW_MINOR="${BASH_REMATCH[2]}"
                NEW_PATCH="${BASH_REMATCH[3]}"
              fi

              # Check if it's a major release (X.0.0 where X > current major and X > 0)
              if [[ "$NEW_MAJOR" -gt "$CUR_MAJOR" ]] && [[ "$NEW_MAJOR" -gt 0 ]]; then
                echo "âš ï¸  Major version bump detected: $CURRENT_VERSION -> $NEW_VERSION"
                HAS_MAJOR_BUMP=true
              fi
            fi
          done

          # Enable auto-merge only if no major bumps
          if [[ "$HAS_MAJOR_BUMP" == "false" ]]; then
            if gh pr merge "$PR_NUMBER" --auto --rebase --repo ${{ github.repository }}; then
              echo "### :white_check_mark: Auto-merge enabled" >> $GITHUB_STEP_SUMMARY
            else
              echo "### :warning: Auto-merge failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### :warning: Manual Review Required (Major Release)" >> $GITHUB_STEP_SUMMARY
          fi

      - uses: actions/checkout@v6
        if: steps.release.outputs.pr != ''

  # =====================================================
  # PHASE 6: PUBLISH OPERATOR IMAGE (Release commits)
  # =====================================================
  publish-operator-image:
    name: Publish Operator Image
    needs: [detect, all-required-checks-passed]
    if: |
      needs.detect.outputs.is_main == 'true' &&
      needs.detect.outputs.is_release == 'true' &&
      needs.detect.outputs.operator_releasing == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: ghcr-production
      url: https://github.com/${{ github.repository }}/pkgs/container/keycloak-operator
    permissions:
      contents: read
      packages: write
      security-events: write
      id-token: write
      attestations: write

    steps:
      - uses: actions/checkout@v6

      - name: Publish operator image
        uses: ./.github/actions/publish-operator-image
        with:
          registry: ${{ env.REGISTRY }}
          image-name: ${{ env.IMAGE_NAME }}
          operator-version: ${{ needs.detect.outputs.operator_version }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-actor: ${{ github.actor }}

  # =====================================================
  # PHASE 7: UPDATE OPERATOR CHART (After operator publish)
  # =====================================================
  update-operator-chart:
    name: Update Operator Chart Version
    needs: [detect, all-required-checks-passed, publish-operator-image]
    if: |
      needs.detect.outputs.is_main == 'true' &&
      needs.detect.outputs.is_release == 'true' &&
      needs.detect.outputs.operator_releasing == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # Use RELEASE_PLEASE_TOKEN (PAT) instead of GITHUB_TOKEN so the PR triggers workflows
      # This allows the chart update PR to trigger release-please when merged
      - name: Update chart version
        uses: ./.github/actions/update-operator-chart
        with:
          operator-version: ${{ needs.detect.outputs.operator_version }}
          github-token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          github-repository: ${{ github.repository }}

  # =====================================================
  # PHASE 8: PUBLISH HELM CHARTS (Chart releases to OCI)
  # =====================================================
  publish-chart-operator:
    name: Publish Helm Chart (Operator)
    needs: [detect, all-required-checks-passed]
    if: |
      needs.detect.outputs.is_main == 'true' &&
      needs.detect.outputs.is_release == 'true' &&
      needs.detect.outputs.chart_operator_releasing == 'true'
    runs-on: ubuntu-latest
    environment:
      name: ghcr-chart-operator
      url: https://github.com/${{ github.repository }}/pkgs/container/charts%2Fkeycloak-operator
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write

    steps:
      - uses: actions/checkout@v6

      - name: Publish chart
        uses: ./.github/actions/publish-helm-chart
        with:
          chart-name: keycloak-operator
          chart-path: charts/keycloak-operator
          registry-url: ${{ env.REGISTRY }}
          registry-owner: ${{ github.repository_owner }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-actor: ${{ github.actor }}

  publish-chart-realm:
    name: Publish Helm Chart (Realm)
    needs: [detect, all-required-checks-passed]
    if: |
      needs.detect.outputs.is_main == 'true' &&
      needs.detect.outputs.is_release == 'true' &&
      needs.detect.outputs.chart_realm_releasing == 'true'
    runs-on: ubuntu-latest
    environment:
      name: ghcr-chart-realm
      url: https://github.com/${{ github.repository }}/pkgs/container/charts%2Fkeycloak-realm
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write

    steps:
      - uses: actions/checkout@v6

      - name: Publish chart
        uses: ./.github/actions/publish-helm-chart
        with:
          chart-name: keycloak-realm
          chart-path: charts/keycloak-realm
          registry-url: ${{ env.REGISTRY }}
          registry-owner: ${{ github.repository_owner }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-actor: ${{ github.actor }}

  publish-chart-client:
    name: Publish Helm Chart (Client)
    needs: [detect, all-required-checks-passed]
    if: |
      needs.detect.outputs.is_main == 'true' &&
      needs.detect.outputs.is_release == 'true' &&
      needs.detect.outputs.chart_client_releasing == 'true'
    runs-on: ubuntu-latest
    environment:
      name: ghcr-chart-client
      url: https://github.com/${{ github.repository }}/pkgs/container/charts%2Fkeycloak-client
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write

    steps:
      - uses: actions/checkout@v6

      - name: Publish chart
        uses: ./.github/actions/publish-helm-chart
        with:
          chart-name: keycloak-client
          chart-path: charts/keycloak-client
          registry-url: ${{ env.REGISTRY }}
          registry-owner: ${{ github.repository_owner }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-actor: ${{ github.actor }}

  # =====================================================
  # PHASE 9: DOCUMENTATION
  # =====================================================
  update-dev-docs:
    name: Update Dev Documentation
    needs: [detect]
    if: |
      needs.detect.outputs.is_main == 'true' &&
      needs.detect.outputs.is_release == 'false' &&
      github.event_name == 'push'
    runs-on: ubuntu-latest
    concurrency:
      group: github-pages
      cancel-in-progress: false
    environment:
      name: github-pages-dev
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/dev
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Update docs
        uses: ./.github/actions/update-dev-docs

  publish-release-docs:
    name: Publish Release Documentation
    needs: [detect, all-required-checks-passed, publish-chart-operator]
    if: |
      needs.detect.outputs.is_main == 'true' &&
      needs.detect.outputs.is_release == 'true' &&
      needs.detect.outputs.chart_operator_releasing == 'true'
    runs-on: ubuntu-latest
    concurrency:
      group: github-pages
      cancel-in-progress: false
    environment:
      name: github-pages-release
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Publish docs
        uses: ./.github/actions/publish-release-docs

  # =====================================================
  # FINAL CHECKPOINT: Workflow Complete
  # =====================================================
  all-complete:
    name: Workflow Complete
    needs: [
      detect,
      all-required-checks-passed,
      release-please,
      publish-operator-image,
      update-operator-chart,
      publish-chart-operator,
      publish-chart-realm,
      publish-chart-client,
      update-dev-docs,
      publish-release-docs
    ]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Workflow summary
        run: |
          echo "### ðŸŽ¯ Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Required Checks:** ${{ needs.all-required-checks-passed.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release Please:** ${{ needs.release-please.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Operator Image:** ${{ needs.publish-operator-image.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Chart Update:** ${{ needs.update-operator-chart.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Chart Operator:** ${{ needs.publish-chart-operator.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Chart Realm:** ${{ needs.publish-chart-realm.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Chart Client:** ${{ needs.publish-chart-client.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dev Docs:** ${{ needs.update-dev-docs.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release Docs:** ${{ needs.publish-release-docs.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if any publish job that RAN failed
          FAILED=false

          if [[ "${{ needs.all-required-checks-passed.result }}" == "failure" ]]; then
            echo "âŒ Required checks failed" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi

          if [[ "${{ needs.publish-operator-image.result }}" == "failure" ]] || \
             [[ "${{ needs.publish-chart-operator.result }}" == "failure" ]] || \
             [[ "${{ needs.publish-chart-realm.result }}" == "failure" ]] || \
             [[ "${{ needs.publish-chart-client.result }}" == "failure" ]] || \
             [[ "${{ needs.publish-release-docs.result }}" == "failure" ]] || \
             [[ "${{ needs.update-dev-docs.result }}" == "failure" ]]; then
            echo "âŒ Publishing failed" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi

          if [[ "$FAILED" == "true" ]]; then
            exit 1
          fi

          echo "âœ… Workflow completed successfully" >> $GITHUB_STEP_SUMMARY
