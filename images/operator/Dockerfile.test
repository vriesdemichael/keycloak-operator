# syntax=docker/dockerfile:1.7
# Coverage-instrumented test image for integration testing
# This extends the production Dockerfile and adds coverage collection

# ---- Stage 1: Build / Resolve deps -----------------------------------------
FROM python:3.13-slim AS builder

ENV DEBIAN_FRONTEND=noninteractive \
    UV_LINK_MODE=copy \
    VIRTUAL_ENV=/app/.venv \
    PATH=/app/.venv/bin:$PATH

RUN apt-get update && apt-get install -y --no-install-recommends \
    curl build-essential \
    && rm -rf /var/lib/apt/lists/*

# Install uv binary
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

WORKDIR /app

# Copy dependency files
COPY pyproject.toml uv.lock README.md LICENSE ./

# Install dependencies + test group (includes coverage)
RUN uv sync --frozen --group test --no-install-project || \
    (echo "If this failed because uv.lock is absent, remove --frozen or generate the lock file." && exit 1)

# Add application source
COPY src/ src/

# Install the project
RUN uv sync --frozen --group test

# ---- Stage 2: Runtime with Coverage ----------------------------------------
FROM python:3.13-slim AS runtime

ENV DEBIAN_FRONTEND=noninteractive \
    PATH=/app/.venv/bin:$PATH \
    PYTHONPATH=/app/src \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    COVERAGE_PROCESS_START=/app/.coveragerc

RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Non-root user
RUN groupadd -r keycloak --gid=1001 && \
    useradd -r -g keycloak --uid=1001 --shell=/usr/sbin/nologin --create-home keycloak

WORKDIR /app

# Copy virtual environment (includes coverage package from test group)
COPY --from=builder /app/.venv /app/.venv
COPY --from=builder /app/src /app/src
COPY --from=builder /app/pyproject.toml /app/pyproject.toml
COPY --from=builder /app/README.md /app/README.md
COPY --from=builder /app/LICENSE /app/LICENSE

# Copy coverage configuration
COPY .coveragerc /app/.coveragerc

# Copy test injection directory
COPY test-inject /app/test-inject

# Install the .pth file to auto-import sitecustomize.py at startup
RUN python - <<'PY'
import sysconfig, pathlib
sp = sysconfig.get_paths()['purelib']
pth = pathlib.Path(sp) / "test_inject.pth"
pth.write_text("/app/test-inject\n")
print(f"Created {pth}")
PY

# Create directory for coverage data files (writable by non-root user)
RUN mkdir -p /tmp/coverage && chown -R keycloak:keycloak /tmp/coverage

# Set coverage data file path (parallel mode creates .coverage.<machine>.<pid> files)
ENV COVERAGE_FILE=/tmp/coverage/.coverage

RUN chown -R keycloak:keycloak /app
USER keycloak

EXPOSE 8080

HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD python -c "import requests; requests.get('http://localhost:8080/healthz', timeout=5)" || exit 1

# Start operator with coverage instrumentation
# Using 'coverage run' ensures coverage starts BEFORE any application code is imported
CMD ["coverage", "run", "--parallel-mode", "--source=keycloak_operator", "-m", "keycloak_operator.operator"]
