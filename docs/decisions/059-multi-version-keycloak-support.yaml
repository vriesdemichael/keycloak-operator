number: 59
title: "Multi-Version Keycloak Support with Single Canonical Model"
category: architecture
decision: >
  The operator supports multiple Keycloak versions (24.x, 25.x, 26.x) using a Single Canonical Model + Adapter architecture.
  A single set of Pydantic models is generated from the latest supported Keycloak version (currently 26.5.2).
  All operator logic (Reconcilers, Admin Client, Validation) is written against this canonical model.
  Version-specific adapters handle field conversions, validation, and incompatibilities at runtime.
  This approach eliminates code duplication while providing clear error messages when using features unavailable in older versions.
agent_instructions: >
  When modifying the KeycloakAdminClient or working with Keycloak APIs:
  1. Always import models from `keycloak_operator.models.keycloak_api` (the canonical 26.5.2 models).
  2. Do NOT create version-specific model files - there is only ONE model file.
  3. For version-specific behavior, add logic to the appropriate adapter in `keycloak_operator/compatibility/adapters.py`.
  4. Use `adapter.validate_for_version(spec)` to check spec compatibility before reconciliation.
  5. Use `adapter.convert_to_keycloak(data, model_name)` to convert outbound requests.
  6. Use `adapter.convert_from_keycloak(data, model_name)` to convert inbound responses.
  7. Check `adapter.get_status_conditions()` after validation to get warnings/errors for CR status.
  8. Breaking changes between versions should be handled in adapter `_apply_outbound_conversions()` and `_apply_inbound_conversions()`.
rationale: >
  Keycloak introduces breaking changes in minor and major versions (e.g., removing fields, changing types).
  The Single Canonical Model approach provides several benefits:
  1. Type safety - All code is written against strongly-typed Pydantic models
  2. Maintainability - Only one model file to maintain, not 20+ version-specific files
  3. Clear errors - Version incompatibilities are caught early with clear error messages
  4. Reduced complexity - No need for complex model selection or conversion logic in reconcilers
  5. CI/CD simplicity - Only test against canonical version; adapters handle other versions
  The adapter pattern keeps version-specific logic isolated and testable.
rejected_alternatives:
  - alternative: "Single Version Support (Status Quo)"
    reason: "Users cannot use the operator with older supported Red Hat Build of Keycloak versions (e.g., 24.x)."
  - alternative: "Multiple Model Files (One per Version)"
    reason: "Generates 20+ model files (v24.py, v25.py, v26_0.py, v26_1.py, etc.), massive code duplication, complex import logic, and maintenance burden."
  - alternative: "Multiple Dispatch / Versioned Reconcilers"
    reason: "Writing separate reconciliation logic for every version would lead to massive code duplication and maintenance burden."
  - alternative: "Manual Model Maintenance"
    reason: "Too error-prone and labor-intensive given the size of the Keycloak API (~250 models). Automated generation is safer."
provenance: guided-ai
supersedes: 58
notes: >
  Only the canonical (latest supported) Keycloak version (26.5.2) is tested in the CI/CD pipeline.
  Support for other versions (24.x, 25.x, older 26.x) is verified through unit tests of the adapter conversions.
  Known breaking changes handled by adapters:
  - 26.4.0: Removed oAuth2DeviceCodeLifespan and oAuth2DevicePollingInterval fields
  - 26.3.0: Changed ClientPolicyCondition/Executor.configuration from list[Any] to dict[str, Any]
  - 25.x and earlier: Organizations feature not available (requires 26.0.0+)
