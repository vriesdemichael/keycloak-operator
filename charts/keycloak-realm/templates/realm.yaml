{{/* yaml-language-server: $schema=https://vriesdemichael.github.io/keycloak-operator/schemas/v1/KeycloakRealm.json */}}
apiVersion: keycloak.mdvr.nl/v1
kind: KeycloakRealm
metadata:
  name: {{ include "keycloak-realm.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "keycloak-realm.labels" . | nindent 4 }}
  {{- with include "keycloak-realm.annotations" . }}
  annotations:
    {{- . | nindent 4 }}
  {{- end }}
spec:
  realmName: {{ include "keycloak-realm.realmName" . }}

  {{- with .Values.displayName }}
  displayName: {{ . }}
  {{- end }}

  # Operator reference for authorization
  operatorRef:
    namespace: {{ required "operatorRef.namespace is required" .Values.operatorRef.namespace }}
    {{- if .Values.operatorRef.authorizationSecretRef.name }}
    authorizationSecretRef:
      name: {{ .Values.operatorRef.authorizationSecretRef.name }}
      key: {{ .Values.operatorRef.authorizationSecretRef.key | default "token" }}
    {{- end }}

  {{- with .Values.security }}
  security:
    {{- toYaml . | nindent 4 }}
  {{- end }}

  {{- if or .Values.themes.login .Values.themes.admin .Values.themes.account .Values.themes.email }}
  themes:
    {{- with .Values.themes.login }}
    login: {{ . }}
    {{- end }}
    {{- with .Values.themes.admin }}
    admin: {{ . }}
    {{- end }}
    {{- with .Values.themes.account }}
    account: {{ . }}
    {{- end }}
    {{- with .Values.themes.email }}
    email: {{ . }}
    {{- end }}
  {{- end }}

  {{- with .Values.localization }}
  localization:
    {{- toYaml . | nindent 4 }}
  {{- end }}

  {{- with .Values.tokenSettings }}
  tokenSettings:
    {{- toYaml . | nindent 4 }}
  {{- end }}

  {{- if .Values.smtpServer.enabled }}
  smtpServer:
    host: {{ required "smtpServer.host is required when smtpServer.enabled=true" .Values.smtpServer.host }}
    port: {{ .Values.smtpServer.port }}
    {{- with .Values.smtpServer.from }}
    from: {{ . }}
    {{- end }}
    {{- with .Values.smtpServer.fromDisplayName }}
    fromDisplayName: {{ . }}
    {{- end }}
    {{- with .Values.smtpServer.replyTo }}
    replyTo: {{ . }}
    {{- end }}
    {{- with .Values.smtpServer.envelopeFrom }}
    envelopeFrom: {{ . }}
    {{- end }}
    ssl: {{ .Values.smtpServer.ssl }}
    starttls: {{ .Values.smtpServer.starttls }}
    auth: {{ .Values.smtpServer.auth }}
    {{- with .Values.smtpServer.user }}
    user: {{ . }}
    {{- end }}
    {{- if .Values.smtpServer.passwordSecret.name }}
    passwordSecret:
      name: {{ .Values.smtpServer.passwordSecret.name }}
      key: {{ .Values.smtpServer.passwordSecret.key | default "password" }}
    {{- end }}
  {{- end }}

  {{- with .Values.attributes }}
  attributes:
    {{- toYaml . | nindent 4 }}
  {{- end }}
