apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: keycloakrealms.vriesdemichael.github.io
  labels:
    app.kubernetes.io/name: keycloak-operator
    app.kubernetes.io/component: crd
spec:
  group: vriesdemichael.github.io
  versions:
  - name: v1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        description: Keycloak realm configuration for comprehensive identity and access management
        properties:
          apiVersion:
            type: string
          kind:
            type: string
          metadata:
            type: object
          spec:
            type: object
            description: Specification for a Keycloak realm
            properties:
              realmName:
                type: string
                description: Realm name (must be unique in Keycloak)
                minLength: 1
                maxLength: 255
              displayName:
                type: string
                description: Human-readable realm name
              description:
                type: string
                description: Realm description
              loginPageTitle:
                type: string
                description: HTML title for login pages
              operatorRef:
                type: object
                description: Reference to the operator managing this realm
                properties:
                  namespace:
                    type: string
                    description: Namespace where the operator is running (e.g., keycloak-system)
                required:
                - namespace
              security:
                type: object
                description: Security and authentication settings
                properties:
                  registrationAllowed:
                    type: boolean
                    default: false
                  registrationEmailAsUsername:
                    type: boolean
                    default: false
                  editUsernameAllowed:
                    type: boolean
                    default: false
                  resetPasswordAllowed:
                    type: boolean
                    default: true
                  rememberMe:
                    type: boolean
                    default: false
                  verifyEmail:
                    type: boolean
                    default: false
                  loginWithEmailAllowed:
                    type: boolean
                    default: true
                  duplicateEmailsAllowed:
                    type: boolean
                    default: false
                  sslRequired:
                    type: string
                    enum:
                    - all
                    - external
                    - none
                    default: external
                  revokeRefreshToken:
                    type: boolean
                    default: false
                  refreshTokenMaxReuse:
                    type: integer
                    minimum: 0
                  bruteForceProtected:
                    type: boolean
                    default: false
                  permanentLockout:
                    type: boolean
                    default: false
                  maxFailureWait:
                    type: integer
                    minimum: 1
                  minimumQuickLoginWait:
                    type: integer
                    minimum: 1
                  waitIncrement:
                    type: integer
                    minimum: 1
                  quickLoginCheckMillis:
                    type: integer
                    minimum: 1
                  maxDeltaTime:
                    type: integer
                    minimum: 1
                  failureFactor:
                    type: integer
                    minimum: 1
              tokenSettings:
                type: object
                description: Token and session configuration
                properties:
                  accessTokenLifespan:
                    type: integer
                    minimum: 1
                    description: Access token lifespan in seconds
                  accessTokenLifespanForImplicitFlow:
                    type: integer
                    minimum: 1
                  ssoSessionIdleTimeout:
                    type: integer
                    minimum: 1
                  ssoSessionMaxLifespan:
                    type: integer
                    minimum: 1
                  offlineSessionIdleTimeout:
                    type: integer
                    minimum: 1
                  offlineSessionMaxLifespanEnabled:
                    type: boolean
                    default: false
                  offlineSessionMaxLifespan:
                    type: integer
                    minimum: 1
                  clientSessionIdleTimeout:
                    type: integer
                    minimum: 1
                  clientSessionMaxLifespan:
                    type: integer
                    minimum: 1
                  clientOfflineSessionIdleTimeout:
                    type: integer
                    minimum: 1
                  clientOfflineSessionMaxLifespan:
                    type: integer
                    minimum: 1
              themes:
                type: object
                description: Theme configuration
                properties:
                  login:
                    type: string
                    description: Login theme
                  admin:
                    type: string
                    description: Admin theme
                  account:
                    type: string
                    description: Account theme
                  email:
                    type: string
                    description: Email theme
              smtpServer:
                type: object
                description: SMTP server configuration for email. Use passwordSecret for secure credential storage.
                properties:
                  host:
                    type: string
                    description: SMTP server host
                  port:
                    type: integer
                    minimum: 1
                    maximum: 65535
                    description: SMTP server port
                  from:
                    type: string
                    description: From email address
                  fromDisplayName:
                    type: string
                    description: From display name
                  replyTo:
                    type: string
                    description: Reply-to email address
                  envelopeFrom:
                    type: string
                    description: Envelope from address
                  ssl:
                    type: boolean
                    default: false
                    description: Use SSL
                  starttls:
                    type: boolean
                    default: false
                    description: Use STARTTLS
                  auth:
                    type: boolean
                    default: false
                    description: Require authentication
                  user:
                    type: string
                    description: SMTP username
                  password:
                    type: string
                    description: SMTP password (use passwordSecret instead for better security)
                  passwordSecret:
                    type: object
                    description: Reference to Kubernetes secret containing SMTP password (recommended over password)
                    properties:
                      name:
                        type: string
                        description: Secret name
                      key:
                        type: string
                        description: Key in secret data
                        default: password
                    required:
                    - name
              localization:
                type: object
                description: Internationalization settings
                properties:
                  enabled:
                    type: boolean
                    default: false
                  supportedLocales:
                    type: array
                    items:
                      type: string
                  defaultLocale:
                    type: string
              authenticationFlows:
                type: array
                description: Custom authentication flows
                items:
                  type: object
                  properties:
                    alias:
                      type: string
                      description: Unique flow alias/name
                    description:
                      type: string
                      description: Flow description
                    providerId:
                      type: string
                      description: "Flow provider: 'basic-flow' or 'client-flow'"
                      default: basic-flow
                      enum:
                      - basic-flow
                      - client-flow
                    topLevel:
                      type: boolean
                      description: True for top-level flows, false for sub-flows
                      default: true
                    builtIn:
                      type: boolean
                      description: Whether this is a built-in flow (read-only)
                      default: false
                    copyFrom:
                      type: string
                      description: Copy from existing flow alias before applying modifications
                    authenticationExecutions:
                      type: array
                      description: Ordered list of authentication executions
                      items:
                        type: object
                        properties:
                          authenticator:
                            type: string
                            description: "Authenticator provider ID (e.g., 'auth-cookie', 'auth-otp-form')"
                          flowAlias:
                            type: string
                            description: Alias of sub-flow (when authenticatorFlow=true)
                          authenticatorFlow:
                            type: boolean
                            description: True if this execution references a sub-flow
                            default: false
                          requirement:
                            type: string
                            description: "Execution requirement: REQUIRED, ALTERNATIVE, DISABLED, CONDITIONAL"
                            enum:
                            - REQUIRED
                            - ALTERNATIVE
                            - DISABLED
                            - CONDITIONAL
                            default: DISABLED
                          priority:
                            type: integer
                            description: Execution priority (lower = earlier in flow)
                            default: 0
                          authenticatorConfig:
                            type: string
                            description: Reference to authenticator configuration alias
                          userSetupAllowed:
                            type: boolean
                            description: Allow user to set up authenticator during login
                    authenticatorConfig:
                      type: array
                      description: Configurations for configurable authenticators
                      items:
                        type: object
                        properties:
                          alias:
                            type: string
                            description: Configuration alias for reference
                          config:
                            type: object
                            description: Authenticator-specific configuration key-value pairs
                            additionalProperties:
                              type: string
                  required:
                  - alias
              # Authentication flow bindings (assign flows to realm authentication types)
              browserFlow:
                type: string
                description: Flow alias for browser authentication
              registrationFlow:
                type: string
                description: Flow alias for user registration
              directGrantFlow:
                type: string
                description: Flow alias for direct access grants (Resource Owner Password)
              resetCredentialsFlow:
                type: string
                description: Flow alias for password reset
              clientAuthenticationFlow:
                type: string
                description: Flow alias for client authentication
              dockerAuthenticationFlow:
                type: string
                description: Flow alias for Docker registry authentication
              firstBrokerLoginFlow:
                type: string
                description: Flow alias for first login via identity provider
              # Required actions configuration
              requiredActions:
                type: array
                description: "Required action configurations (e.g., CONFIGURE_TOTP, VERIFY_EMAIL)"
                items:
                  type: object
                  properties:
                    alias:
                      type: string
                      description: "Required action alias (e.g., 'CONFIGURE_TOTP', 'VERIFY_EMAIL')"
                    name:
                      type: string
                      description: Display name for the action
                    providerId:
                      type: string
                      description: Provider ID (usually same as alias)
                    enabled:
                      type: boolean
                      description: Whether this action is enabled
                      default: true
                    defaultAction:
                      type: boolean
                      description: Add to new users by default
                      default: false
                    priority:
                      type: integer
                      description: Order priority (lower = earlier)
                      default: 0
                    config:
                      type: object
                      description: Action-specific configuration
                      additionalProperties:
                        type: string
                  required:
                  - alias
              identityProviders:
                type: array
                description: Identity provider configurations
                items:
                  type: object
                  properties:
                    alias:
                      type: string
                      description: Unique identifier for this identity provider
                    displayName:
                      type: string
                      description: Display name shown in login page
                    providerId:
                      type: string
                      description: Provider type (e.g., github, google, oidc, saml)
                    enabled:
                      type: boolean
                      default: true
                    trustEmail:
                      type: boolean
                      default: false
                    storeToken:
                      type: boolean
                      default: false
                    addReadTokenRoleOnCreate:
                      type: boolean
                      default: false
                    authenticateByDefault:
                      type: boolean
                      default: false
                    linkOnly:
                      type: boolean
                      default: false
                    firstBrokerLoginFlowAlias:
                      type: string
                    postBrokerLoginFlowAlias:
                      type: string
                    config:
                      type: object
                      description: Provider-specific configuration (non-sensitive values only)
                      additionalProperties:
                        type: string
                    configSecrets:
                      type: object
                      description: Secret references for sensitive config values (e.g., clientSecret). Keys are config names, values are secret references.
                      additionalProperties:
                        type: object
                        description: Reference to Kubernetes secret containing sensitive value
                        properties:
                          name:
                            type: string
                            description: Secret name (must be in same namespace as KeycloakRealm)
                          key:
                            type: string
                            description: Key in secret data
                        required:
                        - name
                        - key
                  required:
                  - alias
                  - providerId
              userFederation:
                type: array
                description: User federation provider configurations
                items:
                  type: object
                  properties:
                    displayName:
                      type: string
                    providerName:
                      type: string
                    priority:
                      type: integer
                      minimum: 0
                    config:
                      type: object
                      additionalProperties:
                        type: string
                  required:
                  - displayName
                  - providerName
              clientScopes:
                type: array
                description: Client scope definitions
                items:
                  type: object
                  properties:
                    name:
                      type: string
                    description:
                      type: string
                    protocol:
                      type: string
                      default: openid-connect
                    attributes:
                      type: object
                      additionalProperties:
                        type: string
                    protocolMappers:
                      type: array
                      items:
                        type: object
                        properties:
                          name:
                            type: string
                          protocol:
                            type: string
                          protocolMapper:
                            type: string
                          config:
                            type: object
                            additionalProperties:
                              type: string
                        required:
                        - name
                        - protocolMapper
                  required:
                  - name
              defaultClientScopes:
                type: array
                description: Client scope names to automatically assign as default to new clients
                items:
                  type: string
              optionalClientScopes:
                type: array
                description: Client scope names available as optional for clients
                items:
                  type: string
              roles:
                type: object
                description: Realm and client role definitions
                properties:
                  realmRoles:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                        description:
                          type: string
                        composite:
                          type: boolean
                          default: false
                        clientRole:
                          type: boolean
                          default: false
                        containerId:
                          type: string
                        attributes:
                          type: object
                          description: Role attributes
                          additionalProperties:
                            type: array
                            items:
                              type: string
                        compositeRoles:
                          type: array
                          description: Names of roles to include in this composite role
                          items:
                            type: string
                      required:
                      - name
              groups:
                type: array
                description: Group definitions
                items:
                  type: object
                  properties:
                    name:
                      type: string
                    path:
                      type: string
                    attributes:
                      type: object
                      additionalProperties:
                        type: array
                        items:
                          type: string
                    realmRoles:
                      type: array
                      items:
                        type: string
                    clientRoles:
                      type: object
                      additionalProperties:
                        type: array
                        items:
                          type: string
                    subGroups:
                      type: array
                      description: Subgroups of this group
                      items:
                        type: object
                        x-kubernetes-preserve-unknown-fields: true
                  required:
                  - name
              defaultGroups:
                type: array
                description: Group names or paths to automatically assign to new users
                items:
                  type: string
              attributes:
                type: object
                description: Additional realm attributes
                additionalProperties:
                  type: string
              passwordPolicy:
                type: object
                description: Password policy configuration
                properties:
                  length:
                    type: integer
                    minimum: 1
                    description: Minimum password length
                  upperCase:
                    type: integer
                    minimum: 0
                    description: Minimum uppercase characters
                  lowerCase:
                    type: integer
                    minimum: 0
                    description: Minimum lowercase characters
                  digits:
                    type: integer
                    minimum: 0
                    description: Minimum digit characters
                  specialChars:
                    type: integer
                    minimum: 0
                    description: Minimum special characters
                  notUsername:
                    type: boolean
                    description: Password cannot equal username
                  notEmail:
                    type: boolean
                    description: Password cannot equal email
                  hashIterations:
                    type: integer
                    minimum: 1
                    description: PBKDF2 hash iterations
                  passwordHistory:
                    type: integer
                    minimum: 0
                    description: Number of previous passwords to check
                  forceExpiredPasswordChange:
                    type: integer
                    minimum: 0
                    description: Days until password expires and must be changed
                  maxLength:
                    type: integer
                    minimum: 1
                    description: Maximum password length
                  regexPattern:
                    type: string
                    description: Custom regex pattern for password validation
              eventsConfig:
                type: object
                description: Event logging configuration
                properties:
                  eventsEnabled:
                    type: boolean
                    default: false
                  eventsListeners:
                    type: array
                    items:
                      type: string
                  enabledEventTypes:
                    type: array
                    items:
                      type: string
                  eventsExpiration:
                    type: integer
                    minimum: 1
                  adminEventsEnabled:
                    type: boolean
                    default: false
                  adminEventsDetailsEnabled:
                    type: boolean
                    default: false
              clientAuthorizationGrants:
                type: array
                description: List of namespaces authorized to create clients in this realm
                items:
                  type: string
                  minLength: 1
                  maxLength: 63
            required:
            - realmName
            - operatorRef
          status:
            type: object
            description: Current status of the Keycloak realm
            properties:
              phase:
                type: string
                description: Current phase
                enum:
                - Pending
                - Provisioning
                - Ready
                - Failed
                - Updating
                - Degraded
              message:
                type: string
              reason:
                type: string
              conditions:
                type: array
                items:
                  type: object
                  properties:
                    type:
                      type: string
                    status:
                      type: string
                      enum:
                      - 'True'
                      - 'False'
                      - Unknown
                    reason:
                      type: string
                    message:
                      type: string
                    lastTransitionTime:
                      type: string
                      format: date-time
                  required:
                  - type
                  - status
              observedGeneration:
                type: integer
              realmName:
                type: string
              internalId:
                type: string
              keycloakInstance:
                type: string
              endpoints:
                type: object
                description: OIDC/OAuth2 endpoints automatically populated by the operator based on Keycloak instance URL
                properties:
                  issuer:
                    type: string
                    description: OIDC issuer identifier URL
                  auth:
                    type: string
                    description: OIDC authorization endpoint
                  token:
                    type: string
                    description: OIDC token endpoint
                  userinfo:
                    type: string
                    description: OIDC userinfo endpoint
                  jwks:
                    type: string
                    description: OIDC JSON Web Key Set (JWKS) endpoint
                  endSession:
                    type: string
                    description: OIDC end session (logout) endpoint
                  registration:
                    type: string
                    description: OIDC dynamic client registration endpoint
              features:
                type: object
                properties:
                  userRegistration:
                    type: boolean
                  passwordReset:
                    type: boolean
                  identityProviders:
                    type: integer
                  userFederationProviders:
                    type: integer
                  customThemes:
                    type: boolean
              lastHealthCheck:
                type: string
                format: date-time
              lastUpdated:
                type: string
                format: date-time
              activeUsers:
                type: integer
                minimum: 0
              totalClients:
                type: integer
                minimum: 0
              realmRolesCount:
                type: integer
                minimum: 0
              clientScopesCount:
                type: integer
                description: Number of custom client scopes configured
                minimum: 0
              authorizedClientNamespaces:
                type: array
                description: Current list of namespaces authorized to create clients
                items:
                  type: string
    additionalPrinterColumns:
    - name: Phase
      type: string
      jsonPath: .status.phase
    - name: Realm
      type: string
      jsonPath: .spec.realmName
    - name: Keycloak
      type: string
      jsonPath: .status.keycloakInstance
    - name: Users
      type: integer
      jsonPath: .status.activeUsers
    - name: Age
      type: date
      jsonPath: .metadata.creationTimestamp
  scope: Namespaced
  names:
    plural: keycloakrealms
    singular: keycloakrealm
    kind: KeycloakRealm
    shortNames:
    - kcr
