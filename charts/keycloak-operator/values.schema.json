{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "title": "Keycloak Operator Helm Chart Values",
  "description": "Configuration values for deploying the Keycloak Operator, which manages Keycloak instances and resources in Kubernetes",
  "type": "object",
  "properties": {
    "operator": {
      "type": "object",
      "description": "Operator deployment configuration including replicas, image, resources, and security settings",
      "properties": {
        "replicaCount": {
          "type": "integer",
          "description": "Number of operator replicas for high availability. Leader election ensures only one replica is active. Recommended: 2+ for production",
          "minimum": 1,
          "default": 2
        },
        "instanceId": {
          "type": "string",
          "description": "Operator instance ID for resource ownership tracking. Auto-generates '<release>-<namespace>' if empty. Used to identify which operator created resources in Keycloak.",
          "maxLength": 63,
          "pattern": "^([a-z0-9]([-a-z0-9]*[a-z0-9])?)?$"
        },
        "image": {
          "type": "object",
          "description": "Container image configuration for the operator",
          "properties": {
            "repository": {
              "type": "string",
              "description": "Container registry and repository path for the operator image",
              "examples": [
                "ghcr.io/vriesdemichael/keycloak-operator"
              ]
            },
            "pullPolicy": {
              "type": "string",
              "description": "Image pull policy. IfNotPresent (pull if not cached), Always (always pull), Never (use local only)",
              "enum": [
                "Always",
                "IfNotPresent",
                "Never"
              ],
              "default": "IfNotPresent"
            },
            "tag": {
              "type": "string",
              "description": "Image tag override. Defaults to chart appVersion if not specified",
              "pattern": "^v?[0-9]+\\.[0-9]+\\.[0-9]+(-.*)?$|^latest$|^test(-.*)?$",
              "examples": [
                "v0.3.2",
                "latest"
              ]
            }
          },
          "required": [
            "repository"
          ]
        },
        "imagePullSecrets": {
          "type": "array",
          "description": "Image pull secrets for private container registries. Required when using private registries",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string",
                "description": "Name of the secret containing registry credentials"
              }
            },
            "required": [
              "name"
            ]
          },
          "examples": [
            [
              {
                "name": "ghcr-registry-secret"
              }
            ]
          ]
        },
        "resources": {
          "type": "object",
          "description": "CPU and memory resource limits and requests. Adjust based on cluster size and number of managed Keycloak instances",
          "properties": {
            "limits": {
              "type": "object",
              "description": "Maximum resources the operator can use. Pod is killed if exceeded",
              "properties": {
                "cpu": {
                  "type": "string",
                  "description": "CPU limit (e.g., '500m' = 0.5 cores)",
                  "pattern": "^[0-9]+(m|\\.[0-9]+)?$"
                },
                "memory": {
                  "type": "string",
                  "description": "Memory limit (e.g., '512Mi', '1Gi')",
                  "pattern": "^[0-9]+(Mi|Gi|M|G)$"
                }
              }
            },
            "requests": {
              "type": "object",
              "description": "Minimum resources guaranteed for the operator. Used for scheduling decisions",
              "properties": {
                "cpu": {
                  "type": "string",
                  "description": "CPU request (e.g., '100m' = 0.1 cores)",
                  "pattern": "^[0-9]+(m|\\.[0-9]+)?$"
                },
                "memory": {
                  "type": "string",
                  "description": "Memory request (e.g., '128Mi', '1Gi')",
                  "pattern": "^[0-9]+(Mi|Gi|M|G)$"
                }
              }
            }
          }
        },
        "nodeSelector": {
          "type": "object",
          "description": "Node labels required for pod scheduling. Restricts operator pods to specific nodes",
          "additionalProperties": {
            "type": "string"
          },
          "examples": [
            {
              "kubernetes.io/os": "linux",
              "node-type": "general"
            }
          ]
        },
        "tolerations": {
          "type": "array",
          "description": "Tolerations allow pods to schedule on nodes with matching taints. Useful for control plane nodes",
          "items": {
            "type": "object",
            "properties": {
              "key": {
                "type": "string",
                "description": "Taint key to tolerate"
              },
              "operator": {
                "type": "string",
                "enum": [
                  "Exists",
                  "Equal"
                ],
                "description": "Comparison operator"
              },
              "value": {
                "type": "string",
                "description": "Taint value (if operator=Equal)"
              },
              "effect": {
                "type": "string",
                "enum": [
                  "NoSchedule",
                  "PreferNoSchedule",
                  "NoExecute"
                ],
                "description": "Taint effect"
              }
            }
          }
        },
        "affinity": {
          "type": "object",
          "description": "Pod affinity and anti-affinity rules. Used to spread replicas across nodes for high availability"
        },
        "securityContext": {
          "type": "object",
          "description": "Pod-level security context. Defines user/group IDs and security policies for the entire pod"
        },
        "containerSecurityContext": {
          "type": "object",
          "description": "Container-level security context. Defines capabilities, privilege escalation, and filesystem permissions"
        },
        "livenessProbe": {
          "type": "object",
          "description": "Liveness probe configuration. Restarts pod if health check fails. Checks /healthz endpoint",
          "properties": {
            "httpGet": {
              "type": "object",
              "properties": {
                "path": {
                  "type": "string",
                  "description": "HTTP path to check"
                },
                "port": {
                  "type": [
                    "string",
                    "integer"
                  ],
                  "description": "Port to check"
                }
              }
            },
            "initialDelaySeconds": {
              "type": "integer",
              "description": "Seconds before first check",
              "minimum": 0
            },
            "periodSeconds": {
              "type": "integer"
            },
            "timeoutSeconds": {
              "type": "integer"
            },
            "failureThreshold": {
              "type": "integer"
            }
          }
        },
        "readinessProbe": {
          "type": "object",
          "description": "Readiness probe configuration",
          "properties": {
            "httpGet": {
              "type": "object",
              "properties": {
                "path": {
                  "type": "string"
                },
                "port": {
                  "type": [
                    "string",
                    "integer"
                  ]
                }
              }
            },
            "initialDelaySeconds": {
              "type": "integer"
            },
            "periodSeconds": {
              "type": "integer"
            },
            "timeoutSeconds": {
              "type": "integer"
            },
            "failureThreshold": {
              "type": "integer"
            }
          }
        },
        "env": {
          "type": "array",
          "description": "Environment variables for operator pods",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string"
              },
              "value": {
                "type": "string"
              },
              "valueFrom": {
                "type": "object"
              }
            }
          }
        }
      }
    },
    "namespace": {
      "type": "object",
      "description": "Namespace configuration",
      "properties": {
        "name": {
          "type": "string",
          "description": "Namespace name",
          "default": "keycloak-system"
        },
        "create": {
          "type": "boolean",
          "description": "Create the namespace",
          "default": true
        },
        "podSecurityStandards": {
          "type": "object",
          "description": "Pod Security Standards labels",
          "properties": {
            "enforce": {
              "type": "string",
              "enum": [
                "privileged",
                "baseline",
                "restricted"
              ]
            },
            "audit": {
              "type": "string",
              "enum": [
                "privileged",
                "baseline",
                "restricted"
              ]
            },
            "warn": {
              "type": "string",
              "enum": [
                "privileged",
                "baseline",
                "restricted"
              ]
            }
          }
        }
      }
    },
    "serviceAccount": {
      "type": "object",
      "description": "Service account configuration",
      "properties": {
        "create": {
          "type": "boolean",
          "description": "Create service account",
          "default": true
        },
        "name": {
          "type": "string",
          "description": "Service account name"
        },
        "annotations": {
          "type": "object",
          "description": "Service account annotations",
          "additionalProperties": {
            "type": "string"
          }
        }
      }
    },
    "rbac": {
      "type": "object",
      "description": "RBAC configuration",
      "properties": {
        "create": {
          "type": "boolean",
          "description": "Create ClusterRole and ClusterRoleBinding",
          "default": true
        },
        "createLeaderElectionRole": {
          "type": "boolean",
          "description": "Create namespace-scoped Role for leader election",
          "default": true
        }
      }
    },
    "crds": {
      "type": "object",
      "description": "CRD installation configuration",
      "properties": {
        "install": {
          "type": "boolean",
          "description": "Install CRDs as part of this chart",
          "default": true
        },
        "keep": {
          "type": "boolean",
          "description": "Keep CRDs on chart uninstall",
          "default": true
        }
      }
    },
    "monitoring": {
      "type": "object",
      "description": "Monitoring and observability configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable Prometheus ServiceMonitor",
          "default": false
        },
        "namespace": {
          "type": "string",
          "description": "Namespace for monitoring resources"
        },
        "labels": {
          "type": "object",
          "description": "Additional labels for ServiceMonitor",
          "additionalProperties": {
            "type": "string"
          }
        },
        "interval": {
          "type": "string",
          "description": "Scrape interval",
          "default": "30s"
        },
        "scrapeTimeout": {
          "type": "string",
          "description": "Scrape timeout",
          "default": "10s"
        },
        "prometheusRules": {
          "type": "object",
          "description": "Prometheus alert rules configuration",
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Enable PrometheusRule resource",
              "default": false
            },
            "namespace": {
              "type": "string",
              "description": "Namespace for PrometheusRule"
            },
            "labels": {
              "type": "object",
              "description": "Labels for PrometheusRule discovery",
              "additionalProperties": {
                "type": "string"
              }
            },
            "interval": {
              "type": "string",
              "description": "Evaluation interval",
              "default": "30s"
            },
            "slowReconciliationThreshold": {
              "type": "integer",
              "description": "Threshold for slow reconciliation alert in seconds",
              "minimum": 1,
              "default": 30
            },
            "additionalRules": {
              "type": "array",
              "description": "Additional custom alert rules",
              "items": {
                "type": "object"
              }
            }
          }
        },
        "grafanaDashboard": {
          "type": "object",
          "description": "Grafana dashboard configuration",
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Enable Grafana dashboard ConfigMap",
              "default": false
            },
            "namespace": {
              "type": "string",
              "description": "Namespace for dashboard ConfigMap"
            },
            "labels": {
              "type": "object",
              "description": "Labels for dashboard discovery",
              "additionalProperties": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "keycloak": {
      "type": "object",
      "description": "Optional Keycloak instance deployment",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Deploy a Keycloak instance",
          "default": false
        },
        "name": {
          "type": "string",
          "description": "Keycloak instance name",
          "default": "keycloak"
        },
        "replicas": {
          "type": "integer",
          "description": "Number of Keycloak replicas",
          "minimum": 1,
          "default": 1
        },
        "version": {
          "type": "string",
          "description": "Keycloak version (image tag)",
          "default": "26.0.0"
        },
        "image": {
          "type": "string",
          "description": "Keycloak container image",
          "default": "quay.io/keycloak/keycloak"
        },
        "database": {
          "type": "object",
          "description": "Database configuration",
          "properties": {
            "type": {
              "type": "string",
              "description": "Database type",
              "enum": [
                "postgresql",
                "mysql",
                "mariadb",
                "oracle",
                "mssql"
              ],
              "default": "postgresql"
            },
            "host": {
              "type": "string",
              "description": "Database host"
            },
            "port": {
              "type": "integer",
              "description": "Database port",
              "default": 5432
            },
            "database": {
              "type": "string",
              "description": "Database name",
              "default": "keycloak"
            },
            "username": {
              "type": "string",
              "description": "Database username",
              "default": "keycloak"
            },
            "passwordSecret": {
              "type": "object",
              "description": "Secret containing database password",
              "properties": {
                "name": {
                  "type": "string"
                },
                "key": {
                  "type": "string",
                  "default": "password"
                }
              }
            },
            "cnpg": {
              "type": "object",
              "description": "CloudNativePG cluster configuration",
              "properties": {
                "enabled": {
                  "type": "boolean",
                  "description": "Use CloudNativePG cluster",
                  "default": false
                },
                "clusterName": {
                  "type": "string",
                  "description": "CNPG cluster name",
                  "default": "keycloak-postgres"
                },
                "instances": {
                  "type": "integer",
                  "description": "Number of PostgreSQL instances in the cluster (1 for dev, 3 for production HA)",
                  "default": 1
                },
                "storage": {
                  "type": "object",
                  "description": "Storage configuration for PostgreSQL data",
                  "properties": {
                    "size": {
                      "type": "string",
                      "description": "Size of the persistent volume for each instance",
                      "default": "1Gi"
                    },
                    "storageClass": {
                      "type": "string",
                      "description": "StorageClass to use for persistent volumes"
                    }
                  }
                },
                "postgresql": {
                  "type": "object",
                  "description": "PostgreSQL configuration parameters",
                  "properties": {
                    "maxConnections": {
                      "type": "string",
                      "description": "Maximum number of connections",
                      "default": "200"
                    },
                    "sharedBuffers": {
                      "type": "string",
                      "description": "Shared buffer size",
                      "default": "256MB"
                    }
                  },
                  "additionalProperties": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "admin": {
          "type": "object",
          "description": "Admin user configuration",
          "properties": {
            "username": {
              "type": "string",
              "description": "Admin username",
              "default": "admin"
            },
            "passwordSecret": {
              "type": "object",
              "description": "Secret containing admin password",
              "properties": {
                "name": {
                  "type": "string"
                },
                "key": {
                  "type": "string",
                  "default": "password"
                }
              }
            }
          }
        },
        "ingress": {
          "type": "object",
          "description": "Ingress configuration",
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Enable ingress",
              "default": false
            },
            "className": {
              "type": "string",
              "description": "Ingress class name"
            },
            "annotations": {
              "type": "object",
              "description": "Ingress annotations",
              "additionalProperties": {
                "type": "string"
              }
            },
            "host": {
              "type": "string",
              "description": "Ingress hostname"
            },
            "path": {
              "type": "string",
              "description": "Ingress path",
              "default": "/"
            },
            "tlsEnabled": {
              "type": "boolean",
              "description": "Enable TLS for ingress",
              "default": true
            },
            "tlsSecretName": {
              "type": "string",
              "description": "Secret containing TLS certificate"
            }
          }
        },
        "resources": {
          "type": "object",
          "description": "Resource limits and requests",
          "properties": {
            "limits": {
              "type": "object",
              "properties": {
                "cpu": {
                  "type": "string"
                },
                "memory": {
                  "type": "string"
                }
              }
            },
            "requests": {
              "type": "object",
              "properties": {
                "cpu": {
                  "type": "string"
                },
                "memory": {
                  "type": "string"
                }
              }
            }
          }
        }
      }
    },
    "extraManifests": {
      "type": "array",
      "description": "Extra Kubernetes manifests to deploy (e.g., ExternalSecrets, SealedSecrets, PVs, ConfigMaps)",
      "items": {
        "type": "object",
        "description": "A Kubernetes manifest in YAML format"
      }
    },
    "commonLabels": {
      "type": "object",
      "description": "Labels applied to all resources",
      "additionalProperties": {
        "type": "string"
      }
    },
    "commonAnnotations": {
      "type": "object",
      "description": "Annotations applied to all resources",
      "additionalProperties": {
        "type": "string"
      }
    },
    "webhooks": {
      "type": "object",
      "description": "Admission webhook configuration for resource validation",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable admission webhooks for resource validation",
          "default": true
        },
        "port": {
          "type": "integer",
          "description": "Webhook server port",
          "default": 8443,
          "minimum": 1024,
          "maximum": 65535
        },
        "timeoutSeconds": {
          "type": "integer",
          "description": "How long K8s API server waits for webhook response (seconds)",
          "default": 10,
          "minimum": 1,
          "maximum": 30
        },
        "failurePolicy": {
          "type": "string",
          "description": "Failure policy: Fail (reject on error) or Ignore (allow on error)",
          "enum": [
            "Fail",
            "Ignore"
          ],
          "default": "Fail"
        },
        "quotas": {
          "type": "object",
          "description": "Resource quotas enforced by webhooks",
          "properties": {
            "realmsPerNamespace": {
              "type": "integer",
              "description": "Maximum realms per namespace",
              "default": 10,
              "minimum": 1
            },
            "clientsPerNamespace": {
              "type": "integer",
              "description": "Maximum clients per namespace",
              "default": 50,
              "minimum": 1
            }
          },
          "required": [
            "realmsPerNamespace",
            "clientsPerNamespace"
          ]
        }
      },
      "required": [
        "enabled",
        "port",
        "timeoutSeconds",
        "failurePolicy",
        "quotas"
      ]
    },
    "podDisruptionBudget": {
      "type": "object",
      "description": "PodDisruptionBudget configuration for ensuring minimum availability during voluntary disruptions",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable PodDisruptionBudget for the operator",
          "default": true
        },
        "minAvailable": {
          "type": "integer",
          "description": "Minimum number of pods that must remain available during disruptions",
          "minimum": 0
        },
        "maxUnavailable": {
          "type": "integer",
          "description": "Maximum number of pods that can be unavailable during disruptions (alternative to minAvailable)",
          "minimum": 0
        }
      },
      "required": [
        "enabled"
      ]
    }
  }
}
