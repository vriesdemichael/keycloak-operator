{{- if .Values.serviceAccount.create }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "keycloak-operator.serviceAccountName" . }}
  namespace: {{ include "keycloak-operator.namespace" . }}
  labels:
    {{- include "keycloak-operator.labels" . | nindent 4 }}
  {{- with .Values.serviceAccount.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
automountServiceAccountToken: true
{{- end }}

{{- if .Values.rbac.create }}
---
# Minimal ClusterRole for watching CRDs across all namespaces
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "keycloak-operator.fullname" . }}-core
  labels:
    {{- include "keycloak-operator.labels" . | nindent 4 }}
  {{- with include "keycloak-operator.annotations" . }}
  annotations:
    {{- . | nindent 4 }}
  {{- end }}
rules:
# Watch CRDs cluster-wide (read-only metadata)
# Note: 'get' added for cross-namespace realm lookups in grant list validation
- apiGroups: ["vriesdemichael.github.io"]
  resources:
  - keycloaks
  - keycloakclients
  - keycloakrealms
  verbs: ["get", "list", "watch"]

# Update CRD status and finalizers (required by Kopf)
- apiGroups: ["vriesdemichael.github.io"]
  resources:
  - keycloaks/status
  - keycloakclients/status
  - keycloakrealms/status
  verbs: ["get", "update", "patch"]

- apiGroups: ["vriesdemichael.github.io"]
  resources:
  - keycloaks/finalizers
  - keycloakclients/finalizers
  - keycloakrealms/finalizers
  verbs: ["update"]

# Namespace discovery (for validation)
- apiGroups: [""]
  resources: ["namespaces"]
  verbs: ["get", "list", "watch"]

# Leader election (cluster-wide leases)
- apiGroups: ["coordination.k8s.io"]
  resources: ["leases"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]

# Events (cluster-wide)
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch"]

# Self-permission checks
- apiGroups: ["authorization.k8s.io"]
  resources: ["subjectaccessreviews"]
  verbs: ["create"]

# Kopf framework requirements (for resource watching and peering)
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["list", "watch"]

- apiGroups: ["apiextensions.k8s.io"]
  resources: ["customresourcedefinitions"]
  verbs: ["list", "watch"]

# Kopf peering for leader election (HA)
- apiGroups: ["kopf.dev"]
  resources: ["clusterkopfpeerings"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# Webhook configuration management (Kopf auto-manages webhook configs)
- apiGroups: ["admissionregistration.k8s.io"]
  resources: ["validatingwebhookconfigurations", "mutatingwebhookconfigurations"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

---
# Namespace-scoped Role for managing resources in operator's own namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "keycloak-operator.fullname" . }}-manager
  namespace: {{ include "keycloak-operator.namespace" . }}
  labels:
    {{- include "keycloak-operator.labels" . | nindent 4 }}
  {{- with include "keycloak-operator.annotations" . }}
  annotations:
    {{- . | nindent 4 }}
  {{- end }}
rules:
# CRDs in operator namespace (Keycloak instances live here)
- apiGroups: ["vriesdemichael.github.io"]
  resources:
  - keycloaks
  - keycloakclients
  - keycloakrealms
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# Kubernetes core resource management
- apiGroups: ["apps"]
  resources: ["deployments", "statefulsets", "replicasets"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

- apiGroups: ["apps"]
  resources: ["deployments/status", "statefulsets/status", "replicasets/status"]
  verbs: ["get"]

- apiGroups: [""]
  resources: ["services", "configmaps", "secrets", "persistentvolumeclaims"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

- apiGroups: [""]
  resources: ["pods", "pods/log"]
  verbs: ["get", "list", "watch"]

# Networking
- apiGroups: ["networking.k8s.io"]
  resources: ["ingresses", "networkpolicies"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# Monitoring and observability
- apiGroups: ["monitoring.coreos.com"]
  resources: ["servicemonitors"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# Certificate management
- apiGroups: ["cert-manager.io"]
  resources: ["certificates", "certificaterequests", "issuers", "clusterissuers"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# CloudNativePG (database cluster in operator namespace)
- apiGroups: ["postgresql.cnpg.io"]
  resources: ["clusters", "poolers", "backups"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# Webhook configuration
- apiGroups: ["admissionregistration.k8s.io"]
  resources: ["validatingwebhookconfigurations", "mutatingwebhookconfigurations"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# OpenShift support (optional)
- apiGroups: ["route.openshift.io"]
  resources: ["routes"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

# Kopf peering (namespace-scoped)
- apiGroups: ["kopf.dev"]
  resources: ["kopfpeerings"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

---
# Template ClusterRole for teams to grant operator access to their namespace
# Teams create a RoleBinding in their namespace referencing this ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "keycloak-operator.fullname" . }}-namespace-access
  labels:
    {{- include "keycloak-operator.labels" . | nindent 4 }}
    app.kubernetes.io/component: rbac-template
  {{- with include "keycloak-operator.annotations" . }}
  annotations:
    {{- . | nindent 4 }}
  {{- end }}
rules:
# Read, patch, and delete CRDs in delegated namespaces (realms and clients)
# Note: patch is required for Kopf to update status via strategic merge patch
# Note: delete is required for cascading deletion (realm deletes dependent clients)
- apiGroups: ["vriesdemichael.github.io"]
  resources:
  - keycloakclients
  - keycloakrealms
  verbs: ["get", "list", "watch", "patch", "delete"]

# Update CRD status and finalizers in delegated namespaces
- apiGroups: ["vriesdemichael.github.io"]
  resources:
  - keycloakclients/status
  - keycloakrealms/status
  verbs: ["get", "update", "patch"]

- apiGroups: ["vriesdemichael.github.io"]
  resources:
  - keycloakclients/finalizers
  - keycloakrealms/finalizers
  verbs: ["update"]

# Read and create labeled secrets only (validation enforced in code)
# Label required: vriesdemichael.github.io/keycloak-allow-operator-read=true
# Create permission needed for realm authorization secrets
# Update/patch permission needed for client credentials
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "create", "update", "patch"]

# Read and delete configmaps for realm cleanup
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list", "delete"]

# Create events for status reporting
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch"]

---
# ClusterRoleBinding for minimal cluster-wide permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "keycloak-operator.fullname" . }}-core
  labels:
    {{- include "keycloak-operator.labels" . | nindent 4 }}
  {{- with include "keycloak-operator.annotations" . }}
  annotations:
    {{- . | nindent 4 }}
  {{- end }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ include "keycloak-operator.fullname" . }}-core
subjects:
- kind: ServiceAccount
  name: {{ include "keycloak-operator.serviceAccountName" . }}
  namespace: {{ include "keycloak-operator.namespace" . }}

---
# RoleBinding for namespace-scoped permissions in operator namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "keycloak-operator.fullname" . }}-manager
  namespace: {{ include "keycloak-operator.namespace" . }}
  labels:
    {{- include "keycloak-operator.labels" . | nindent 4 }}
  {{- with include "keycloak-operator.annotations" . }}
  annotations:
    {{- . | nindent 4 }}
  {{- end }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ include "keycloak-operator.fullname" . }}-manager
subjects:
- kind: ServiceAccount
  name: {{ include "keycloak-operator.serviceAccountName" . }}
  namespace: {{ include "keycloak-operator.namespace" . }}
{{- end }}
