{{- if and (not .Values.keycloak.managed) (or (not .Values.keycloak.url) (not .Values.keycloak.adminSecret)) -}}
{{- fail "When managed mode is disabled (keycloak.managed=false), both keycloak.url and keycloak.adminSecret must be set." -}}
{{- end -}}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "keycloak-operator.fullname" . }}
  namespace: {{ include "keycloak-operator.namespace" . }}
  labels:
    {{- include "keycloak-operator.labels" . | nindent 4 }}
  annotations:
    {{- with include "keycloak-operator.annotations" . }}
    {{- . | nindent 4 }}
    {{- end }}
    # ArgoCD sync wave: Deploy operator before application resources
    argocd.argoproj.io/sync-wave: "0"
spec:
  replicas: {{ .Values.operator.replicaCount }}
  selector:
    matchLabels:
      {{- include "keycloak-operator.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "keycloak-operator.selectorLabels" . | nindent 8 }}
        {{- with .Values.commonLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- with include "keycloak-operator.annotations" . }}
      annotations:
        {{- . | nindent 8 }}
      {{- end }}
    spec:
      serviceAccountName: {{ include "keycloak-operator.serviceAccountName" . }}
      {{- with .Values.operator.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      securityContext:
        {{- toYaml .Values.operator.securityContext | nindent 8 }}
      containers:
      - name: operator
        image: {{ include "keycloak-operator.image" . }}
        imagePullPolicy: {{ .Values.operator.image.pullPolicy }}
        ports:
        - containerPort: 8080
          name: http
          protocol: TCP
        - containerPort: {{ .Values.operator.metrics.port }}
          name: metrics
          protocol: TCP
        {{- if .Values.webhooks.enabled }}
        - containerPort: {{ .Values.webhooks.port }}
          name: webhook
          protocol: TCP
        {{- end }}
        env:
        - name: KOPF_STANDALONE
          value: "false"
        - name: KOPF_PEERING_NAME
          value: {{ include "keycloak-operator.fullname" . }}
        - name: KOPF_PRIORITY
          value: "100"
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: SERVICE_ACCOUNT_NAME
          value: {{ include "keycloak-operator.serviceAccountName" . }}
        - name: OPERATOR_NAME
          value: {{ include "keycloak-operator.fullname" . }}
        - name: OPERATOR_NAMESPACE
          value: {{ include "keycloak-operator.namespace" . }}
        - name: OPERATOR_INSTANCE_ID
          value: {{ include "keycloak-operator.instanceId" . }}
        - name: KEYCLOAK_OPERATOR_NAMESPACES
          value: {{ .Values.operator.watchNamespaces | quote }}
        - name: DRY_RUN
          value: {{ .Values.operator.dryRun | quote }}
        - name: LOG_LEVEL
          value: {{ .Values.operator.logging.level | quote }}
        - name: JSON_LOGS
          value: {{ .Values.operator.logging.json | quote }}
        - name: CORRELATION_IDS
          value: {{ .Values.operator.logging.correlationIds | quote }}
        - name: LOG_HEALTH_PROBES
          value: {{ .Values.operator.logging.logHealthProbes | quote }}
        - name: WEBHOOK_LOG_LEVEL
          value: {{ .Values.operator.logging.webhookLogLevel | quote }}
        - name: HANDLER_ENTRY_LOG_LEVEL
          value: {{ .Values.operator.logging.handlerEntryLogLevel | quote }}
        - name: METRICS_PORT
          value: {{ .Values.operator.metrics.port | quote }}
        - name: METRICS_HOST
          value: {{ .Values.operator.metrics.host | quote }}
        - name: KEYCLOAK_API_GLOBAL_RATE_LIMIT_TPS
          value: {{ .Values.operator.rateLimiting.global.tps | quote }}
        - name: KEYCLOAK_API_GLOBAL_BURST
          value: {{ .Values.operator.rateLimiting.global.burst | quote }}
        - name: KEYCLOAK_API_NAMESPACE_RATE_LIMIT_TPS
          value: {{ .Values.operator.rateLimiting.namespace.tps | quote }}
        - name: KEYCLOAK_API_NAMESPACE_BURST
          value: {{ .Values.operator.rateLimiting.namespace.burst | quote }}
        - name: KEYCLOAK_API_CIRCUIT_BREAKER_ENABLED
          value: {{ .Values.operator.circuitBreaker.enabled | quote }}
        - name: KEYCLOAK_API_CIRCUIT_BREAKER_FAILURE_THRESHOLD
          value: {{ .Values.operator.circuitBreaker.failureThreshold | quote }}
        - name: KEYCLOAK_API_CIRCUIT_BREAKER_RECOVERY_TIMEOUT
          value: {{ .Values.operator.circuitBreaker.recoveryTimeout | quote }}
        - name: KEYCLOAK_API_TIMEOUT_SECONDS
          value: {{ .Values.operator.circuitBreaker.apiTimeout | quote }}
        - name: RECONCILE_JITTER_MAX_SECONDS
          value: {{ .Values.operator.reconciliation.jitterMaxSeconds | quote }}
        - name: DRIFT_DETECTION_ENABLED
          value: {{ .Values.monitoring.driftDetection.enabled | quote }}
        - name: DRIFT_DETECTION_INTERVAL_SECONDS
          value: {{ .Values.monitoring.driftDetection.intervalSeconds | quote }}
        - name: DRIFT_DETECTION_AUTO_REMEDIATE
          value: {{ .Values.monitoring.driftDetection.autoRemediate | quote }}
        - name: DRIFT_DETECTION_MINIMUM_AGE_HOURS
          value: {{ .Values.monitoring.driftDetection.minimumAgeHours | quote }}
        - name: DRIFT_DETECTION_SCOPE_REALMS
          value: {{ .Values.monitoring.driftDetection.scope.realms | quote }}
        - name: DRIFT_DETECTION_SCOPE_CLIENTS
          value: {{ .Values.monitoring.driftDetection.scope.clients | quote }}
        - name: DRIFT_DETECTION_SCOPE_IDENTITY_PROVIDERS
          value: {{ .Values.monitoring.driftDetection.scope.identityProviders | quote }}
        - name: DRIFT_DETECTION_SCOPE_ROLES
          value: {{ .Values.monitoring.driftDetection.scope.roles | quote }}
        # Timer intervals for health checks and stuck finalizer detection
        - name: TIMER_INTERVAL_KEYCLOAK
          value: {{ .Values.operator.reconciliation.timerIntervals.keycloak | quote }}
        - name: TIMER_INTERVAL_REALM
          value: {{ .Values.operator.reconciliation.timerIntervals.realm | quote }}
        - name: TIMER_INTERVAL_CLIENT
          value: {{ .Values.operator.reconciliation.timerIntervals.client | quote }}
        {{- if .Values.webhooks.enabled }}
        - name: ENABLE_WEBHOOKS
          value: "true"
        - name: WEBHOOK_PORT
          value: {{ .Values.webhooks.port | quote }}
        - name: WEBHOOK_MAX_REALMS_PER_NAMESPACE
          value: {{ .Values.webhooks.quotas.realmsPerNamespace | quote }}
        - name: WEBHOOK_MAX_CLIENTS_PER_NAMESPACE
          value: {{ .Values.webhooks.quotas.clientsPerNamespace | quote }}
        {{- else }}
        - name: ENABLE_WEBHOOKS
          value: "false"
        {{- end }}
        - name: KEYCLOAK_ALLOW_SCRIPT_MAPPERS
          value: {{ .Values.operator.security.allowScriptMappers | quote }}
        - name: KEYCLOAK_ALLOW_IMPERSONATION
          value: {{ .Values.operator.security.allowImpersonation | quote }}
        - name: KEYCLOAK_URL
          {{- if .Values.keycloak.url }}
          value: {{ .Values.keycloak.url | quote }}
          {{- else if .Values.keycloak.managed }}
          value: "http://{{ .Values.keycloak.name }}-keycloak.{{ include "keycloak-operator.namespace" . }}.svc.cluster.local:8080"
          {{- else }}
          value: ""
          {{- end }}
        - name: KEYCLOAK_ADMIN_SECRET
          {{- if .Values.keycloak.adminSecret }}
          value: {{ .Values.keycloak.adminSecret | quote }}
          {{- else if .Values.keycloak.managed }}
          value: "{{ .Values.keycloak.name }}-admin-credentials"
          {{- else }}
          value: "keycloak-admin-credentials"
          {{- end }}
        - name: KEYCLOAK_ADMIN_USERNAME
          value: {{ .Values.keycloak.adminUsername | quote }}
        - name: KEYCLOAK_ADMIN_PASSWORD_KEY
          value: {{ .Values.keycloak.adminPasswordKey | quote }}
        # OpenTelemetry tracing configuration
        - name: OTEL_TRACING_ENABLED
          value: {{ .Values.operator.tracing.enabled | quote }}
        {{- if .Values.operator.tracing.enabled }}
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: {{ .Values.operator.tracing.endpoint | quote }}
        - name: OTEL_SERVICE_NAME
          value: {{ .Values.operator.tracing.serviceName | quote }}
        - name: OTEL_SAMPLE_RATE
          value: {{ .Values.operator.tracing.sampleRate | quote }}
        - name: OTEL_EXPORTER_OTLP_INSECURE
          value: {{ .Values.operator.tracing.insecure | quote }}
        - name: OTEL_PROPAGATE_TO_KEYCLOAK
          value: {{ .Values.operator.tracing.propagateToKeycloak | quote }}
        {{- end }}
        {{- with .Values.operator.env }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        resources:
          {{- toYaml .Values.operator.resources | nindent 10 }}
        livenessProbe:
          {{- toYaml .Values.operator.livenessProbe | nindent 10 }}
        {{- if .Values.webhooks.enabled }}
        # When webhooks are enabled, check both health endpoint and webhook port
        readinessProbe:
          httpGet:
            path: /ready
            port: {{ .Values.operator.metrics.port }}
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        {{- else }}
        readinessProbe:
          {{- toYaml .Values.operator.readinessProbe | nindent 10 }}
        {{- end }}
        securityContext:
          {{- toYaml .Values.operator.containerSecurityContext | nindent 10 }}
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        {{- if .Values.webhooks.enabled }}
        - name: webhook-certs
          mountPath: /tmp/k8s-webhook-server/serving-certs
          readOnly: true
        {{- end }}
      volumes:
      - name: tmp
        emptyDir: {}
      {{- if .Values.webhooks.enabled }}
      - name: webhook-certs
        secret:
          secretName: {{ include "keycloak-operator.fullname" . }}-webhook-tls
          defaultMode: 420
      {{- end }}
      terminationGracePeriodSeconds: 30
      {{- with .Values.operator.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.operator.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.operator.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if .Values.priorityClass.create }}
      priorityClassName: {{ .Values.priorityClass.name | default (include "keycloak-operator.fullname" .) }}
      {{- else if .Values.priorityClass.name }}
      priorityClassName: {{ .Values.priorityClass.name }}
      {{- end }}
