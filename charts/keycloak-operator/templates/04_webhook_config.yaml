{{- if .Values.webhooks.enabled }}
---
# ValidatingWebhookConfiguration for KeycloakRealm
# Validates realm resources before admission to enforce quotas and constraints
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: {{ include "keycloak-operator.fullname" . }}-realms
  labels:
    {{- include "keycloak-operator.labels" . | nindent 4 }}
    app.kubernetes.io/component: webhook
  {{- with include "keycloak-operator.annotations" . }}
  annotations:
    {{- . | nindent 4 }}
  {{- end }}
webhooks:
- name: validate.keycloakrealm.vriesdemichael.github.io
  admissionReviewVersions:
  - v1
  clientConfig:
    service:
      name: {{ include "keycloak-operator.fullname" . }}-webhook
      namespace: {{ include "keycloak-operator.namespace" . }}
      path: /validate-vriesdemichael-github-io-v1-keycloakrealm
      port: 443
    # CA bundle will be injected by Kopf automatically
    caBundle: ""
  failurePolicy: {{ .Values.webhooks.failurePolicy }}
  matchPolicy: Equivalent
  namespaceSelector: {}
  objectSelector: {}
  rules:
  - apiGroups:
    - vriesdemichael.github.io
    apiVersions:
    - v1
    operations:
    - CREATE
    - UPDATE
    resources:
    - keycloakrealms
    scope: '*'
  sideEffects: None
  timeoutSeconds: {{ .Values.webhooks.timeoutSeconds }}
---
# ValidatingWebhookConfiguration for KeycloakClient
# Validates client resources before admission to enforce quotas and constraints
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: {{ include "keycloak-operator.fullname" . }}-clients
  labels:
    {{- include "keycloak-operator.labels" . | nindent 4 }}
    app.kubernetes.io/component: webhook
  {{- with include "keycloak-operator.annotations" . }}
  annotations:
    {{- . | nindent 4 }}
  {{- end }}
webhooks:
- name: validate.keycloakclient.vriesdemichael.github.io
  admissionReviewVersions:
  - v1
  clientConfig:
    service:
      name: {{ include "keycloak-operator.fullname" . }}-webhook
      namespace: {{ include "keycloak-operator.namespace" . }}
      path: /validate-vriesdemichael-github-io-v1-keycloakclient
      port: 443
    caBundle: ""
  failurePolicy: {{ .Values.webhooks.failurePolicy }}
  matchPolicy: Equivalent
  namespaceSelector: {}
  objectSelector: {}
  rules:
  - apiGroups:
    - vriesdemichael.github.io
    apiVersions:
    - v1
    operations:
    - CREATE
    - UPDATE
    resources:
    - keycloakclients
    scope: '*'
  sideEffects: None
  timeoutSeconds: {{ .Values.webhooks.timeoutSeconds }}
---
# ValidatingWebhookConfiguration for Keycloak
# Validates Keycloak instance resources before admission
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: {{ include "keycloak-operator.fullname" . }}-keycloaks
  labels:
    {{- include "keycloak-operator.labels" . | nindent 4 }}
    app.kubernetes.io/component: webhook
  {{- with include "keycloak-operator.annotations" . }}
  annotations:
    {{- . | nindent 4 }}
  {{- end }}
webhooks:
- name: validate.keycloak.vriesdemichael.github.io
  admissionReviewVersions:
  - v1
  clientConfig:
    service:
      name: {{ include "keycloak-operator.fullname" . }}-webhook
      namespace: {{ include "keycloak-operator.namespace" . }}
      path: /validate-vriesdemichael-github-io-v1-keycloak
      port: 443
    caBundle: ""
  failurePolicy: {{ .Values.webhooks.failurePolicy }}
  matchPolicy: Equivalent
  namespaceSelector: {}
  objectSelector: {}
  rules:
  - apiGroups:
    - vriesdemichael.github.io
    apiVersions:
    - v1
    operations:
    - CREATE
    - UPDATE
    resources:
    - keycloaks
    scope: '*'
  sideEffects: None
  timeoutSeconds: {{ .Values.webhooks.timeoutSeconds }}
{{- end }}
