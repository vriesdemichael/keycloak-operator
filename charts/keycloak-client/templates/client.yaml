{{/* yaml-language-server: $schema=https://vriesdemichael.github.io/keycloak-operator/schemas/v1/KeycloakClient.json */}}
apiVersion: vriesdemichael.github.io/v1
kind: KeycloakClient
metadata:
  name: {{ include "keycloak-client.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "keycloak-client.labels" . | nindent 4 }}
  {{- with include "keycloak-client.annotations" . }}
  annotations:
    {{- . | nindent 4 }}
  {{- end }}

spec:
  realmRef:
    name: {{ .Values.realmRef.name }}
    namespace: {{ .Values.realmRef.namespace | default .Release.Namespace }}
  clientId: {{ .Values.clientId }}

  {{- with .Values.postLogoutRedirectUris }}
  postLogoutRedirectUris:
    {{- toYaml . | nindent 4 }}
  {{- end }}

  {{- with .Values.baseUrl }}
  baseUrl: {{ . }}
  {{- end }}

  {{- with .Values.rootUrl }}
  rootUrl: {{ . }}
  {{- end }}

  {{- with .Values.adminUrl }}
  adminUrl: {{ . }}
  {{- end }}

  # Client settings - map all settings to CRD structure
  settings:
    clientAuthenticatorType: {{ .Values.clientAuthenticatorType }}
    standardFlowEnabled: {{ .Values.standardFlowEnabled }}
    implicitFlowEnabled: {{ .Values.implicitFlowEnabled }}
    directAccessGrantsEnabled: {{ .Values.directAccessGrantsEnabled }}
    serviceAccountsEnabled: {{ .Values.serviceAccountsEnabled }}
    authorizationServicesEnabled: {{ .Values.authorizationServicesEnabled }}
    consentRequired: {{ .Values.consentRequired }}
    displayOnConsentScreen: {{ .Values.displayOnConsentScreen }}
    frontchannelLogout: {{ .Values.frontchannelLogout }}
    alwaysDisplayInConsole: {{ .Values.alwaysDisplayInConsole }}
    fullScopeAllowed: {{ .Values.fullScopeAllowed }}
    includeInTokenScope: {{ .Values.includeInTokenScope }}

    {{- with .Values.settings.pkceCodeChallengeMethod }}
    pkceCodeChallengeMethod: {{ . }}
    {{- end }}

    {{- if .Values.settings.accessTokenLifespan }}
    accessTokenLifespan: {{ .Values.settings.accessTokenLifespan }}
    {{- end }}

    {{- if .Values.settings.clientSessionIdleTimeout }}
    clientSessionIdleTimeout: {{ .Values.settings.clientSessionIdleTimeout }}
    {{- end }}

    {{- if .Values.settings.clientSessionMaxLifespan }}
    clientSessionMaxLifespan: {{ .Values.settings.clientSessionMaxLifespan }}
    {{- end }}

  {{- with .Values.defaultClientScopes }}
  defaultClientScopes:
    {{- toYaml . | nindent 4 }}
  {{- end }}

  {{- with .Values.optionalClientScopes }}
  optionalClientScopes:
    {{- toYaml . | nindent 4 }}
  {{- end }}

  {{- if or .Values.serviceAccountRoles.realmRoles .Values.serviceAccountRoles.clientRoles }}
  serviceAccountRoles:
    {{- with .Values.serviceAccountRoles.realmRoles }}
    realmRoles:
      {{- toYaml . | nindent 6 }}
    {{- end }}
    {{- with .Values.serviceAccountRoles.clientRoles }}
    clientRoles:
      {{- toYaml . | nindent 6 }}
    {{- end }}
  {{- end }}

  {{- with .Values.protocolMappers }}
  protocolMappers:
    {{- toYaml . | nindent 4 }}
  {{- end }}

  {{- if or .Values.authenticationFlow.browserFlow .Values.authenticationFlow.directGrantFlow .Values.authenticationFlow.clientAuthenticationFlow }}
  authenticationFlow:
    {{- with .Values.authenticationFlow.browserFlow }}
    browserFlow: {{ . }}
    {{- end }}
    {{- with .Values.authenticationFlow.directGrantFlow }}
    directGrantFlow: {{ . }}
    {{- end }}
    {{- with .Values.authenticationFlow.clientAuthenticationFlow }}
    clientAuthenticationFlow: {{ . }}
    {{- end }}
  {{- end }}

  {{- if not .Values.publicClient }}
  # Secret management (for confidential clients)
  manageSecret: {{ .Values.manageSecret }}
  {{- if .Values.secretName }}
  secretName: {{ .Values.secretName }}
  {{- end }}
  {{- with .Values.secretMetadata }}
  secretMetadata:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- if and .Values.clientSecret .Values.clientSecret.name }}
  clientSecret:
    name: {{ .Values.clientSecret.name }}
    key: {{ .Values.clientSecret.key | default "client-secret" }}
  {{- end }}
  regenerateSecret: {{ .Values.regenerateSecret }}
  {{- if not (and .Values.clientSecret .Values.clientSecret.name) }}
  secretRotation:
    enabled: {{ .Values.secretRotation.enabled }}
    rotationPeriod: {{ .Values.secretRotation.rotationPeriod | quote }}
    {{- with .Values.secretRotation.rotationTime }}
    rotationTime: {{ . | quote }}
    {{- end }}
    timezone: {{ .Values.secretRotation.timezone | quote }}
  {{- end }}

  {{- end }}
