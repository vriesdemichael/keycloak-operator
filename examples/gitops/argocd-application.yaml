# yaml-language-server: $schema=https://raw.githubusercontent.com/argoproj/argo-schema-generator/main/schema/application_v1alpha1.json
# ArgoCD Application - Keycloak Operator Resources
#
# This ArgoCD Application manages Keycloak realms and clients using GitOps principles.
# It demonstrates best practices for deploying Keycloak resources with ArgoCD.
#
# Features:
# - Automatic sync from Git repository
# - Health checks for custom resources
# - Sync waves for proper ordering (realms before clients)
# - Self-healing and pruning
#
# Prerequisites:
# - ArgoCD installed and configured
# - Keycloak operator installed in cluster
# - Keycloak instance ready
# - Git repository with Keycloak manifests
#
# Usage:
# 1. Update repoURL to your Git repository
# 2. Update path to your manifests directory
# 3. Apply this Application to ArgoCD: kubectl apply -f argocd-application.yaml -n argocd
#
# Operator Compatibility: v1+
# ArgoCD Version: 2.8+
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: keycloak-resources
  namespace: argocd
  # Finalizer ensures ArgoCD deletes resources when Application is deleted
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  # Project to organize applications
  project: default

  # Source repository
  source:
    repoURL: https://github.com/your-org/your-repo.git
    targetRevision: main
    path: k8s/keycloak

    # Directory plugin configuration
    directory:
      recurse: true
      # Exclude files if needed
      exclude: '*.md'

  # Destination cluster
  destination:
    server: https://kubernetes.default.svc
    namespace: production

  # Sync policy
  syncPolicy:
    automated:
      # Automatically sync when Git changes
      prune: true
      # Automatically sync when cluster state drifts
      selfHeal: true
      # Allow empty directories
      allowEmpty: false

    # Sync options
    syncOptions:
      # Create namespace if it doesn't exist
      - CreateNamespace=true
      # Validate resources before applying
      - Validate=true
      # Use server-side apply (recommended)
      - ServerSideApply=true
      # Replace resources if immutable field changes
      - Replace=true

    # Retry policy for failed syncs
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m

  # Ignore differences (if needed)
  ignoreDifferences:
    # Ignore status fields (managed by operator)
    - group: vriesdemichael.github.io
      kind: KeycloakRealm
      jsonPointers:
        - /status
    - group: vriesdemichael.github.io
      kind: KeycloakClient
      jsonPointers:
        - /status

  # Health assessment
  # ArgoCD will use these to determine if resources are healthy
  # Note: Custom health checks may be needed for CRDs
  # See: https://argo-cd.readthedocs.io/en/stable/operator-manual/health/

---
# Custom Health Check for KeycloakRealm
#
# Add this to your ArgoCD ConfigMap (argocd-cm) to enable health checks
# for KeycloakRealm resources:
#
# apiVersion: v1
# kind: ConfigMap
# metadata:
#   name: argocd-cm
#   namespace: argocd
# data:
#   resource.customizations.health.vriesdemichael.github.io_KeycloakRealm: |
#     hs = {}
#     if obj.status ~= nil then
#       if obj.status.conditions ~= nil then
#         for i, condition in ipairs(obj.status.conditions) do
#           if condition.type == "Ready" and condition.status == "True" then
#             hs.status = "Healthy"
#             hs.message = "Realm is ready"
#             return hs
#           elseif condition.type == "Ready" and condition.status == "False" then
#             hs.status = "Degraded"
#             hs.message = condition.message
#             return hs
#           end
#         end
#       end
#     end
#     hs.status = "Progressing"
#     hs.message = "Waiting for realm to be ready"
#     return hs
#
#   resource.customizations.health.vriesdemichael.github.io_KeycloakClient: |
#     hs = {}
#     if obj.status ~= nil then
#       if obj.status.conditions ~= nil then
#         for i, condition in ipairs(obj.status.conditions) do
#           if condition.type == "Ready" and condition.status == "True" then
#             hs.status = "Healthy"
#             hs.message = "Client is ready"
#             return hs
#           elseif condition.type == "Ready" and condition.status == "False" then
#             hs.status = "Degraded"
#             hs.message = condition.message
#             return hs
#           end
#         end
#       end
#     end
#     hs.status = "Progressing"
#     hs.message = "Waiting for client to be ready"
#     return hs

---
# Alternative: AppProject for Keycloak resources
#
# Create a dedicated AppProject for better organization and access control
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: keycloak
  namespace: argocd
spec:
  description: Keycloak identity and access management

  # Source repositories allowed for this project
  sourceRepos:
    - 'https://github.com/your-org/*'

  # Destinations allowed for this project
  destinations:
    - namespace: 'production'
      server: https://kubernetes.default.svc
    - namespace: 'staging'
      server: https://kubernetes.default.svc
    - namespace: 'development'
      server: https://kubernetes.default.svc

  # Cluster resource allowlist
  clusterResourceWhitelist:
    - group: ''
      kind: Namespace

  # Namespace resource allowlist
  namespaceResourceWhitelist:
    - group: 'vriesdemichael.github.io'
      kind: KeycloakRealm
    - group: 'vriesdemichael.github.io'
      kind: KeycloakClient
    - group: ''
      kind: Secret
    - group: ''
      kind: ConfigMap

---
# Example: Multi-environment Applications
#
# Deploy same resources to multiple environments with different configurations
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: keycloak-dev
  namespace: argocd
spec:
  project: keycloak
  source:
    repoURL: https://github.com/your-org/your-repo.git
    targetRevision: main
    path: k8s/keycloak/overlays/dev
  destination:
    server: https://kubernetes.default.svc
    namespace: development
  syncPolicy:
    automated:
      prune: true
      selfHeal: true

---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: keycloak-staging
  namespace: argocd
spec:
  project: keycloak
  source:
    repoURL: https://github.com/your-org/your-repo.git
    targetRevision: main
    path: k8s/keycloak/overlays/staging
  destination:
    server: https://kubernetes.default.svc
    namespace: staging
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      # Require manual approval for production changes
      - ApprovalRequired=true

---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: keycloak-production
  namespace: argocd
spec:
  project: keycloak
  source:
    repoURL: https://github.com/your-org/your-repo.git
    targetRevision: production
    path: k8s/keycloak/overlays/production
  destination:
    server: https://kubernetes.default.svc
    namespace: production
  syncPolicy:
    # Manual sync for production
    automated: null
    syncOptions:
      - CreateNamespace=true
      - Validate=true
    retry:
      limit: 3
      backoff:
        duration: 10s
        factor: 2
        maxDuration: 5m
