
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="GitOps-compatible Keycloak Kubernetes operator">
      
      
      
        <link rel="canonical" href="https://vriesdemichael.github.io/keycloak-operator/dev/architecture/">
      
      
        <link rel="prev" href="../quickstart/">
      
      
        <link rel="next" href="../security/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>Architecture - Keycloak Operator</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e53b48f4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="deep-purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#architecture" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Keycloak Operator" class="md-header__button md-logo" aria-label="Keycloak Operator" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Keycloak Operator
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Architecture
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="deep-purple"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="deep-purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/vriesdemichael/keycloak-operator" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    vriesdemichael/keycloak-operator
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../quickstart/" class="md-tabs__link">
        
  
  
    
  
  Quick Start

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="./" class="md-tabs__link">
        
  
  
    
  
  Architecture

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../security/" class="md-tabs__link">
        
  
  
    
  
  Security Model

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../identity-providers/" class="md-tabs__link">
          
  
  
  Configuration

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../how-to/end-to-end-setup/" class="md-tabs__link">
          
  
  
  How-To Guides

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../operations/token-management/" class="md-tabs__link">
          
  
  
  Operations

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../reference/keycloak-crd/" class="md-tabs__link">
          
  
  
  Reference

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../observability/" class="md-tabs__link">
        
  
  
    
  
  Observability

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../development/" class="md-tabs__link">
          
  
  
  Development

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../decisions/generated-markdown/001-kopf-as-operator-framework/" class="md-tabs__link">
        
  
  
    
  
  Decision Records

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../faq/" class="md-tabs__link">
        
  
  
    
  
  FAQ

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../api/keycloak_operator/" class="md-tabs__link">
          
  
  
  API Reference

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Keycloak Operator" class="md-nav__button md-logo" aria-label="Keycloak Operator" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Keycloak Operator
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/vriesdemichael/keycloak-operator" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    vriesdemichael/keycloak-operator
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quick Start
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#high-level-components" class="md-nav__link">
    <span class="md-ellipsis">
      High-Level Components
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#token-system-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Token System Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Token System Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#token-types" class="md-nav__link">
    <span class="md-ellipsis">
      Token Types
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token-lifecycle" class="md-nav__link">
    <span class="md-ellipsis">
      Token Lifecycle
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#single-tenant-vs-multi-tenant" class="md-nav__link">
    <span class="md-ellipsis">
      Single-Tenant vs Multi-Tenant
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Single-Tenant vs Multi-Tenant">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-tenant-development-mode" class="md-nav__link">
    <span class="md-ellipsis">
      Single-Tenant / Development Mode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-tenant-production-mode" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Tenant / Production Mode
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token-discovery-mechanism" class="md-nav__link">
    <span class="md-ellipsis">
      Token Discovery Mechanism
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Security Considerations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token-rotation-lifecycle" class="md-nav__link">
    <span class="md-ellipsis">
      Token Rotation Lifecycle
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reconciliation-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Reconciliation Flow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-modules" class="md-nav__link">
    <span class="md-ellipsis">
      Key Modules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scaling-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Scaling Strategy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Scaling Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#two-types-of-scaling" class="md-nav__link">
    <span class="md-ellipsis">
      Two Types of Scaling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Two Types of Scaling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-operator-scaling-reconciliation" class="md-nav__link">
    <span class="md-ellipsis">
      1. Operator Scaling (Reconciliation)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-keycloak-instance-scaling-end-user-traffic" class="md-nav__link">
    <span class="md-ellipsis">
      2. Keycloak Instance Scaling (End-User Traffic)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#where-bottlenecks-occur" class="md-nav__link">
    <span class="md-ellipsis">
      Where Bottlenecks Occur
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-to-scale-what" class="md-nav__link">
    <span class="md-ellipsis">
      When to Scale What
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-operator-deployment-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Operator Deployment Pattern
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recommended-approach" class="md-nav__link">
    <span class="md-ellipsis">
      Recommended Approach
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-misconception" class="md-nav__link">
    <span class="md-ellipsis">
      Common Misconception
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rate-limiting-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Rate Limiting Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Rate Limiting Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rate-limiting-layers-explained" class="md-nav__link">
    <span class="md-ellipsis">
      Rate Limiting Layers Explained
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Rate Limiting Layers Explained">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#layer-3-jitter-reconciliation-start" class="md-nav__link">
    <span class="md-ellipsis">
      Layer 3: Jitter (Reconciliation Start)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#layer-2-per-namespace-rate-limiting" class="md-nav__link">
    <span class="md-ellipsis">
      Layer 2: Per-Namespace Rate Limiting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#layer-1-global-rate-limiting" class="md-nav__link">
    <span class="md-ellipsis">
      Layer 1: Global Rate Limiting
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protection-scenarios" class="md-nav__link">
    <span class="md-ellipsis">
      Protection Scenarios
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-example" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration Example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitoring-rate-limiting" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring Rate Limiting
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#future-enhancements" class="md-nav__link">
    <span class="md-ellipsis">
      Future Enhancements
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#see-also" class="md-nav__link">
    <span class="md-ellipsis">
      See Also
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../security/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Security Model
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Configuration
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Configuration
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../identity-providers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Identity Providers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../drift-detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Drift Detection
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    How-To Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            How-To Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../how-to/end-to-end-setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    End-to-End Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../how-to/multi-tenant/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multi-Tenant Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../how-to/database-setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Database Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../how-to/smtp-configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SMTP Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../how-to/ha-deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    High Availability
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../how-to/backup-restore/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Backup & Restore
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Operations
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Operations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../operations/token-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Token Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../operations/troubleshooting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../operations/migration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Migration & Upgrade
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference/keycloak-crd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Keycloak CRD
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference/keycloak-realm-crd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    KeycloakRealm CRD
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reference/keycloak-client-crd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    KeycloakClient CRD
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../versioning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Versioning
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../observability/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Observability
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Development
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Development
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Testing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_11" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../decisions/generated-markdown/001-kopf-as-operator-framework/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Decision Records
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_11" id="__nav_11_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            Decision Records
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/002-uv-for-dependency-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-002: uv for dependency management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/003-least-privilege-everywhere/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-003: Least privilege everywhere
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/004-everything-must-be-gitopsable/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-004: Everything must be GitOpsable
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/005-no-plaintext-secrets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-005: No plaintext secrets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/006-all-functionality-must-be-tested-with-pytest/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-006: All functionality must be tested with pytest
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/007-integration-tests-in-kind-clusters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-007: Integration tests in Kind clusters
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/008-feature-parity-with-self-managed-keycloak/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-008: Feature parity with self-managed Keycloak
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/009-ai-agents-as-first-class-developers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-009: AI agents as first-class developers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/010-semantic-versioning-for-all-artifacts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-010: Semantic versioning for all artifacts
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/011-conventional-commits-for-all-development/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-011: Conventional commits for all development
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/012-async-api-with-rate-limiting-and-retries/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-012: Async API with rate limiting and retries
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/013-pydantic-models-for-keycloak-api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-013: Pydantic models for Keycloak API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/014-separate-helm-charts-per-resource-type/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-014: Separate Helm charts per resource type
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/015-cloudnativepg-as-first-class-database/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-015: CloudNativePG as first-class database
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/016-multi-namespace-operation-by-default/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-016: Multi-namespace operation by default
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/017-kubernetes-rbac-over-keycloak-security/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-017: Kubernetes RBAC over Keycloak security
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/018-management-port-separation-keycloak-25/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-018: Management port separation - Keycloak 25+
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/019-drift-detection-and-continuous-reconciliation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-019: Drift detection and continuous reconciliation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/020-real-kubernetes-for-integration-testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-020: Real Kubernetes for integration testing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/021-pre-commit-hooks-with-strict-validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-021: Pre-commit hooks with strict validation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/022-type-annotations-with-ty-for-type-checking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-022: Type annotations with ty for type checking
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/023-make-for-development-automation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-023: Make for development automation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/024-helm-as-deployment-mechanism/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-024: Helm as deployment mechanism
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/025-realm-and-client-as-primary-crd-resource-types/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-025: Realm and Client as primary CRD resource types
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/026-three-layer-responsibility-system-with-token-delegation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-026: Three-layer responsibility system with token delegation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/027-json-schemas-published-to-github-pages/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-027: JSON schemas published to GitHub Pages
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/028-documentation-published-to-github-pages/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-028: Documentation published to GitHub Pages
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/029-versioned-documentation-with-mike/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-029: Versioned documentation with mike
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/030-helm-charts-published-to-github-pages-oci-registry/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-030: Helm charts published to GitHub Pages OCI registry
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/031-automated-releases-with-release-please/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-031: Automated releases with release-please
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/032-minimal-rbac-with-namespaced-service-accounts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-032: Minimal RBAC with namespaced service accounts
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/033-custom-resource-definitions-as-api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-033: Custom Resource Definitions as API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/034-github-actions-for-ci-and-artifact-publication/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-034: GitHub Actions for CI and artifact publication
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/035-keycloak-25-0-version-support-requirement/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-035: Keycloak 25.0+ version support requirement
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/036-automated-dependency-updates-with-dependabot-and-custom-workflows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-036: Automated dependency updates with Dependabot and custom workflows
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/037-support-for-operator-managed-and-external-keycloak-instances/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-037: Support for operator-managed and external Keycloak instances
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/039-token-rotation-and-bootstrap-flows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-039: Token rotation and bootstrap flows
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/040-admission-webhooks-for-validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-040: Admission Webhooks for Resource Validation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/040-ruff-for-formatting-and-linting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-040: Ruff for formatting and linting
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/041-shared-operator-fixture-in-tests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-041: Shared operator fixture in tests
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/042-pytest-xdist-for-parallel-integration-tests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-042: pytest-xdist for parallel integration tests
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/043-wait-helpers-with-debug-logging-in-tests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-043: Wait helpers with debug logging in tests
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/044-extra-manifests-support-in-helm-charts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-044: Extra manifests support in Helm charts
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/045-active-standby-ha-using-kopf-peering/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-045: Active-standby HA using Kopf peering
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/046-multiple-operator-support-with-explicit-references/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-046: Multiple operator support with explicit references
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/047-managed-keycloak-for-quick-start/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-047: Managed Keycloak for quick start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/048-prometheus-metrics-exposure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-048: Prometheus metrics exposure
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/049-horizontal-scaling-via-multiple-operators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-049: Horizontal scaling via multiple operator deployments (realm sharding)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/050-structured-json-logging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-050: Structured JSON logging
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/051-multi-stage-docker-builds-for-minimal-images/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-051: Multi-stage Docker builds for minimal images
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/052-optimized-keycloak-container-for-tests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-052: Optimized Keycloak container for tests
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/053-error-categorization-temporary-vs-permanent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-053: Error categorization - temporary vs permanent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/054-namespace-watch-scope-requires-cluster-rbac/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-054: Namespace watch scope requires cluster-wide RBAC
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/055-container-image-registry-and-tagging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-055: Container image registry and tagging strategy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/056-no-opinionated-backup-or-secret-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-056: No opinionated backup or secret management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/057-cr-data-validated-with-pydantic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-057: CR data must be validated with Pydantic models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/058-single-keycloak-version-support/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-058: Single Keycloak version support (26.x)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/059-no-managed-keycloak-upgrades/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-059: No managed Keycloak upgrades
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/060-cascading-deletes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-060: Cascading deletes for dependent resources
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/061-github-issues-with-ai-instructions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-061: GitHub Issues for planned work with AI agent instructions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/062-one-keycloak-per-operator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-062: One Keycloak instance per operator deployment
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/063-namespace-grant-list-authorization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-063: Namespace grant list authorization for clients
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/064-no-force-delete-annotation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-064: No force-delete annotation for finalizers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../decisions/generated-markdown/065-webhook-certificate-management-with-cert-manager/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADR-065: Webhook certificate management with cert-manager
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FAQ
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/keycloak_operator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#high-level-components" class="md-nav__link">
    <span class="md-ellipsis">
      High-Level Components
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#token-system-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Token System Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Token System Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#token-types" class="md-nav__link">
    <span class="md-ellipsis">
      Token Types
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token-lifecycle" class="md-nav__link">
    <span class="md-ellipsis">
      Token Lifecycle
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#single-tenant-vs-multi-tenant" class="md-nav__link">
    <span class="md-ellipsis">
      Single-Tenant vs Multi-Tenant
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Single-Tenant vs Multi-Tenant">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-tenant-development-mode" class="md-nav__link">
    <span class="md-ellipsis">
      Single-Tenant / Development Mode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-tenant-production-mode" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Tenant / Production Mode
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token-discovery-mechanism" class="md-nav__link">
    <span class="md-ellipsis">
      Token Discovery Mechanism
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Security Considerations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token-rotation-lifecycle" class="md-nav__link">
    <span class="md-ellipsis">
      Token Rotation Lifecycle
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#reconciliation-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Reconciliation Flow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-modules" class="md-nav__link">
    <span class="md-ellipsis">
      Key Modules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scaling-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Scaling Strategy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Scaling Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#two-types-of-scaling" class="md-nav__link">
    <span class="md-ellipsis">
      Two Types of Scaling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Two Types of Scaling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-operator-scaling-reconciliation" class="md-nav__link">
    <span class="md-ellipsis">
      1. Operator Scaling (Reconciliation)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-keycloak-instance-scaling-end-user-traffic" class="md-nav__link">
    <span class="md-ellipsis">
      2. Keycloak Instance Scaling (End-User Traffic)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#where-bottlenecks-occur" class="md-nav__link">
    <span class="md-ellipsis">
      Where Bottlenecks Occur
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-to-scale-what" class="md-nav__link">
    <span class="md-ellipsis">
      When to Scale What
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-operator-deployment-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Operator Deployment Pattern
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recommended-approach" class="md-nav__link">
    <span class="md-ellipsis">
      Recommended Approach
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-misconception" class="md-nav__link">
    <span class="md-ellipsis">
      Common Misconception
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rate-limiting-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Rate Limiting Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Rate Limiting Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rate-limiting-layers-explained" class="md-nav__link">
    <span class="md-ellipsis">
      Rate Limiting Layers Explained
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Rate Limiting Layers Explained">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#layer-3-jitter-reconciliation-start" class="md-nav__link">
    <span class="md-ellipsis">
      Layer 3: Jitter (Reconciliation Start)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#layer-2-per-namespace-rate-limiting" class="md-nav__link">
    <span class="md-ellipsis">
      Layer 2: Per-Namespace Rate Limiting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#layer-1-global-rate-limiting" class="md-nav__link">
    <span class="md-ellipsis">
      Layer 1: Global Rate Limiting
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protection-scenarios" class="md-nav__link">
    <span class="md-ellipsis">
      Protection Scenarios
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-example" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration Example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitoring-rate-limiting" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring Rate Limiting
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#future-enhancements" class="md-nav__link">
    <span class="md-ellipsis">
      Future Enhancements
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#see-also" class="md-nav__link">
    <span class="md-ellipsis">
      See Also
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/vriesdemichael/keycloak-operator/blob/main/docs/architecture.md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="architecture">Architecture<a class="headerlink" href="#architecture" title="Permanent link">&para;</a></h1>
<p>This operator is structured into clear layers to keep reconciliation logic maintainable and testable.</p>
<h2 id="high-level-components">High-Level Components<a class="headerlink" href="#high-level-components" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>Layer</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>CRDs / Models</td>
<td>Pydantic models define the spec &amp; status of custom resources.</td>
</tr>
<tr>
<td>Handlers</td>
<td>Kopf handlers reacting to create/update/delete events.</td>
</tr>
<tr>
<td>Services (Reconcilers)</td>
<td>Idempotent business logic for converging desired -&gt; actual state.</td>
</tr>
<tr>
<td>Utils</td>
<td>Reusable helpers: Kubernetes API interactions, Keycloak admin client, validation.</td>
</tr>
<tr>
<td>Observability</td>
<td>Metrics, health endpoints, structured logging.</td>
</tr>
</tbody>
</table>
<h2 id="token-system-architecture">Token System Architecture<a class="headerlink" href="#token-system-architecture" title="Permanent link">&para;</a></h2>
<p>The operator uses a sophisticated multi-tier token system to balance security, multi-tenancy, and operational simplicity.</p>
<h3 id="token-types">Token Types<a class="headerlink" href="#token-types" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>graph TD
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    A[Operator Token] --&gt;|Single-Tenant Dev Mode| D[Create Realm]
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    B[Admission Token] --&gt;|Multi-Tenant Production| E[First Realm]
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    E --&gt;|Auto-Generated| C[Operational Token]
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    C --&gt;|All Subsequent Operations| F[Additional Realms]
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    C --&gt;|Auto-Rotation| C
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    F --&gt;|Propagates to Status| G[Realm Token]
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    style A fill:#ffd700
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    style B fill:#90ee90
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    style C fill:#87ceeb
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    style G fill:#dda0dd
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    subgraph Single-Tenant Mode
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    A
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    end
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    subgraph Multi-Tenant Production
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    B
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    C
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    F
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    end
</span></code></pre></div>
<h3 id="token-lifecycle">Token Lifecycle<a class="headerlink" href="#token-lifecycle" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Token Type</th>
<th>Purpose</th>
<th>Lifecycle</th>
<th>Rotation</th>
<th>Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Operator Token</strong></td>
<td>Dev/evaluation mode</td>
<td>Created with operator</td>
<td>Manual</td>
<td>Direct realm creation (single-tenant only)</td>
</tr>
<tr>
<td><strong>Admission Token</strong></td>
<td>Bootstrap namespace</td>
<td>Platform team creates</td>
<td>Manual</td>
<td>First realm in namespace</td>
</tr>
<tr>
<td><strong>Operational Token</strong></td>
<td>Day-to-day operations</td>
<td>Auto-generated from first realm</td>
<td>Every 90 days</td>
<td>All subsequent realms</td>
</tr>
<tr>
<td><strong>Realm Token</strong></td>
<td>Client access</td>
<td>Created per realm</td>
<td>Managed by realm</td>
<td>OAuth2/OIDC clients</td>
</tr>
</tbody>
</table>
<h3 id="single-tenant-vs-multi-tenant">Single-Tenant vs Multi-Tenant<a class="headerlink" href="#single-tenant-vs-multi-tenant" title="Permanent link">&para;</a></h3>
<h4 id="single-tenant-development-mode">Single-Tenant / Development Mode<a class="headerlink" href="#single-tenant-development-mode" title="Permanent link">&para;</a></h4>
<p>Best for: Evaluation, development, testing</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># Use operator token directly (simple, but no multi-tenancy)</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">  </span><span class="nt">operatorRef</span><span class="p">:</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak-system</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">    </span><span class="nt">authorizationSecretRef</span><span class="p">:</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak-operator-auth-token</span>
</span></code></pre></div>
<p><strong>Flow:</strong>
1. Operator creates <code>keycloak-operator-auth-token</code> on startup
2. Teams use operator token directly for all realms
3. No namespace isolation, no token rotation</p>
<p><strong>Limitations:</strong>
- Single point of access (operator token compromise affects all realms)
- No namespace-based RBAC isolation
- Manual token rotation required
- Not suitable for production multi-tenant environments</p>
<h4 id="multi-tenant-production-mode">Multi-Tenant / Production Mode<a class="headerlink" href="#multi-tenant-production-mode" title="Permanent link">&para;</a></h4>
<p>Best for: Production, multi-team environments</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># First realm uses admission token</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">  </span><span class="nt">operatorRef</span><span class="p">:</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak-system</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="nt">authorizationSecretRef</span><span class="p">:</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-team-admission-token</span>
</span></code></pre></div>
<p><strong>Flow:</strong>
1. Platform team generates unique admission token per team
2. Platform team creates secret in team's namespace with discovery labels
3. Platform team registers token in operator's metadata ConfigMap
4. Team creates first realm using admission token
5. Operator auto-generates operational token, stores in namespace
6. All subsequent realms auto-discover operational token
7. Operational token auto-rotates every 90 days with zero downtime</p>
<p><strong>Benefits:</strong>
- Namespace-level RBAC isolation (teams can only manage their realms)
- Automatic token rotation (security best practice)
- Admission token can be revoked after first realm (principle of least privilege)
- Platform team controls which namespaces can create realms
- Each team has independent operational token</p>
<h3 id="token-discovery-mechanism">Token Discovery Mechanism<a class="headerlink" href="#token-discovery-mechanism" title="Permanent link">&para;</a></h3>
<p>The operator discovers operational tokens using Kubernetes labels:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-team-operational-token</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-team</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">    </span><span class="nt">keycloak.vriesdemichael.github.io/managed-by</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak-operator</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">    </span><span class="nt">keycloak.vriesdemichael.github.io/operator-instance</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="w">    </span><span class="nt">keycloak.vriesdemichael.github.io/token-type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">operational</span>
</span></code></pre></div>
<p>When creating a realm, the operator:
1. Checks if realm specifies an authorization secret (explicit)
2. If not, searches namespace for secret with discovery labels (auto-discovery)
3. Uses discovered operational token
4. Falls back to error if no token found</p>
<h3 id="security-considerations">Security Considerations<a class="headerlink" href="#security-considerations" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Operator token</strong> bypasses multi-tenant security - only use for dev/evaluation</li>
<li><strong>Admission tokens</strong> are one-time bootstrap credentials - can be revoked after first realm</li>
<li><strong>Operational tokens</strong> are namespace-scoped - compromise affects only that namespace's realms</li>
<li><strong>Realm tokens</strong> are realm-specific - compromise affects only that realm's clients</li>
<li><strong>Token rotation</strong> happens automatically for operational tokens (90-day default)</li>
<li><strong>Token metadata</strong> tracked in ConfigMap for audit trail</li>
</ul>
<p>See <a href="../security/">Security Model</a> for detailed security architecture and <a href="../operations/token-management/">Token Management</a> for operational procedures.</p>
<h3 id="token-rotation-lifecycle">Token Rotation Lifecycle<a class="headerlink" href="#token-rotation-lifecycle" title="Permanent link">&para;</a></h3>
<p>Operational tokens automatically rotate every 90 days with zero downtime:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>sequenceDiagram
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>    participant Timer as Timer Handler&lt;br/&gt;(checks every hour)
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>    participant Operator as Operator
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>    participant ConfigMap as Token Metadata&lt;br/&gt;ConfigMap
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    participant Secret as Operational Token&lt;br/&gt;Secret
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>    participant Realm as KeycloakRealm&lt;br/&gt;Resources
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>    Timer-&gt;&gt;ConfigMap: Check token expiry dates
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>    ConfigMap--&gt;&gt;Timer: Token expires in &lt;7 days
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>    Note over Timer,Operator: Rotation Begins
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>    Timer-&gt;&gt;Operator: Trigger rotation for namespace
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>    Operator-&gt;&gt;Operator: Generate new token
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>    Operator-&gt;&gt;Secret: Add &quot;token-previous&quot; key&lt;br/&gt;(keep old token)
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>    Operator-&gt;&gt;Secret: Update &quot;token&quot; key&lt;br/&gt;(new token)
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>    Operator-&gt;&gt;ConfigMap: Update metadata&lt;br/&gt;(new expiry, version++)
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>    Note over Secret,Realm: Grace Period (7 days)&lt;br/&gt;Both tokens valid
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>    Realm-&gt;&gt;Secret: Read &quot;token&quot; key&lt;br/&gt;(uses new token)
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>    Realm-&gt;&gt;Secret: OR read &quot;token-previous&quot;&lt;br/&gt;(old token still works)
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>    Note over Timer,Realm: After 7 days
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>    Timer-&gt;&gt;Secret: Remove &quot;token-previous&quot; key
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>    Realm-&gt;&gt;Secret: Read &quot;token&quot; key only&lt;br/&gt;(old token no longer available)
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>    Note over Operator,Realm: Zero-Downtime Rotation Complete
</span></code></pre></div>
<p><strong>Key Points:</strong></p>
<ol>
<li><strong>Automatic</strong>: Timer handler checks hourly for tokens expiring in &lt;7 days</li>
<li><strong>Dual-Token Period</strong>: Both old and new tokens valid for 7 days (grace period)</li>
<li><strong>Zero Downtime</strong>: Realms can use either token during grace period</li>
<li><strong>Version Tracking</strong>: Token metadata tracks version and expiry in ConfigMap</li>
<li><strong>Cleanup</strong>: Old token removed after grace period expires</li>
</ol>
<h2 id="reconciliation-flow">Reconciliation Flow<a class="headerlink" href="#reconciliation-flow" title="Permanent link">&para;</a></h2>
<p>The operator follows a consistent reconciliation pattern for all custom resources:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>flowchart TD
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>    A[Kubernetes Event&lt;br/&gt;create/update/delete] --&gt; B[Kopf Handler&lt;br/&gt;handlers/*.py]
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>    B --&gt; C{Validate Input}
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>    C --&gt;|Invalid| D[Update Status: Failed&lt;br/&gt;Emit Event]
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>    C --&gt;|Valid| E[Reconciler Service&lt;br/&gt;services/*_reconciler.py]
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    E --&gt; F[Load Current State]
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>    F --&gt; G[From Keycloak API]
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>    F --&gt; H[From Kubernetes API]
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>    G --&gt; I{Compute Diff}
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>    H --&gt; I
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>    I --&gt; J{Changes Needed?}
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>    J --&gt;|No| K[Update Status: Ready&lt;br/&gt;No action needed]
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>    J --&gt;|Yes| L[Apply Changes]
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>    L --&gt; M{Create}
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>    L --&gt; N{Update}
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>    L --&gt; O{Delete}
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>    M --&gt; P[Keycloak Admin API&lt;br/&gt;POST /realms]
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>    N --&gt; Q[Keycloak Admin API&lt;br/&gt;PUT /realms/name]
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>    O --&gt; R[Keycloak Admin API&lt;br/&gt;DELETE /realms/name]
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>    P --&gt; S[Update CR Status]
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>    Q --&gt; S
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>    R --&gt; S
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>    S --&gt; T{Success?}
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>    T --&gt;|Yes| U[Status: Ready&lt;br/&gt;Emit Success Event&lt;br/&gt;Record Metrics]
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>    T --&gt;|No| V[Status: Failed&lt;br/&gt;Emit Error Event&lt;br/&gt;Record Metrics&lt;br/&gt;Retry with backoff]
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>    D --&gt; W[End]
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>    K --&gt; W
</span><span id="__span-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>    U --&gt; W
</span><span id="__span-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>    V --&gt; W
</span><span id="__span-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>
</span><span id="__span-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>    style A fill:#e1f5ff
</span><span id="__span-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>    style B fill:#fff4e1
</span><span id="__span-5-41"><a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>    style E fill:#e8f5e9
</span><span id="__span-5-42"><a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>    style I fill:#f3e5f5
</span><span id="__span-5-43"><a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>    style S fill:#fff3e0
</span><span id="__span-5-44"><a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>    style U fill:#c8e6c9
</span><span id="__span-5-45"><a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>    style V fill:#ffcdd2
</span></code></pre></div>
<p><strong>Reconciliation Steps:</strong></p>
<ol>
<li><strong>Event Reception</strong>: Kubernetes emits event for custom resource (create/update/delete)</li>
<li><strong>Handler Invocation</strong>: Kopf invokes registered handler (<code>handlers/realm.py</code>, etc.)</li>
<li><strong>Input Validation</strong>: Handler validates spec fields and authorization</li>
<li><strong>Delegation</strong>: Handler delegates to reconciler service (<code>services/realm_reconciler.py</code>)</li>
<li><strong>State Loading</strong>: Reconciler loads current state from Keycloak and Kubernetes APIs</li>
<li><strong>Diff Computation</strong>: Compare desired spec with actual state</li>
<li><strong>Change Application</strong>: Apply required create/update/delete operations via Keycloak Admin API</li>
<li><strong>Status Update</strong>: Update custom resource status field (Ready/Failed)</li>
<li><strong>Observability</strong>: Emit metrics, logs, and Kubernetes events</li>
</ol>
<p><strong>Key Principles:</strong></p>
<ul>
<li><strong>Idempotent</strong>: Reconciler can be called multiple times with same input</li>
<li><strong>Thin Handlers</strong>: Handlers contain minimal logic, delegate to services</li>
<li><strong>Thick Services</strong>: Reconcilers contain all business logic</li>
<li><strong>State-Based</strong>: Always compare current state vs desired state (not event-based)</li>
<li><strong>Error Recovery</strong>: Failed reconciliations retry with exponential backoff</li>
</ul>
<h2 id="key-modules">Key Modules<a class="headerlink" href="#key-modules" title="Permanent link">&para;</a></h2>
<ul>
<li><code>models/</code> define <code>Keycloak</code>, <code>KeycloakRealm</code>, <code>KeycloakClient</code> domain schemas.</li>
<li><code>handlers/</code> contain Kopf decorated async functions with minimal logic.</li>
<li><code>services/</code> hold reconcilers orchestrating API calls &amp; ensuring idempotency.</li>
<li><code>utils/keycloak_admin.py</code> wraps Keycloak REST admin endpoints.</li>
<li><code>observability/metrics.py</code> defines Prometheus collectors.</li>
</ul>
<h2 id="error-handling">Error Handling<a class="headerlink" href="#error-handling" title="Permanent link">&para;</a></h2>
<p>Custom exceptions in <code>errors/operator_errors.py</code> categorize recoverable vs fatal failures. Handlers catch and translate them to appropriate Kubernetes events/logs.</p>
<h2 id="scaling-strategy">Scaling Strategy<a class="headerlink" href="#scaling-strategy" title="Permanent link">&para;</a></h2>
<p>When considering scaling in a Keycloak deployment managed by this operator, it's critical to understand that there are <strong>two distinct types of scaling</strong>, each serving different purposes and having different performance characteristics.</p>
<h3 id="two-types-of-scaling">Two Types of Scaling<a class="headerlink" href="#two-types-of-scaling" title="Permanent link">&para;</a></h3>
<h4 id="1-operator-scaling-reconciliation">1. Operator Scaling (Reconciliation)<a class="headerlink" href="#1-operator-scaling-reconciliation" title="Permanent link">&para;</a></h4>
<p>The operator itself performs reconciliation actions:
- Watches Keycloak custom resources
- Reconciles desired state with actual state
- Makes Admin API calls to configure Keycloak
- Manages Kubernetes resources</p>
<p><strong>Key Point:</strong> Operator scaling is rarely the bottleneck.</p>
<h4 id="2-keycloak-instance-scaling-end-user-traffic">2. Keycloak Instance Scaling (End-User Traffic)<a class="headerlink" href="#2-keycloak-instance-scaling-end-user-traffic" title="Permanent link">&para;</a></h4>
<p>The Keycloak instance handles:
- End-user authentication and authorization requests
- Session management
- Token generation and validation
- User database queries
- Admin API calls (triggered by operator or administrators)</p>
<p><strong>Key Point:</strong> This is where you will hit performance limits first.</p>
<h3 id="where-bottlenecks-occur">Where Bottlenecks Occur<a class="headerlink" href="#where-bottlenecks-occur" title="Permanent link">&para;</a></h3>
<p>In virtually all real-world scenarios, <strong>you will hit Keycloak instance limitations before operator limitations</strong>, even after vertically scaling both components to their maximum capacity.</p>
<p>The operator's workload (reconciliation loops and occasional Admin API calls) is minimal compared to the Keycloak instance's workload (continuous authentication/authorization requests from thousands or millions of end users).</p>
<h3 id="when-to-scale-what">When to Scale What<a class="headerlink" href="#when-to-scale-what" title="Permanent link">&para;</a></h3>
<p>If you're experiencing performance issues:</p>
<ol>
<li><strong>First, scale the Keycloak instance itself:</strong></li>
<li>Increase replicas for horizontal scaling</li>
<li>Add database read replicas</li>
<li>Optimize caching configuration</li>
<li>
<p>Review realm and client configuration for performance</p>
</li>
<li>
<p><strong>Only consider operator scaling if:</strong></p>
</li>
<li>You have an extremely high rate of realm/client configuration changes</li>
<li>Reconciliation loops are measurably slow</li>
<li>You can verify that the operator is the actual bottleneck (use metrics/profiling)</li>
</ol>
<h3 id="multi-operator-deployment-pattern">Multi-Operator Deployment Pattern<a class="headerlink" href="#multi-operator-deployment-pattern" title="Permanent link">&para;</a></h3>
<p>If you genuinely need more operator capacity (or want to isolate workloads), this operator supports running multiple instances side-by-side in the same cluster.</p>
<p>Each realm can target a specific operator instance using the <code>operatorRef</code> field. This allows you to:</p>
<ul>
<li>Distribute realm management across multiple operators</li>
<li>Isolate different teams or environments to different operators</li>
<li>Scale operator capacity horizontally when needed</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>graph TB
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>    subgraph Cluster[&quot;Kubernetes Cluster&quot;]
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>        subgraph OpNS1[&quot;keycloak-system-prod&quot;]
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>            Op1[Operator Instance: prod]
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>            KC1[Keycloak Instance: prod]
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>        end
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>        subgraph OpNS2[&quot;keycloak-system-dev&quot;]
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>            Op2[Operator Instance: dev]
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>            KC2[Keycloak Instance: dev]
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>        end
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>        subgraph TeamA[&quot;Namespace: team-a&quot;]
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>            RealmA1[Realm: team-a-prod]
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>            RealmA2[Realm: team-a-dev]
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>            TokenA1[Token: prod-admission]
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>            TokenA2[Token: dev-admission]
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>        end
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>        subgraph TeamB[&quot;Namespace: team-b&quot;]
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>            RealmB1[Realm: team-b-prod]
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>            RealmB2[Realm: team-b-dev]
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>            TokenB1[Token: prod-admission]
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>            TokenB2[Token: dev-admission]
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>        end
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>    end
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>    RealmA1 --&gt;|operatorRef: keycloak-system-prod| Op1
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>    RealmA1 --&gt;|authRef: prod-admission| TokenA1
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>    Op1 --&gt;|Reconcile| KC1
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a>
</span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a>    RealmA2 --&gt;|operatorRef: keycloak-system-dev| Op2
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a>    RealmA2 --&gt;|authRef: dev-admission| TokenA2
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a>    Op2 --&gt;|Reconcile| KC2
</span><span id="__span-6-35"><a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a>
</span><span id="__span-6-36"><a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>    RealmB1 --&gt;|operatorRef: keycloak-system-prod| Op1
</span><span id="__span-6-37"><a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a>    RealmB1 --&gt;|authRef: prod-admission| TokenB1
</span><span id="__span-6-38"><a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a>
</span><span id="__span-6-39"><a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a>    RealmB2 --&gt;|operatorRef: keycloak-system-dev| Op2
</span><span id="__span-6-40"><a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a>    RealmB2 --&gt;|authRef: dev-admission| TokenB2
</span><span id="__span-6-41"><a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a>
</span><span id="__span-6-42"><a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a>    style Op1 fill:#e3f2fd
</span><span id="__span-6-43"><a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a>    style Op2 fill:#f3e5f5
</span><span id="__span-6-44"><a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a>    style KC1 fill:#e1f5fe
</span><span id="__span-6-45"><a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a>    style KC2 fill:#f8bbd0
</span><span id="__span-6-46"><a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a>    style RealmA1 fill:#c8e6c9
</span><span id="__span-6-47"><a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a>    style RealmA2 fill:#fff9c4
</span><span id="__span-6-48"><a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a>    style RealmB1 fill:#c8e6c9
</span><span id="__span-6-49"><a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a>    style RealmB2 fill:#fff9c4
</span></code></pre></div>
<p><strong>Key Benefits of Multi-Operator Pattern:</strong></p>
<ul>
<li><strong>Workload Isolation</strong>: Production and development operators are completely independent</li>
<li><strong>Blast Radius Reduction</strong>: Issues with dev operator don't affect production realms</li>
<li><strong>Independent Scaling</strong>: Each operator can be sized according to its workload</li>
<li><strong>Team Autonomy</strong>: Teams can target different operators based on environment</li>
<li><strong>Upgrade Safety</strong>: Test operator upgrades in dev before rolling to production</li>
</ul>
<p><strong>Example configuration:</strong></p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># yaml-language-server: $schema=https://vriesdemichael.github.io/keycloak-operator/schemas/v1/KeycloakRealm.json</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vriesdemichael.github.io/v1</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KeycloakRealm</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-realm</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">  </span><span class="nt">realmName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-realm</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">  </span><span class="nt">operatorRef</span><span class="p">:</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak-system</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">    </span><span class="nt">authorizationSecretRef</span><span class="p">:</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keycloak-operator-auth-token</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">  </span><span class="c1"># ... rest of realm config</span>
</span></code></pre></div>
<p><strong>When to use multiple operators:</strong></p>
<ul>
<li>Large number of realms with frequent configuration changes</li>
<li>Workload isolation (e.g., production vs non-production)</li>
<li>Geographic distribution across regions/clusters</li>
<li>Huge monolithic realms that cannot be subdivided</li>
</ul>
<p><strong>When NOT to use multiple operators:</strong></p>
<ul>
<li>To improve end-user authentication performance (scale Keycloak instead)</li>
<li>As a first resort (vertical scaling is usually sufficient)</li>
<li>Without measuring (verify the operator is actually your bottleneck)</li>
</ul>
<h3 id="recommended-approach">Recommended Approach<a class="headerlink" href="#recommended-approach" title="Permanent link">&para;</a></h3>
<p>For most use cases:</p>
<ol>
<li>Start with a single operator instance with reasonable resource limits</li>
<li>Scale your Keycloak instances to meet end-user authentication demands</li>
<li>Monitor operator performance using available metrics</li>
<li>Only deploy additional operators when you can demonstrate that reconciliation performance is actually limiting your operations</li>
</ol>
<h3 id="common-misconception">Common Misconception<a class="headerlink" href="#common-misconception" title="Permanent link">&para;</a></h3>
<blockquote>
<p>"Python operators don't scale as well as Go operators, so I need multiple instances."</p>
</blockquote>
<p><strong>Reality:</strong> For this workload, the language choice has minimal impact. The operator spends most of its time waiting for Kubernetes API responses and Keycloak Admin API calls, not doing CPU-intensive work. A single Python-based operator can easily manage dozens of realms without performance degradation.</p>
<p>The scaling strategy should be driven by <strong>actual performance metrics and requirements</strong>, not by assumptions about implementation language.</p>
<h2 id="rate-limiting-architecture">Rate Limiting Architecture<a class="headerlink" href="#rate-limiting-architecture" title="Permanent link">&para;</a></h2>
<p>The operator implements a three-layer rate limiting strategy to protect Keycloak instances from API overload, particularly during mass reconciliation events (operator restarts, database reconnections, or intentional/malicious resource spam).</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>flowchart TB
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>    subgraph Reconciliation[&quot;Reconciliation Request Flow&quot;]
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>        Event[Kubernetes Event&lt;br/&gt;create/update/delete]
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>        Jitter[Layer 3: Jitter&lt;br/&gt;Random delay 0-5s&lt;br/&gt;Prevents thundering herd]
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>        NSLimit[Layer 2: Namespace Limiter&lt;br/&gt;5 req/s per namespace&lt;br/&gt;Fair allocation]
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>        GlobalLimit[Layer 1: Global Limiter&lt;br/&gt;50 req/s cluster-wide&lt;br/&gt;Total protection]
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>        API[Keycloak Admin API]
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>    end
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>    subgraph Limits[&quot;Token Bucket Rate Limiters&quot;]
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>        subgraph Global[&quot;Global Bucket&quot;]
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>            GT[Tokens: 50/sec&lt;br/&gt;Burst: 100]
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>        end
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>        subgraph NS1[&quot;Namespace: team-a&quot;]
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>            NS1T[Tokens: 5/sec&lt;br/&gt;Burst: 10]
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>        end
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>        subgraph NS2[&quot;Namespace: team-b&quot;]
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>            NS2T[Tokens: 5/sec&lt;br/&gt;Burst: 10]
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>        end
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>        subgraph NS3[&quot;Namespace: team-c&quot;]
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>            NS3T[Tokens: 5/sec&lt;br/&gt;Burst: 10]
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>        end
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>    end
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a>    Event --&gt; Jitter
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a>    Jitter --&gt; NSLimit
</span><span id="__span-8-30"><a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a>    NSLimit --&gt; NS1T
</span><span id="__span-8-31"><a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a>    NSLimit --&gt; NS2T
</span><span id="__span-8-32"><a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a>    NSLimit --&gt; NS3T
</span><span id="__span-8-33"><a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a>
</span><span id="__span-8-34"><a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>    NS1T --&gt; GlobalLimit
</span><span id="__span-8-35"><a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>    NS2T --&gt; GlobalLimit
</span><span id="__span-8-36"><a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a>    NS3T --&gt; GlobalLimit
</span><span id="__span-8-37"><a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a>
</span><span id="__span-8-38"><a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a>    GlobalLimit --&gt; GT
</span><span id="__span-8-39"><a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a>    GT --&gt; API
</span><span id="__span-8-40"><a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a>
</span><span id="__span-8-41"><a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a>    style Event fill:#e1f5ff
</span><span id="__span-8-42"><a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a>    style Jitter fill:#fff9c4
</span><span id="__span-8-43"><a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a>    style NSLimit fill:#f3e5f5
</span><span id="__span-8-44"><a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a>    style GlobalLimit fill:#ffccbc
</span><span id="__span-8-45"><a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a>    style API fill:#c8e6c9
</span><span id="__span-8-46"><a id="__codelineno-8-46" name="__codelineno-8-46" href="#__codelineno-8-46"></a>    style GT fill:#ffab91
</span><span id="__span-8-47"><a id="__codelineno-8-47" name="__codelineno-8-47" href="#__codelineno-8-47"></a>    style NS1T fill:#ce93d8
</span><span id="__span-8-48"><a id="__codelineno-8-48" name="__codelineno-8-48" href="#__codelineno-8-48"></a>    style NS2T fill:#ce93d8
</span><span id="__span-8-49"><a id="__codelineno-8-49" name="__codelineno-8-49" href="#__codelineno-8-49"></a>    style NS3T fill:#ce93d8
</span></code></pre></div>
<h3 id="rate-limiting-layers-explained">Rate Limiting Layers Explained<a class="headerlink" href="#rate-limiting-layers-explained" title="Permanent link">&para;</a></h3>
<h4 id="layer-3-jitter-reconciliation-start">Layer 3: Jitter (Reconciliation Start)<a class="headerlink" href="#layer-3-jitter-reconciliation-start" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Purpose</strong>: Prevent "thundering herd" when operator restarts with 100+ resources</li>
<li><strong>Implementation</strong>: Random delay (0-5 seconds) before reconciliation starts</li>
<li><strong>Configuration</strong>: <code>RECONCILE_JITTER_MAX_SECONDS</code> (default: 5.0)</li>
<li><strong>Effect</strong>: Spreads reconciliation across time window instead of all at once</li>
</ul>
<h4 id="layer-2-per-namespace-rate-limiting">Layer 2: Per-Namespace Rate Limiting<a class="headerlink" href="#layer-2-per-namespace-rate-limiting" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Purpose</strong>: Fair resource allocation across teams/namespaces</li>
<li><strong>Implementation</strong>: Token bucket algorithm, one bucket per namespace</li>
<li><strong>Configuration</strong>: <code>KEYCLOAK_API_NAMESPACE_RATE_LIMIT_TPS</code> (default: 5 req/s)</li>
<li><strong>Burst Capacity</strong>: <code>KEYCLOAK_API_NAMESPACE_BURST</code> (default: 10)</li>
<li><strong>Effect</strong>: Prevents one team from monopolizing API capacity</li>
</ul>
<p><strong>Example</strong>: If <code>team-a</code> creates 1000 realms:
- Rate limited to 5 req/s = 200 seconds minimum
- Other teams' realms still reconcile at their namespace rate limits
- No team can starve others of API capacity</p>
<h4 id="layer-1-global-rate-limiting">Layer 1: Global Rate Limiting<a class="headerlink" href="#layer-1-global-rate-limiting" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Purpose</strong>: Absolute protection of Keycloak instance from overload</li>
<li><strong>Implementation</strong>: Token bucket algorithm, shared across all namespaces</li>
<li><strong>Configuration</strong>: <code>KEYCLOAK_API_GLOBAL_RATE_LIMIT_TPS</code> (default: 50 req/s)</li>
<li><strong>Burst Capacity</strong>: <code>KEYCLOAK_API_GLOBAL_BURST</code> (default: 100)</li>
<li><strong>Effect</strong>: Hard cap on total API requests across entire cluster</li>
</ul>
<p><strong>Example</strong>: With 20 teams each creating 100 realms:
- Namespace limits allow each team 5 req/s (total theoretical: 100 req/s)
- Global limit enforces actual maximum of 50 req/s
- Teams fairly share the 50 req/s capacity</p>
<h3 id="protection-scenarios">Protection Scenarios<a class="headerlink" href="#protection-scenarios" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Scenario</th>
<th>Protection Mechanism</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td>Operator restart (50 resources)</td>
<td>Jitter spreads starts over 5s</td>
<td>Smooth reconciliation, not instant spike</td>
</tr>
<tr>
<td>Database reconnection (100 resources)</td>
<td>Jitter + namespace limits</td>
<td>Controlled recovery, API not overwhelmed</td>
</tr>
<tr>
<td>Malicious spam (1000 realms in one namespace)</td>
<td>Namespace limit (5 req/s)</td>
<td>200 seconds minimum, other teams unaffected</td>
</tr>
<tr>
<td>20 teams creating resources simultaneously</td>
<td>Global limit (50 req/s)</td>
<td>Fair sharing, no single team monopolizes</td>
</tr>
</tbody>
</table>
<h3 id="configuration-example">Configuration Example<a class="headerlink" href="#configuration-example" title="Permanent link">&para;</a></h3>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># Operator deployment configuration</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="nt">env</span><span class="p">:</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">  </span><span class="c1"># Layer 1: Global limit (protect Keycloak)</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KEYCLOAK_API_GLOBAL_RATE_LIMIT_TPS</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;50&quot;</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KEYCLOAK_API_GLOBAL_BURST</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;100&quot;</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">  </span><span class="c1"># Layer 2: Namespace limits (fair allocation)</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KEYCLOAK_API_NAMESPACE_RATE_LIMIT_TPS</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;5&quot;</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KEYCLOAK_API_NAMESPACE_BURST</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10&quot;</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="w">  </span><span class="c1"># Layer 3: Jitter (thundering herd prevention)</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RECONCILE_JITTER_MAX_SECONDS</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;5.0&quot;</span>
</span></code></pre></div>
<h3 id="monitoring-rate-limiting">Monitoring Rate Limiting<a class="headerlink" href="#monitoring-rate-limiting" title="Permanent link">&para;</a></h3>
<p>The operator exposes Prometheus metrics for rate limiting (when implemented):</p>
<ul>
<li><code>keycloak_operator_rate_limit_wait_seconds</code>: Time spent waiting for rate limit tokens</li>
<li><code>keycloak_operator_rate_limit_denied_total</code>: Number of requests denied (should be 0)</li>
<li><code>keycloak_operator_rate_limit_tokens_available</code>: Current token bucket levels</li>
</ul>
<p>See <a href="../observability/">Observability</a> for complete metrics documentation.</p>
<h2 id="future-enhancements">Future Enhancements<a class="headerlink" href="#future-enhancements" title="Permanent link">&para;</a></h2>
<ul>
<li>Finalizers for deterministic teardown</li>
<li>Smarter diffing of realm/client sub-resources</li>
<li>Rate limiting &amp; backoff policies</li>
<li>Pluggable auth strategies for Keycloak admin API</li>
</ul>
<h2 id="see-also">See Also<a class="headerlink" href="#see-also" title="Permanent link">&para;</a></h2>
<p><strong>Core Architecture:</strong></p>
<ul>
<li><a href="../security/">Security Model</a> - Token system security architecture and authorization model</li>
<li><a href="../observability/">Observability</a> - Metrics, health checks, and monitoring</li>
<li><a href="../development/">Development Guide</a> - Code structure and development workflow</li>
</ul>
<p><strong>Operational Guides:</strong></p>
<ul>
<li><a href="../operations/token-management/">Token Management</a> - Token lifecycle operations</li>
<li><a href="../operations/troubleshooting/">Troubleshooting</a> - Debugging common issues</li>
<li><a href="../how-to/ha-deployment/">High Availability Deployment</a> - Production deployment patterns</li>
</ul>
<p><strong>Quickstart:</strong></p>
<ul>
<li><a href="../quickstart/">Getting Started</a> - Deploy your first Keycloak realm</li>
<li><a href="../how-to/end-to-end-setup/">End-to-End Setup</a> - Complete production deployment</li>
</ul>
<p><strong>API Reference:</strong></p>
<ul>
<li><a href="../reference/keycloak-crd/">Keycloak CRD</a> - Keycloak instance configuration</li>
<li><a href="../reference/keycloak-realm-crd/">KeycloakRealm CRD</a> - Realm configuration</li>
<li><a href="../reference/keycloak-client-crd/">KeycloakClient CRD</a> - Client configuration</li>
</ul>
<p>Return to the <a href="../">index</a> or continue with the <a href="../development/">development guide</a>.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/vriesdemichael" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.sections", "navigation.expand", "search.highlight", "search.share", "content.code.copy", "content.action.edit"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>